<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>papera.me | Paperize your Images</title>
    <link rel="icon" type="image/png" href="./assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./assets/favicon.svg" />
    <link rel="shortcut icon" href="./assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Papera.me" />
    <link rel="manifest" href="./site.webmanifest" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ccapture.js-npmfixed/build/CCapture.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
            --bg-dark: #0f172a;
            --bg-panel: #243143;
            --bg-header: #283649;
            --border-color: #334155;
            --border-color-light: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-color: #3b82f6;
            --accent-color-hover: #2563eb;
            --danger-color: #ef4444;
            --danger-color-hover: #dc2626;
            --red-accent-bg: #fee2e2;
            --red-accent-text: #ef4444;
            --red-accent-border: #fca5a5;
        }
        body {
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            overflow: hidden;
            --panel-width: 25vw;
            --panel-handle-display: flex;
            --mobile-footer-display: none;
            --export-header-btn-display: flex;
            --panel-transform: translateX(100%);
        }
        .controls-panel::-webkit-scrollbar { width: 8px; }
        .controls-panel::-webkit-scrollbar-track { background: transparent; }
        .controls-panel::-webkit-scrollbar-thumb { background: var(--border-color-light); }
        .slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--border-color); outline: none; transition: background 0.3s; pointer-events: none; }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            cursor: pointer;
            border: 3px solid var(--accent-color);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
            border-radius: 0; /* Ubah dari 50% menjadi 0 untuk bentuk kotak */
            pointer-events: auto;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            cursor: pointer;
            border: 3px solid var(--accent-color);
            border-radius: 0; /* Bentuk kotak untuk Firefox */
        }
        .is-disabled, .controls-disabled-for-bg, .controls-disabled-for-overlay { opacity: 0.5; pointer-events: none; user-select: none; }
        .drag-over { border-color: var(--accent-color) !important; background-color: rgba(59, 130, 246, 0.1); }
        .number-input-uniform { width: 5rem; text-align: center; }
        .popup-overlay { position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.8); z-index: 1000; backdrop-filter: blur(5px); }
        #export-progress-popup h3 { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
        #export-progress-popup p { font-size: 1rem; color: var(--text-secondary); }
        #progress-bar-container { width: 50%; max-width: 500px; height: 12px; background-color: var(--border-color); margin-top: 1.5rem; overflow: hidden; border-radius: 0; }
        #progress-bar-fill { width: 0%; height: 100%; background-color: var(--accent-color); transition: width 0.1s linear; text-align: center; line-height: 12px; font-size: 0.75rem; font-weight: 600; color: var(--text-primary); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color-light); transition: .4s; border-radius: 0; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 0; }
        input:checked + .toggle-slider { background-color: var(--accent-color); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
        .accordion-section { border-radius: 0; }
        .accordion-open > .accordion-header .accordion-chevron { transform: rotate(180deg); color: var(--text-primary); }
        .accordion-open > .accordion-header { background-color: rgba(51, 65, 85, 0.3); }
        .reset-section-btn { background: none; border: none; color: var(--text-muted); padding: 0.25rem; margin-right: 0.5rem; transition: color 0.2s; }
        .reset-section-btn { 
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 0.375rem; 
            margin-right: 0.5rem;
            transition: color 0.2s, background-color 0.2s;
        }

        .reset-section-btn:hover {
            color: var(--text-primary);
            background-color: var(--border-color-light);
        }
        .btn-group-toggle button { border-radius: 0; }
        .btn-group-toggle button:hover { border-color: var(--accent-color); color: var(--text-primary); }
        .btn-group-toggle .active { border-color: var(--accent-color); color: var(--accent-color); background-color: rgba(59, 130, 246, 0.1); }
        #canvas-wrapper {
            aspect-ratio: 16 / 9;
            line-height: 0;
            background-color: var(--bg-header); 
            box-sizing: border-box;
            width: 100%;
        }
        #main-canvas { display: block; width: 100%; height: 100%; object-fit: contain; cursor: default; border-radius: 0; }
        .drop-zone-delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10; padding: 0.25rem; background-color: rgba(239, 68, 68, 0.8); color: white; transition: background-color 0.15s ease-in-out; line-height: 1; border-radius: 0; }
        .drop-zone-delete-btn svg { width: 1rem; height: 1rem; }
        .drop-zone-delete-btn:hover { background-color: rgba(220, 38, 38, 0.9); }
        #settings-panel-wrapper { transform: var(--panel-transform); width: var(--panel-width); max-width: var(--panel-width); border-radius: 0; }
        #settings-panel-wrapper.panel-open { transform: translateX(0); }
        .main-handle, .tab-handle { position: absolute; left: -48px; width: 48px; height: 63px; display: var(--panel-handle-display); align-items: center; justify-content: center; border: 1px solid var(--border-color); border-right: none; cursor: pointer; transition: background-color 0.3s, color 0.3s, transform 0.3s ease-in-out; background-color: var(--bg-header); color: var(--text-muted); border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .main-handle { top: 0; }
        #handle-object { top: 63px; }
        #handle-background { top: 126px; }
        #handle-animasi { top: 187px; }
        #handle-info { top: 250px; }        
        .tab-handle { opacity: 0; pointer-events: none; transition: opacity 0.3s 0.1s, transform 0.3s ease-in-out; }
        #settings-panel-wrapper.panel-open .tab-handle { opacity: 1; pointer-events: auto; transition-delay: 0.1s; }
        .main-handle:hover, .tab-handle:hover { color: #FFFFFF; background-color: var(--bg-header); }
        .tab-handle.active { background-color: var(--bg-panel); color: var(--text-primary); transform: translateX(2px); }
        .tab-handle.active:hover { background-color: var(--bg-panel); }
        #settings-panel-wrapper.panel-open #handle-icon-open { display: block; }
        #settings-panel-wrapper.panel-open #handle-icon-closed { display: none; }
        #settings-panel-wrapper:not(.panel-open) #handle-icon-open { display: none; }
        #settings-panel-wrapper:not(.panel-open) #handle-icon-closed { display: block; }
        #export-video-btn-header { display: var(--export-header-btn-display); border-radius: 0; }
        [data-ui-size="compact"] .controls-panel { --p: 0.6rem; }
        [data-ui-size="compact"] .p-4, [data-ui-size="compact"] .md\:p-4 { padding: 0.6rem; }
        [data-ui-size="compact"] .px-4 { padding-left: 0.6rem; padding-right: 0.6rem; }
        [data-ui-size="compact"] .py-2\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        [data-ui-size="compact"] .px-2\.5 { padding-left: 0.375rem; padding-right: 0.375rem; }
        [data-ui-size="compact"] .space-y-4 > *:not([hidden]) ~ *:not([hidden]), [data-ui-size="compact"] .md\:space-y-4 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 0.75rem; }
        [data-ui-size="compact"] .space-y-2 > *:not([hidden]) ~ *:not([hidden]), [data-ui-size="compact"] .md\:space-y-2 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 0.375rem; }
        [data-ui-size="compact"] .gap-2, [data-ui-size="compact"] .md\:gap-2 { gap: 0.25rem; }
        [data-ui-size="compact"] .gap-3, [data-ui-size="compact"] .md\:gap-3 { gap: 0.5rem; }
        [data-ui-size="compact"] .accordion-section .accordion-header { padding: 0.6rem; }
        [data-ui-size="compact"] .accordion-section .accordion-body { padding: 0.6rem; }
        [data-ui-size="compact"] #drop-zone, [data-ui-size="compact"] #background-drop-zone { height: 90px; }
        [data-ui-size="compact"] .drop-zone-delete-btn { top: 0.25rem; right: 0.25rem; padding: 0.125rem; }
        [data-ui-size="compact"] #export-settings-popup > div, [data-ui-size="compact"] #confirmation-popup > div { padding: 1.5rem; }
        [data-ui-size="compact"] #export-progress-popup h3 { font-size: 1.25rem; margin-bottom: 0.75rem; }
        [data-ui-size="compact"] #export-progress-popup p { font-size: 0.875rem; }
        [data-ui-size="compact"] #progress-bar-container { margin-top: 1rem; }
        [data-ui-size="compact"] #panel-title { font-size: 1rem; }
        [data-ui-size="compact"] #export-video-btn-header { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
        [data-ui-size="compact"] #mobile-export-btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
        [data-ui-size="compact"] .text-lg, [data-ui-size="compact"] .md\:text-lg { font-size: 1rem; }
        [data-ui-size="compact"] .text-base { font-size: 0.875rem; }
        [data-ui-size="compact"] .text-sm, [data-ui-size="compact"] .md\:text-sm { font-size: 0.8rem; }
        [data-ui-size="compact"] .text-xs { font-size: 0.75rem; }
        [data-ui-size="compact"] .w-6, [data-ui-size="compact"] .h-6 { width: 1.25rem; height: 1.25rem; }
        [data-ui-size="compact"] .w-7, [data-ui-size="compact"] .h-7 { width: 1.5rem; height: 1.5rem; }
        [data-ui-size="compact"] #settings-panel .desktop-header { height: 3rem; }
        [data-ui-size="compact"] #mobile-panel-header { height: 2.5rem; font-size: 0.8rem; }
        [data-ui-size="compact"] #mobile-footer { height: 3.5rem; }
        [data-ui-size="compact"] #reset-settings-btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
        [data-ui-size="compact"] .controls-panel { padding-bottom: 5rem; }
        [data-ui-size="normal"] #settings-panel .desktop-header { height: 4rem; }
        [data-ui-size="normal"] #mobile-panel-header { height: 3rem; font-size: 0.9rem; }
        [data-ui-size="normal"] #mobile-footer { height: 4rem; }
        [data-ui-size="normal"] #reset-settings-btn { padding: 0.75rem 1.25rem; }
        [data-ui-size="normal"] .controls-panel { padding-bottom: 6rem; }
        [data-ui-size="luas"] .p-4, [data-ui-size="luas"] .md\:p-4 { padding: 1.5rem; }
        [data-ui-size="luas"] .px-4 { padding-left: 1.5rem; padding-right: 1.5rem; }
        [data-ui-size="luas"] .py-2\.5 { padding-top: 1rem; padding-bottom: 1rem; }
        [data-ui-size="luas"] .px-2\.5 { padding-left: 1rem; padding-right: 1rem; }
        [data-ui-size="luas"] .space-y-4 > *:not([hidden]) ~ *:not([hidden]), [data-ui-size="luas"] .md\:space-y-4 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 1.5rem; }
        [data-ui-size="luas"] .space-y-2 > *:not([hidden]) ~ *:not([hidden]), [data-ui-size="luas"] .md\:space-y-2 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 0.75rem; }
        [data-ui-size="luas"] .gap-2, [data-ui-size="luas"] .md\:gap-2 { gap: 0.75rem; }
        [data-ui-size="luas"] .gap-3, [data-ui-size="luas"] .md\:gap-3 { gap: 1rem; }
        [data-ui-size="luas"] .accordion-section .accordion-header { padding: 1.5rem; }
        [data-ui-size="luas"] .accordion-section .accordion-body { padding: 1.5rem; }
        [data-ui-size="luas"] #drop-zone, [data-ui-size="luas"] #background-drop-zone { height: 160px; }
        [data-ui-size="luas"] .overlay-drop-zone { height: 120px; }
        [data-ui-size="luas"] .drop-zone-delete-btn { top: 0.75rem; right: 0.75rem; padding: 0.5rem; }
        [data-ui-size="luas"] #export-settings-popup > div, [data-ui-size="luas"] #confirmation-popup > div { padding: 2.5rem; }
        [data-ui-size="luas"] #export-progress-popup h3 { font-size: 2rem; margin-bottom: 1.25rem; }
        [data-ui-size="luas"] #export-progress-popup p { font-size: 1.125rem; }
        [data-ui-size="luas"] #progress-bar-container { margin-top: 2rem; }
        [data-ui-size="luas"] #panel-title { font-size: 1.25rem; }
        [data-ui-size="luas"] #export-video-btn-header { padding: 0.75rem 1.25rem; font-size: 1rem; }
        [data-ui-size="luas"] #mobile-export-btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
        [data-ui-size="luas"] .text-lg, [data-ui-size="luas"] .md\:text-lg { font-size: 1.25rem; }
        [data-ui-size="luas"] .text-base { font-size: 1.125rem; }
        [data-ui-size="luas"] .text-sm, [data-ui-size="luas"] .md\:text-sm { font-size: 1rem; }
        [data-ui-size="luas"] .text-xs { font-size: 0.875rem; }
        [data-ui-size="luas"] .w-6, [data-ui-size="luas"] .h-6 { width: 1.75rem; height: 1.75rem; }
        [data-ui-size="luas"] .w-7, [data-ui-size="luas"] .h-7 { width: 2rem; height: 2rem; }
        [data-ui-size="luas"] #settings-panel .desktop-header { height: 5rem; }
        [data-ui-size="luas"] #mobile-panel-header { height: 3.5rem; font-size: 1.1rem; }
        [data-ui-size="luas"] #mobile-footer { height: 5rem; }
        [data-ui-size="luas"] #reset-settings-btn { padding: 1rem 1.5rem; font-size: 1rem; }
        [data-ui-size="luas"] .controls-panel { padding-bottom: 7rem; }
        @media (min-width: 769px) {
            [data-ui-size="compact"] #drop-zone,
            [data-ui-size="compact"] #background-drop-zone {
                height: 120px;
            }
        }        
        #mobile-footer .mobile-tab-btn {
            border: 2px solid transparent;
            border-radius: 0;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }
        #mobile-footer .mobile-tab-btn.active {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        #mobile-panel-header {
            display: none;
            align-items: center;
            justify-content: center;
            width: 100%;
            background-color: var(--bg-header);
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            cursor: ns-resize;
        }

        @media (max-width: 480px) {
            #export-settings-popup .info-tooltip {
                /* Tetap muncul di atas ikon */
                bottom: 100%;
                top: auto;
                margin-bottom: 0.5rem;
                
                /* Atur lebar agar cukup dan tidak melebihi layar */
                width: 280px; /* Beri lebar yang cukup */
                max-width: 75vw; /* Batasi agar tidak keluar dari layar */

                /* BARU: Posisikan rata kiri dari ikon, bukan di tengahnya */
                left: 0;
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {          
            body:not(.force-desktop) {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
                --panel-handle-display: none;
                --mobile-footer-display: flex;
                --export-header-btn-display: none;
                --panel-transform: none;
            }
            body:not(.force-desktop) #canvas-container {
                flex-basis: 50%;
                width: 100%;
                flex-shrink: 0;
                padding: 0.5rem;
                box-sizing: border-box;
                overflow: hidden;
                border-bottom: 1px solid var(--border-color);
            }
            body:not(.force-desktop) #main-canvas {
                max-width: 100%;
                max-height: 100%;
            }
            body:not(.force-desktop) #settings-panel-wrapper {
                position: relative;
                flex-basis: 50%;
                width: 100vw;
                max-width: 100vw;
                transform: none !important;
                transition: none;
                border-top: none;
                inset: auto;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            body:not(.force-desktop) #settings-panel {
                height: 100%;
                border-left: none;
                border-bottom: none;
                display: flex;
                flex-direction: column;
            }
            body:not(.force-desktop) #settings-panel .desktop-header {
                display: none;
            }
            body:not(.force-desktop) #mobile-panel-header {
                display: flex;
            }
            body:not(.force-desktop) .controls-panel {
                flex-grow: 1;
                overflow-y: auto;
            }
            body:not(.force-desktop) #mobile-footer {
                display: var(--mobile-footer-display);
            }
            .desktop-only {
                display: none;
            }
            .number-input-uniform {
                width: 4rem;      
                flex-shrink: 0; 
            }
                   
        }
        body.force-mobile {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            --panel-handle-display: none;
            --mobile-footer-display: flex;
            --export-header-btn-display: none;
            --panel-transform: none;
        }
        body.force-mobile #canvas-container {
            flex-basis: 50%; width: 100%; flex-shrink: 0; padding: 0.5rem; box-sizing: border-box; overflow:hidden; border-bottom: 1px solid var(--border-color);
        }
        body.force-mobile #main-canvas { max-width: 100%; max-height: 100%; }
        body.force-mobile #settings-panel-wrapper {
            position: relative; flex-basis: 50%; width: 100vw; max-width: 100vw; transform: none !important; transition: none; border-top: none; inset: auto; overflow: hidden; display: flex; flex-direction: column;
        }
        body.force-mobile #settings-panel-wrapper.panel-open { transform: none !important; }
        body.force-mobile #settings-panel { height: 100%; border-left: none; border-bottom: none; display: flex; flex-direction: column;}
        body.force-mobile #settings-panel .desktop-header { display: none; }
        body.force-mobile #mobile-panel-header {
            display: flex;
        }
        body.force-mobile .controls-panel {
            flex-grow: 1;
            overflow-y: auto;
        }
        body.force-mobile #mobile-footer { display: var(--mobile-footer-display); }
        body.force-desktop {
            --panel-width: 24rem;
            --panel-handle-display: flex;
            --mobile-footer-display: none;
            --export-header-btn-display: flex;
            --panel-transform: translateX(100%);
        }
        body.force-desktop #settings-panel-wrapper {
            inset: 0 0 0 auto;
            height: 100%;
            max-width: 24rem;
            border-radius: 0;
        }
        body.force-desktop #settings-panel {
            border-left: 1px solid var(--border-color);
            border-top: none;
            border-bottom: 1px solid var(--border-color);
        }
        body.force-desktop #settings-panel-wrapper.panel-open {
            transform: translateX(0);
        }
        #top-notification-popup { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); width: calc(100% - 2rem); max-width: 500px; background-color: var(--red-accent-bg); color: var(--red-accent-text); border: 1px solid var(--red-accent-border); padding: 1rem 1.5rem; border-radius: 0; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; z-index: 1001; }
        #top-notification-popup.show { opacity: 1; visibility: visible; }
        #top-notification-popup .close-btn { background: none; border: none; color: var(--red-accent-text); font-size: 1.25rem; line-height: 1; cursor: pointer; padding: 0.25rem; margin-left: 1rem; border-radius: 0; }
        #top-notification-popup .close-btn:hover { background-color: rgba(239, 68, 68, 0.1); }
        .info-tooltip-trigger .info-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s;
            pointer-events: none; /* Kembali ke none secara default */
        }

        /* Kelas baru untuk menampilkan tooltip via JavaScript */
        .info-tooltip.tooltip-visible {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }
        .rounded-md, .rounded-lg, .rounded-full { border-radius: 0; }

        /* Keyframes untuk Animasi Gerak (Move) */
        @keyframes move-from-left {
            from { transform: translateX(-100%); } to { transform: translateX(0); }
        }
        @keyframes move-to-left {
            from { transform: translateX(0); } to { transform: translateX(-100%); }
        }
        @keyframes move-from-right {
            from { transform: translateX(100%); } to { transform: translateX(0); }
        }
        @keyframes move-to-right {
            from { transform: translateX(0); } to { transform: translateX(100%); }
        }
        @keyframes move-from-top {
            from { transform: translateY(-100%); } to { transform: translateY(0); }
        }
        @keyframes move-to-top {
            from { transform: translateY(0); } to { transform: translateY(-100%); }
        }
        @keyframes move-from-bottom {
            from { transform: translateY(100%); } to { transform: translateY(0); }
        }
        @keyframes move-to-bottom {
            from { transform: translateY(0); } to { transform: translateY(100%); }
        }

        /* Keyframes untuk Animasi Zoom */
        @keyframes zoom-in {
            from { transform: scale(var(--anim-scale-start, 0)); } to { transform: scale(1); }
        }
        @keyframes zoom-out {
            from { transform: scale(1); } to { transform: scale(var(--anim-scale-end, 0)); }
        }

        #filename-container input:focus {
            outline: none;
            box-shadow: none;
        }

        .timeline-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            height: 20px;
        }

        #timeline-slider {
            /* Slider adalah lapisan interaktif kita. Posisikan di bawah marker. */
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            z-index: 1; 
        }

        #keyframe-markers-container {
            /* Kontainer untuk marker sekarang berada di lapisan atas */
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 2;
            /* Penting: Agar kita tetap bisa mengklik slider di bawahnya */
            pointer-events: none;
        }

        .keyframe-marker {
            position: absolute;
            top: 50%;
            width: 22px;
            height: 22px;
            background: transparent;
            border: 1.5px solid var(--accent-color);
            border-radius: 0; /* Ubah dari 50% menjadi 0 untuk bentuk kotak */           
            left: calc(10px + (var(--kf-pos) * (100% - 20px)));
            transform: translate(-50%, -50%);
        }
        /* Kontainer untuk bar durasi simple mode */
        #simple-anim-markers-container {
            /* Posisikan agar sejajar dengan garis slider */
            left: 10px;
            right: 10px;
            top: 0;
            bottom: 0;
            z-index: 1; /* Lapisan paling bawah, di atas garis, di bawah semua marker/thumb */
            pointer-events: none;
        }

        .simple-anim-marker {
            /* Gaya ini meniru .keyframe-marker */
            position: absolute;
            top: 50%;
            height: 22px; /* Samakan tinggi dengan keyframe-marker */
            background: transparent;
            border: 1.5px solid var(--accent-color);
            border-radius: 0;
            transform: translateY(-50%);
            box-sizing: border-box;
        }

        #timeline-slider {
            z-index: 1; /* Thumb slider di paling atas */
        }

        /* Easing Functions */
        .anim-linear { animation-timing-function: linear; }
        .anim-ease-in { animation-timing-function: ease-in; }
        .anim-ease-out { animation-timing-function: ease-out; }
        .anim-back-in { animation-timing-function: cubic-bezier(0.36, 0, 0.66, -0.56); }
        .anim-back-out { animation-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1); }

        #canvas-container {
            /* Transisi agar perubahan lebar terlihat mulus */
            transition: width 0.3s ease-out;
        }
        body.desktop-panel-open:not(.force-mobile) #canvas-container {
            width: calc(100vw - var(--panel-width));
        }

        .desktop-only {
            display: none;
        }
        @media (min-width: 769px) {
            .desktop-only {
                display: inline;
            }
        }
        #debug-screen {
            position: fixed;
            top: 0.5rem;
            left: 0.5rem;
            background-color: rgba(15, 23, 42, 0.85);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            font-family: monospace;
            font-size: 8px;
            line-height: 1.2;
            z-index: 9999;
            pointer-events: none;
            white-space: pre;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #debug-screen:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        #processing-notification {
            position: fixed;
            top: 0.5rem;
            left: 0.5rem;
            background-color: rgba(15, 23, 42, 0.85);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
            z-index: 9998;
            pointer-events: none;
            white-space: pre;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
    </style>
</head>
<body class="bg-slate-900 relative">
    <!-- SVG filter definition for the torn edge effect -->
    <svg width="0" height="0" style="position:absolute; z-index: -1;">
        <defs>
            <filter id="combined-filter" x="-50%" y="-50%" width="200%" height="200%">
                <!-- Dilate the source image to create the stroke thickness -->
                <feMorphology id="torn-dilate" in="SourceGraphic" operator="dilate" radius="10" result="dilatedShape"/>
                <!-- Generate fractal noise -->
                <feTurbulence id="torn-turbulence" type="fractalNoise" baseFrequency="0.02" numOctaves="3" result="tornNoise"/>
                <!-- Use the noise to displace the edges of the dilated shape -->
                <feDisplacementMap id="torn-displacement" in="dilatedShape" in2="tornNoise" scale="15" xChannelSelector="R" yChannelSelector="G" result="tornEdgeShape"/>
                <!-- Create a solid color for the stroke -->
                <feFlood id="torn-flood" flood-color="#FFFFFF" result="strokeColor"/>
                <!-- Combine the color with the torn edge shape -->
                <feComposite in="strokeColor" in2="tornEdgeShape" operator="in" result="coloredTornEdge"/>
                <!-- Merge the torn edge stroke with the original image -->
                <feMerge>
                    <feMergeNode in="coloredTornEdge"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
    </svg>

    <!-- Main container for the canvas -->
    <main id="canvas-container" class="w-screen h-screen flex items-center justify-center p-10">
        <div id="canvas-wrapper" class="shadow-lg border-4 border-[var(--border-color)]">
            <canvas id="main-canvas"></canvas>
        </div>        
    </main>

    <!-- Settings panel wrapper -->
    <div id="settings-panel-wrapper" class="absolute inset-y-0 right-0 h-full w-full transition-transform duration-300 ease-in-out z-40">
        <!-- Handle to open/close the settings panel on desktop -->
        <button id="panel-handle" class="main-handle">
            <svg id="handle-icon-closed" class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L21.5 6.5V17.5L12 23L2.5 17.5V6.5L12 1ZM12 3.311L4.5 7.65311V16.3469L12 20.689L19.5 16.3469V7.65311L12 3.311ZM12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12C16 14.2091 14.2091 16 12 16ZM12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z"></path></svg>
            <svg id="handle-icon-open" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5859 12L2.79297 4.20706L4.20718 2.79285L12.0001 10.5857L19.793 2.79285L21.2072 4.20706L13.4143 12L21.2072 19.7928L19.793 21.2071L12.0001 13.4142L4.20718 21.2071L2.79297 19.7928L10.5859 12Z"></path></svg>
        </button>
        <!-- Tab handles for desktop -->
        <button id="handle-object" class="tab-handle active">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 3C6.44772 3 6 3.44772 6 4V7H3C2.44772 7 2 7.44772 2 8V20C2 20.5523 2.44772 21 3 21H17C17.5523 21 18 20.5523 18 20V17H21C21.5523 17 22 16.5523 22 16V4C22 3.44772 21.5523 3 21 3H7ZM17 7H8V5H20V15H18V8C18 7.44772 17.5523 7 17 7ZM16 9V15.7394L11.4911 11.6404L4 18.6321V9H16ZM11.5089 14.3596L16 18.4424V19H6.53702L11.5089 14.3596ZM7 13.5C7.82843 13.5 8.5 12.8284 8.5 12C8.5 11.1716 7.82843 10.5 7 10.5C6.17157 10.5 5.5 11.1716 5.5 12C5.5 12.8284 6.17157 13.5 7 13.5Z"></path></svg>
        </button>
        <button id="handle-background" class="tab-handle">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3C21.5523 3 22 3.44772 22 4V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V4C2 3.44772 2.44772 3 3 3H21ZM20 5H4V19H20V5ZM13 17V15H16V12H18V17H13ZM11 7V9H8V12H6V7H11Z"></path></svg>
        </button>
        <button id="handle-animasi" class="tab-handle">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2 3.9934C2 3.44476 2.45531 3 2.9918 3H21.0082C21.556 3 22 3.44495 22 3.9934V20.0066C22 20.5552 21.5447 21 21.0082 21H2.9918C2.44405 21 2 20.5551 2 20.0066V3.9934ZM4 5V19H20V5H4ZM10.6219 8.41459L15.5008 11.6672C15.6846 11.7897 15.7343 12.0381 15.6117 12.2219C15.5824 12.2658 15.5447 12.3035 15.5008 12.3328L10.6219 15.5854C10.4381 15.708 10.1897 15.6583 10.0672 15.4745C10.0234 15.4088 10 15.3316 10 15.2526V8.74741C10 8.52649 10.1791 8.34741 10.4 8.34741C10.479 8.34741 10.5562 8.37078 10.6219 8.41459Z"></path></svg>
        </button>
        <button id="handle-info" class="tab-handle">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14V16C8.68629 16 6 18.6863 6 22H4C4 17.5817 7.58172 14 12 14ZM12 13C8.685 13 6 10.315 6 7C6 3.685 8.685 1 12 1C15.315 1 18 3.685 18 7C18 10.315 15.315 13 12 13ZM12 11C14.21 11 16 9.21 16 7C16 4.79 14.21 3 12 3C9.79 3 8 4.79 8 7C8 9.21 9.79 11 12 11ZM14.5946 18.8115C14.5327 18.5511 14.5 18.2794 14.5 18C14.5 17.7207 14.5327 17.449 14.5945 17.1886L13.6029 16.6161L14.6029 14.884L15.5952 15.4569C15.9883 15.0851 16.4676 14.8034 17 14.6449V13.5H19V14.6449C19.5324 14.8034 20.0116 15.0851 20.4047 15.4569L21.3971 14.8839L22.3972 16.616L21.4055 17.1885C21.4673 17.449 21.5 17.7207 21.5 18C21.5 18.2793 21.4673 18.551 21.4055 18.8114L22.3972 19.3839L21.3972 21.116L20.4048 20.543C20.0117 20.9149 19.5325 21.1966 19.0001 21.355V22.5H17.0001V21.3551C16.4677 21.1967 15.9884 20.915 15.5953 20.5431L14.603 21.1161L13.6029 19.384L14.5946 18.8115ZM18 19.5C18.8284 19.5 19.5 18.8284 19.5 18C19.5 17.1716 18.8284 16.5 18 16.5C17.1716 16.5 16.5 17.1716 16.5 18C16.5 18.8284 17.1716 19.5 18 19.5Z"></path></svg>
        </button>

        <!-- The actual settings panel -->
        <aside id="settings-panel" class="w-full h-full bg-[var(--bg-panel)] flex flex-col flex-shrink-0 border-l border-t border-b border-[var(--border-color)]">
            <!-- Desktop header for the panel -->
            <div class="desktop-header sticky top-0 bg-[var(--bg-header)] z-10 flex items-center justify-between p-4 border-b border-[var(--border-color)]">
                <h2 id="panel-title" class="text-lg font-bold text-slate-100" data-translate-key="settings"></h2>
                <button id="export-video-btn-header" class="flex items-center justify-center w-auto px-4 py-2 bg-[var(--accent-color)] text-white text-sm font-semibold hover:bg-[var(--accent-color-hover)] transition-all duration-150 cursor-pointer" data-translate-key="export"></button>
            </div>
            <!-- Mobile header for the panel (draggable) -->
            <div id="mobile-panel-header"></div>
            
            <!-- Scrollable container for all controls -->
            <div class="overflow-y-auto controls-panel flex-grow p-4 md:p-4">
                <!-- Background Tab Content -->
                <div id="background-tab-content" class="tab-content space-y-4 md:space-y-4">
                    <h2 class="text-lg font-bold text-slate-300" data-translate-key="canvas"></h2>
                    <!-- Aspect Ratio Controls -->
                    <div id="aspect-ratio-controls">
                        <label class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="previewAspectRatio"></label>
                        <div id="aspect-ratio-btns" class="grid grid-cols-5 gap-2 md:gap-2 mt-2 btn-group-toggle">
                            <button data-ratio="9/16" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-xs font-medium transition-all duration-150">9:16</button>
                            <button data-ratio="16/9" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-xs font-medium transition-all duration-150 active">16:9</button>
                            <button data-ratio="4/3" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-xs font-medium transition-all duration-150">4:3</button>
                            <button data-ratio="3/4" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-xs font-medium transition-all duration-150">3:4</button>
                            <button data-ratio="1/1" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-xs font-medium transition-all duration-150">1:1</button>
                        </div>
                    </div>
                    <!-- Solid Background Color -->
                    <div id="background-color-control" class="mt-4 pt-4 border-t border-[var(--border-color)]">
                        <label for="background-color" class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="solidBackgroundColor"></label>
                        <input type="color" id="background-color" value="#00ff00" class="w-full h-10 mt-2 p-1 bg-slate-900 border border-[var(--border-color)] cursor-pointer">
                    </div>
                    <!-- Background Image Upload -->
                    <div class="space-y-2 md:space-y-2 mt-4 pt-4 border-t border-[var(--border-color)]">
                        <h2 class="text-lg font-bold text-slate-300" data-translate-key="backgroundImage"></h2>
                        <label for="background-image-upload" id="background-drop-zone" class="group relative flex flex-col items-center justify-center w-full h-32 md:h-32 px-4 md:px-4 py-2 md:py-2 border-2 border-dashed border-[var(--border-color)] cursor-pointer transition-colors">
                            <div id="background-drop-zone-prompt" class="flex flex-col items-center justify-center pointer-events-none w-full h-full">
                                <svg class="w-8 h-8 text-[var(--text-muted)] group-hover:text-[var(--accent-color)] transition-colors flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 15V18H24V20H21V23H19V20H16V18H19V15H21ZM21.0082 3C21.556 3 22 3.44495 22 3.9934V13H20V5H4V18.999L14 9L17 12V14.829L14 11.8284L6.827 19H14V21H2.9918C2.44405 21 2 20.5551 2 20.0066V3.9934C2 3.44476 2.45531 3 2.9918 3H21.0082ZM8 7C9.10457 7 10 7.89543 10 9C10 10.1046 9.10457 11 8 11C6.89543 11 6 10.1046 6 9C6 7.89543 6.89543 7 8 7Z"></path></svg>
                                <p class="text-sm text-[var(--text-muted)] group-hover:text-[var(--accent-color)] transition-colors text-center mt-2 leading-tight" data-translate-key="dropImagePrompt"></p>
                            </div>
                            <div id="background-drop-zone-filename" class="hidden text-center pointer-events-none p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 mx-auto mb-2 text-green-500"><path d="M5 11.1005L7 9.1005L12.5 14.6005L16 11.1005L19 14.1005V5H5V11.1005ZM5 13.9289V19H8.1005L11.0858 16.0147L7 11.9289L5 13.9289ZM10.9289 19H19V16.9289L16 13.9289L10.9289 19ZM4 3H20C20.5523 3 21 3.44772 21 4V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V4C3 3.44772 3.44772 3 4 3ZM15.5 10C14.6716 10 14 9.32843 14 8.5C14 7.67157 14.6716 7 15.5 7C16.3284 7 17 7.67157 17 8.5C17 9.32843 16.3284 10 15.5 10Z"></path></svg>
                                <p class="text-sm font-semibold text-slate-300 break-all"></p>
                            </div>
                            <button id="remove-background-image" class="drop-zone-delete-btn hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"></path></svg>
                            </button>
                        </label>
                        <input type="file" id="background-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp">
                    </div>
                    <!-- Background Transform Accordion -->
                    <div class="accordion-section border border-[var(--border-color)]" id="background-transform-accordion">
                        <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                            <div class="flex items-center gap-3 md:gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                <h2 class="text-base font-semibold text-slate-300" data-translate-key="backgroundTransform"></h2>
                            </div>
                                <button class="reset-section-btn" data-section-key="background.transform" data-translate-key-title="resetBackgroundTransformTitle">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                </button>
                        </div>
                        <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)] hidden">
                            <div id="background-mode-controls">
                                <label class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="backgroundMode"></label>
                                <div id="background-mode-btns" class="grid grid-cols-2 gap-2 md:gap-2 mt-2 btn-group-toggle">
                                    <button data-mode="fill" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="fill"></button>
                                    <button data-mode="stretch" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="stretch"></button>
                                </div>
                            </div>
                            <div id="background-size-control">
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="backgroundSize"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-size" min="10" max="200" value="100" class="w-full slider"><input type="number" id="background-size-input" min="10" max="200" value="100" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></div>
                            </div>
                            <div id="background-offset-x-control">
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="offsetX"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-offset-x" min="-150" max="150" value="0" class="w-full slider"><input type="number" id="background-offset-x-input" min="-150" max="150" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></div>
                            </div>
                            <div id="background-offset-y-control">
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="offsetY"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-offset-y" min="-150" max="150" value="0" class="w-full slider"><input type="number" id="background-offset-y-input" min="-150" max="150" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></div>
                            </div>
                            <div id="background-rotation-control">
                                <label id="background-rotation-label" class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="rotation">Rotasi</label>
                                <div class="flex items-center gap-3 md:gap-3">
                                    <input type="range" id="background-rotation" min="-180" max="180" value="0" step="1" class="w-full slider">
                                    <input type="number" id="background-rotation-input" value="0" step="1" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                                </div>
                            </div>                            
                        </div>
                    </div>
                    <!-- Background Blur Accordion -->
                    <div class="accordion-section border border-[var(--border-color)]" id="background-blur-accordion">
                        <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                            <div class="flex items-center gap-3 md:gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                <h2 class="text-base font-semibold text-slate-300" data-translate-key="backgroundBlur"></h2>
                            </div>
                            <div class="flex items-center">
                                <button class="reset-section-btn" data-section-key="background.effects.blur" data-translate-key-title="resetBackgroundBlurTitle">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                </button>
                                <label class="switch"><input type="checkbox" id="background-blur-enabled-switch"><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                        <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)] hidden">
                            <div>
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="intensity"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-blur-intensity" min="0" max="20" value="10" step="0.1" class="w-full slider"><input type="number" id="background-blur-intensity-input" min="0" max="20" value="10" step="0.1" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Background Vignette Accordion -->
                    <div class="accordion-section border border-[var(--border-color)]" id="background-vignette-accordion">
                        <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                            <div class="flex items-center gap-3 md:gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                <h2 class="text-base font-semibold text-slate-300" data-translate-key="backgroundVignette"></h2>
                            </div>
                            <div class="flex items-center">
                                <button class="reset-section-btn" data-section-key="background.effects.vignette" data-translate-key-title="resetBackgroundVignetteTitle">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                </button>
                                <label class="switch"><input type="checkbox" id="background-vignette-enabled-switch"><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                        <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)] hidden">
                            <div>
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="opacity"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-vignette-opacity" min="0" max="100" value="100" class="w-full slider"><input type="number" id="background-vignette-opacity-input" min="0" max="100" value="100" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="radius"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-vignette-radius" min="0" max="100" value="0" class="w-full slider"><input type="number" id="background-vignette-radius-input" min="0" max="100" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="feather"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-vignette-feather" min="0" max="100" value="100" class="w-full slider"><input type="number" id="background-vignette-feather-input" min="0" max="100" value="100" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                            </div>
                            <div>
                                <label for="background-vignette-color" class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="vignetteColor"></label>
                                <input type="color" id="background-vignette-color" value="#000000" class="w-full h-10 mt-2 p-1 bg-slate-900 border border-[var(--border-color)] cursor-pointer">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Background Color Correction Accordion -->
                    <div class="accordion-section border border-[var(--border-color)]" id="background-color-correction-accordion">
                        <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                            <div class="flex items-center gap-3 md:gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                <h2 class="text-base font-semibold text-slate-300" data-translate-key="backgroundColorCorrection"></h2>
                            </div>
                            <div class="flex items-center">
                                <button class="reset-section-btn" data-section-key="background.effects.colorCorrection" data-translate-key-title="resetBackgroundColorCorrectionTitle">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                </button>
                                <label class="switch"><input type="checkbox" id="background-color-correction-enabled-switch"><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                        <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)] hidden">
                            <div>
                                <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="hue"></label>
                                <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-color-hue" min="-180" max="180" value="0" class="w-full slider"><input type="number" id="background-color-hue-input" min="-180" max="180" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                            </div>
                            <div id="background-color-correction-standard-controls" class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="saturation"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-color-saturation" min="-100" max="100" value="0" class="w-full slider"><input type="number" id="background-color-saturation-input" min="-100" max="100" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="brightness"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="background-color-brightness" min="-100" max="100" value="0" class="w-full slider"><input type="number" id="background-color-brightness-input" min="-100" max="100" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 pt-2 border-t border-slate-700">
                                <input type="checkbox" id="background-colorize-switch" class="h-4 w-4 bg-slate-600 border-slate-500 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                                <label for="background-colorize-switch" class="text-sm text-slate-300" data-translate-key="colorize"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Object Tab Content -->
                <div id="object-tab-content" class="tab-content space-y-4 md:space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-slate-300" data-translate-key="objectImage"></h2>
                    </div>
                    
                    <!-- Object Image Upload -->
                    <label for="image-upload" id="drop-zone" class="group relative flex flex-col items-center justify-center w-full h-32 md:h-32 px-4 md:px-4 py-2 md:py-2 border-2 border-dashed border-[var(--border-color)] cursor-pointer transition-colors">
                        <div id="drop-zone-prompt" class="flex flex-col items-center justify-center pointer-events-none w-full h-full">
                           <svg class="w-8 h-8 text-[var(--text-muted)] group-hover:text-[var(--accent-color)] transition-colors flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 15V18H24V20H21V23H19V20H16V18H19V15H21ZM21.0082 3C21.556 3 22 3.44495 22 3.9934V13H20V5H4V18.999L14 9L17 12V14.829L14 11.8284L6.827 19H14V21H2.9918C2.44405 21 2 20.5551 2 20.0066V3.9934C2 3.44476 2.45531 3 2.9918 3H21.0082ZM8 7C9.10457 7 10 7.89543 10 9C10 10.1046 9.10457 11 8 11C6.89543 11 6 10.1046 6 9C6 7.89543 6.89543 7 8 7Z"></path></svg>
                           <p class="text-sm text-[var(--text-muted)] group-hover:text-[var(--accent-color)] transition-colors text-center mt-2 leading-tight" data-translate-key="dropImagePrompt"></p>
                        </div>
                        <div id="drop-zone-filename" class="hidden text-center pointer-events-none p-2">
                           <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto mb-2 text-green-500"><path d="M7 3C6.44772 3 6 3.44772 6 4V7H3C2.44772 7 2 7.44772 2 8V20C2 20.5523 2.44772 21 3 21H17C17.5523 21 18 20.5523 18 20V17H21C21.5523 17 22 16.5523 22 16V4C22 3.44772 21.5523 3 21 3H7ZM17 7H8V5H20V15H18V8C18 7.44772 17.5523 7 17 7ZM16 9V15.7394L11.4911 11.6404L4 18.6321V9H16ZM11.5089 14.3596L16 18.4424V19H6.53702L11.5089 14.3596ZM7 13.5C7.82843 13.5 8.5 12.8284 8.5 12C8.5 11.1716 7.82843 10.5 7 10.5C6.17157 10.5 5.5 11.1716 5.5 12C5.5 12.8284 6.17157 13.5 7 13.5Z"></path></svg>
                           <p class="text-sm font-semibold text-slate-300 break-all"></p>
                        </div>
                        <button id="delete-image-btn" class="drop-zone-delete-btn hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"></path></svg>
                        </button>
                    </label>
                    <input type="file" id="image-upload" class="hidden" accept="image/png, image/jpeg, image/webp">
                    <!-- Controls that are only enabled when an object image is loaded -->
                    <div id="image-specific-controls" class="is-disabled space-y-4 md:space-y-4">
                        <!-- Transform Accordion -->
                        <div class="accordion-section border border-[var(--border-color)]" id="foreground-transform-accordion">
                            <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                                <div class="flex items-center gap-3 md:gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                    <h2 class="text-base font-semibold text-slate-300" data-translate-key="transform"></h2>
                                </div>
                                <button class="reset-section-btn" data-section-key="image" data-translate-key-title="resetTransformTitle">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                </button>
                            </div>
                            <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)]">
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="imageSize"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="image-size" min="10" max="200" value="80" class="w-full slider"><input type="number" id="image-size-input" min="10" max="200" value="80" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="offsetX"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="image-offset-x" min="-150" max="150" value="0" class="w-full slider"><input type="number" id="image-offset-x-input" min="-150" max="150" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></div>
                                </div>
                                 <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="offsetY"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="image-offset-y" min="-150" max="150" value="0" class="w-full slider"><input type="number" id="image-offset-y-input" min="-150" max="150" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></div>
                                </div>
                                <div>
                                    <label id="image-rotation-label" class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="rotation">Rotasi</label>
                                    <div class="flex items-center gap-3 md:gap-3">
                                        <input type="range" id="image-rotation" min="-180" max="180" value="0" step="1" class="w-full slider">
                                        <input type="number" id="image-rotation-input" value="0" step="1" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                                    </div>
                                </div>                                
                            </div>
                        </div>
                        <!-- Torn Edges (Stroke) Accordion -->
                        <div class="accordion-section border border-[var(--border-color)]" id="foreground-stroke-accordion">
                            <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                                <div class="flex items-center gap-3 md:gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                    <h2 class="text-base font-semibold text-slate-300" data-translate-key="tornEdges"></h2>
                                </div>
                                <div class="flex items-center">
                                    <button class="reset-section-btn" data-section-key="stroke" data-translate-key-title="resetTornEdgesTitle">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                    </button>
                                    <label class="switch"><input type="checkbox" id="stroke-enabled-switch" checked><span class="toggle-slider"></span></label>
                                </div>
                            </div>
                            <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)]">
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="thickness"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="stroke-width" min="0" max="100" value="10" class="w-full slider"><input type="number" id="stroke-width-input" min="0" max="50" value="10" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="roughness"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="stroke-roughness" min="0" max="100" value="25" class="w-full slider"><input type="number" id="stroke-roughness-input" min="0" max="100" value="25" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="detail"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="stroke-detail" min="1" max="100" step="1" value="20" class="w-full slider"><input type="number" id="stroke-detail-input" min="1" max="100" step="1" value="20" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Paper Texture Accordion -->
                        <div class="accordion-section border border-[var(--border-color)]" id="paper-fold-overlay-accordion">
                            <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                                <div class="flex items-center gap-3 md:gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                    <h2 class="text-base font-semibold text-slate-300" data-translate-key="paperTexture"></h2>
                                </div>
                                <div class="flex items-center">
                                    <button class="reset-section-btn" data-section-key="paperFoldOverlay" data-translate-key-title="resetPaperTextureTitle">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                    </button>
                                    <label class="switch"><input type="checkbox" id="paper-fold-overlay-enabled-switch"><span class="toggle-slider"></span></label>
                                </div>
                            </div>
                            <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)]">
                                <div id="overlay-controls" class="controls-disabled-for-overlay space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="opacity"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="overlay-opacity" min="0" max="100" value="100" class="w-full slider"><input type="number" id="overlay-opacity-input" min="0" max="100" value="100" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="speedFps"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="overlay-speed" min="0" max="15" value="4" step="0.5" class="w-full slider"><input type="number" id="overlay-speed-input" min="0" max="15" value="4" step="0.5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Drop Shadow Accordion -->
                        <div class="accordion-section border border-[var(--border-color)]" id="foreground-shadow-accordion">
                            <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                                <div class="flex items-center gap-3 md:gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                    <h2 class="text-base font-semibold text-slate-300" data-translate-key="dropShadow"></h2>
                                    <div class="relative info-tooltip-trigger">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="text-[var(--text-muted)] cursor-pointer" width="16" height="16"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z"></path></svg>
                                        <div class="info-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-slate-900/95 p-3 text-xs text-slate-200 border border-[var(--border-color)] shadow-lg z-10 pointer-events-none">
                                            <p data-translate-key="dropShadowTooltip"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <button class="reset-section-btn" data-section-key="shadow" data-translate-key-title="resetDropShadowTitle">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                    </button>
                                    <label class="switch"><input type="checkbox" id="shadow-enabled-switch" checked><span class="toggle-slider"></span></label>
                                </div>
                            </div>
                            <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)]">
                                <div class="flex items-center justify-between flex-wrap gap-2">
                                    <label class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="offset"></label>
                                    <div class="flex items-center gap-2 md:gap-2"><label for="shadow-offset-x-input" class="text-sm text-[var(--text-muted)]">X:</label><input type="number" id="shadow-offset-x-input" min="-100" max="100" value="5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"><label for="shadow-offset-y-input" class="text-sm text-[var(--text-muted)] ml-1">Y:</label><input type="number" id="shadow-offset-y-input" min="-100" max="100" value="5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="blur"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="shadow-blur" min="0" max="50" value="5" class="w-full slider"><input type="number" id="shadow-blur-input" min="0" max="50" value="5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="opacity"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="shadow-opacity" min="0" max="100" value="50" step="1" class="w-full slider"><input type="number" id="shadow-opacity-input" min="0" max="100" value="50" step="1" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div>
                                    <label for="shadow-color" class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="color"></label>
                                    <input type="color" id="shadow-color" value="#000000" class="w-full h-10 mt-2 p-1 bg-slate-900 border border-[var(--border-color)] cursor-pointer">
                                </div>
                            </div>
                        </div>
                        <!-- Movement Accordion -->
                        <div class="accordion-section border border-[var(--border-color)]" id="movement-accordion">
                            <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                                <div class="flex items-center gap-3 md:gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                    <h2 class="text-base font-semibold text-slate-300" data-translate-key="movement"></h2>
                                </div>
                                <div class="flex items-center">
                                    <button class="reset-section-btn" data-section-key="movement" data-translate-key-title="resetMovementTitle">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                    </button>
                                    <label class="switch"><input type="checkbox" id="movement-enabled-switch" checked><span class="toggle-slider"></span></label>
                                </div>
                            </div>
                            <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)]">
                                <div id="movement-mode-controls">
                                    <label class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="controlMode"></label>
                                    <div id="movement-mode-btns" class="grid grid-cols-2 gap-2 md:gap-2 mt-2 btn-group-toggle">
                                        <button data-mode="simpel" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150 active" data-translate-key="simple"></button>
                                        <button data-mode="lengkap" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="advanced"></button>
                                    </div>
                                </div>
                                <div id="movement-controls-simpel" class="space-y-4 md:space-y-4 mt-4">
                                        <div>
                                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="speed"></label>
                                            <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-simpel-speed" min="0" max="15" value="1" step="0.5" class="w-full slider"><input type="number" id="movement-simpel-speed-input" min="0" max="15" value="1" step="0.5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="strength"></label>
                                            <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-simpel-strength" min="0" max="10" value="1" step="0.25" class="w-full slider"><input type="number" id="movement-simpel-strength-input" min="0" max="10" value="1" step="0.25" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                        </div>
                                </div>
                                <div id="movement-controls-lengkap" class="hidden space-y-4 md:space-y-4 mt-4">
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="rotationSpeed"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-rotation-speed" min="0" max="15" value="3" step="0.5" class="w-full slider"><input type="number" id="movement-rotation-speed-input" min="0" max="15" value="3" step="0.5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="rotationStrength"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-rotation-strength" min="0" max="10" value="1" step="0.25" class="w-full slider"><input type="number" id="movement-rotation-strength-input" min="0" max="10" value="1" step="0.25" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="positionSpeedX"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-position-speed-x" min="0" max="15" value="2" step="0.5" class="w-full slider"><input type="number" id="movement-position-speed-x-input" min="0" max="15" value="2" step="0.5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="positionSpeedY"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-position-speed-y" min="0" max="15" value="4" step="0.5" class="w-full slider"><input type="number" id="movement-position-speed-y-input" min="0" max="15" value="4" step="0.5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="positionStrengthX"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-position-strength-x" min="0" max="50" value="1" class="w-full slider"><input type="number" id="movement-position-strength-x-input" min="0" max="50" value="1" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="positionStrengthY"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="movement-position-strength-y" min="0" max="50" value="5" class="w-full slider"><input type="number" id="movement-position-strength-y-input" min="0" max="50" value="5" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Color Correction Accordion -->
                        <div class="accordion-section border border-[var(--border-color)]" id="foreground-color-accordion">
                            <div class="accordion-header w-full flex items-center justify-between p-4 md:p-4 transition-colors duration-200 cursor-pointer">
                               <div class="flex items-center gap-3 md:gap-3">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="accordion-chevron transition-transform duration-300 text-[var(--text-muted)]"><path d="m6 9 6 6 6-6"/></svg>
                                   <h2 class="text-base font-semibold text-slate-300" data-translate-key="colorCorrection"></h2>
                               </div>
                                <div class="flex items-center">
                                    <button class="reset-section-btn" data-section-key="color" data-translate-key-title="resetColorCorrectionTitle">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                                    </button>
                                    <label class="switch"><input type="checkbox" id="color-enabled-switch"><span class="toggle-slider"></span></label>
                                </div>
                            </div>
                            <div class="accordion-body space-y-4 md:space-y-4 p-4 md:p-4 border-t border-[var(--border-color)] hidden">
                                <div>
                                    <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="hue"></label>
                                    <div class="flex items-center gap-3 md:gap-3"><input type="range" id="color-hue" min="-180" max="180" value="0" class="w-full slider"><input type="number" id="color-hue-input" min="-180" max="180" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                </div>
                                <div id="color-correction-standard-controls" class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="saturation"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="color-saturation" min="-100" max="100" value="0" class="w-full slider"><input type="number" id="color-saturation-input" min="-100" max="100" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="brightness"></label>
                                        <div class="flex items-center gap-3 md:gap-3"><input type="range" id="color-brightness" min="-100" max="100" value="0" class="w-full slider"><input type="number" id="color-brightness-input" min="-100" max="100" value="0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 pt-2 border-t border-slate-700">
                                    <input type="checkbox" id="colorize-switch" class="h-4 w-4 bg-slate-600 border-slate-500 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                                    <label for="colorize-switch" class="text-sm text-slate-300" data-translate-key="colorize"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="animasi-tab-content" class="tab-content hidden space-y-4 md:space-y-4">
                    <div class="space-y-4 md:space-y-4">
                        <h2 class="text-lg font-bold text-slate-300" data-translate-key="animationObject"></h2>
                        <div id="animation-timeline" class="space-y-2 pt-4 border-t border-slate-700">
                            <div class="flex items-center justify-between">
                                <label for="timeline-slider" class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="timeline"></label>
                                <div class="flex items-center gap-2">
                                    <span id="timeline-current-time" class="text-sm text-slate-300 font-mono">0.00s</span>
                                    <span class="text-sm text-slate-500">/</span>
                                    <input type="number" id="timeline-duration-input" min="1" max="300" step="0.1" value="5.0" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button id="play-pause-btn" class="p-1.5 text-slate-300 hover:text-white bg-slate-700 hover:bg-slate-600 transition-colors">
                                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5z"/>
                                    </svg>
                                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="hidden" viewBox="0 0 16 16">
                                        <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                                    </svg>
                                </button>                                
                                <div class="relative w-full h-5 flex items-center timeline-wrapper">
                                    <input type="range" id="timeline-slider" min="0" max="5" step="0.01" value="0" class="slider">
                                    <div id="keyframe-markers-container" class="absolute w-full h-full pointer-events-none"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-[var(--text-muted)]" data-translate-key="controlMode"></label>
                            <div id="animation-mode-btns" class="grid grid-cols-2 gap-2 md:gap-2 mt-2 btn-group-toggle">
                                <button data-mode="simple" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="simple"></button>
                                <button data-mode="advanced" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="advanced"></button>
                            </div>
                        </div>
                        <div id="animation-simple-controls" class="space-y-4 pt-4 border-t border-slate-700">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-slate-300" data-translate-key="openAnim">Animasi Kertas Terbuka</span>
                                <label class="switch">
                                    <input type="checkbox" id="simple-anim-open-switch">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-slate-300" data-translate-key="closeAnim">Animasi Kertas Tertutup</span>
                                <label class="switch">
                                    <input type="checkbox" id="simple-anim-close-switch">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div id="animation-advanced-controls" class="hidden">
                            <div class="space-y-4 pt-4 border-t border-slate-700">
                                <div class="flex justify-end">
                                    <button id="add-keyframe-btn" class="flex items-center gap-2 px-4 py-2 bg-[var(--accent-color)] text-white text-sm font-semibold hover:bg-[var(--accent-color-hover)] transition-all duration-150 cursor-pointer">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
                                        </svg>
                                        <span data-translate-key="addKeyframe">Tambah Keyframe</span>
                                    </button>
                                </div>
                        
                                <div id="keyframe-list" class="space-y-2"></div>
                        
                                <div id="keyframe-properties-panel" class="hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info/Settings Tab Content -->            
                <div id="info-tab-content" class="tab-content hidden space-y-4 md:space-y-4 text-slate-300">
                    <div class="space-y-4">
                        <div class="space-y-2 md:space-y-2">
                            <h2 class="text-lg font-bold text-slate-300" data-translate-key="language"></h2>
                            <div id="language-btns" class="grid grid-cols-2 gap-2 md:gap-2 mt-2 btn-group-toggle">
                                <button data-lang="en" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150">English</button>
                                <button data-lang="id" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150">Indonesia</button>
                            </div>
                        </div>
                        <div class="space-y-2 md:space-y-2 pt-4 border-t border-[var(--border-color)]">
                            <h2 class="text-lg font-bold text-slate-300" data-translate-key="displayMode"></h2>
                            <div id="display-mode-btns" class="flex flex-col gap-2 mt-2 btn-group-toggle">
                                <button data-mode="auto" class="w-full p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="auto"></button>
                                <button data-mode="mobile" class="w-full p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="mobile"></button>
                                <button data-mode="desktop" class="w-full p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="desktop"></button>
                            </div>
                            <p id="display-mode-warning" class="text-sm text-red-400 mt-2 hidden" data-translate-key="displayModeWarning"></p>
                        </div>
                        <div class="space-y-2 md:space-y-2 pt-4 border-t border-[var(--border-color)]">
                            <h2 class="text-lg font-bold text-slate-300" data-translate-key="uiSize"></h2>
                            <div id="ui-size-btns" class="grid grid-cols-3 gap-2 md:gap-2 mt-2 btn-group-toggle">
                                <button data-size="compact" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="compact"></button>
                                <button data-size="normal" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="normal"></button>
                                <button data-size="luas" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium transition-all duration-150" data-translate-key="spacious"></button>
                            </div>
                        </div>
                        <div class="space-y-2 md:space-y-2 pt-4 border-t border-[var(--border-color)]">
                            <div class="flex items-center gap-2">
                                <h2 class="text-lg font-bold text-slate-300" data-translate-key="previewResolution"></h2>
                                <div class="relative info-tooltip-trigger">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="text-[var(--text-muted)] cursor-pointer" width="16" height="16"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z"></path></svg>
                                    <div class="info-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-slate-900/95 p-3 text-xs text-slate-200 border border-[var(--border-color)] shadow-lg z-10 pointer-events-none">
                                        <p data-translate-key="previewResolutionWarning"></p>
                                    </div>
                                </div>
                            </div>
                            <div id="preview-resolution-btns" class="grid grid-cols-3 gap-2 md:gap-2 mt-2 btn-group-toggle">
                                <button data-res="360" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium">360p</button>
                                <button data-res="540" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium">540p</button>
                                <button data-res="720" class="p-2.5 px-2 py-1.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm font-medium">720p</button>
                            </div>
                        <div class="pt-4 border-t border-[var(--border-color)] flex items-center justify-between">
                            <label for="debug-screen-switch" class="text-sm font-medium text-slate-300" data-translate-key="debugScreen"></label>
                            <label class="switch">
                                <input type="checkbox" id="debug-screen-switch">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-2 md:space-y-2 pt-4 border-t border-[var(--border-color)]">
                        <h2 class="text-lg font-bold text-slate-300" data-translate-key="appInfo"></h2>
                        <p class="text-sm" data-translate-key="appDescription"></p>
                        <p class="text-sm pt-2" data-translate-key="creatorInfo2"></p>
                    </div>
                    <div class="space-y-2 md:space-y-2 pt-4 border-t border-[var(--border-color)]">
                        <div class="grid grid-cols-2 gap-2 md:gap-2 mt-2">
                            <button id="pwa-install-button" class="flex items-center justify-center gap-2 px-4 py-2 bg-slate-600/50 text-white text-sm font-semibold text-center hover:bg-slate-500/50 transition-all duration-150 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M2.5 7C2.5 9.48528 4.51472 11.5 7 11.5C9.48528 11.5 11.5 9.48528 11.5 7C11.5 4.51472 9.48528 2.5 7 2.5C4.51472 2.5 2.5 4.51472 2.5 7ZM2.5 17C2.5 19.4853 4.51472 21.5 7 21.5C9.48528 21.5 11.5 19.4853 11.5 17C11.5 14.5147 9.48528 12.5 7 12.5C4.51472 12.5 2.5 14.5147 2.5 17ZM12.5 17C12.5 19.4853 14.5147 21.5 17 21.5C19.4853 21.5 21.5 19.4853 21.5 17C21.5 14.5147 19.4853 12.5 17 12.5C14.5147 12.5 12.5 14.5147 12.5 17ZM16 11V8H13V6H16V3H18V6H21V8H18V11H16Z"></path></svg>
                                <span data-translate-key="installApp">Install App</span>
                            </button>
                            <a href="https://www.youtube.com/@nurimator/shorts" target="_blank" class="flex items-center justify-center gap-2 px-4 py-2 bg-slate-600/50 text-white text-sm font-semibold text-center hover:bg-slate-500/50 transition-all duration-150 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M20 22H6.5C4.567 22 3 20.433 3 18.5V5C3 3.34315 4.34315 2 6 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22ZM19 20V17H6.5C5.67157 17 5 17.6716 5 18.5C5 19.3284 5.67157 20 6.5 20H19ZM10 4V12L13.5 10L17 12V4H10Z"></path></svg>
                                <span data-translate-key="tutorial">Tutorial</span>
                            </a>
                            <a href="https://github.com/your-repo/papera-me" target="_blank" class="flex items-center justify-center gap-2 px-4 py-2 bg-slate-600/50 text-white text-sm font-semibold text-center hover:bg-slate-500/50 transition-all duration-150 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12.001 2C6.47598 2 2.00098 6.475 2.00098 12C2.00098 16.425 4.86348 20.1625 8.83848 21.4875C9.33848 21.575 9.52598 21.275 9.52598 21.0125C9.52598 20.775 9.51348 19.9875 9.51348 19.15C7.00098 19.6125 6.35098 18.5375 6.15098 17.975C6.03848 17.6875 5.55098 16.8 5.12598 16.5625C4.77598 16.375 4.27598 15.9125 5.11348 15.9C5.90098 15.8875 6.46348 16.625 6.65098 16.925C7.55098 18.4375 8.98848 18.0125 9.56348 17.75C9.65098 17.1 9.91348 16.6625 10.201 16.4125C7.97598 16.1625 5.65098 15.3 5.65098 11.475C5.65098 10.3875 6.03848 9.4875 6.67598 8.7875C6.57598 8.5375 6.22598 7.5125 6.77598 6.1375C6.77598 6.1375 7.61348 5.875 9.52598 7.1625C10.326 6.9375 11.176 6.825 12.026 6.825C12.876 6.825 13.726 6.9375 14.526 7.1625C16.4385 5.8625 17.276 6.1375 17.276 6.1375C17.826 7.5125 17.476 8.5375 17.376 8.7875C18.0135 9.4875 18.401 10.375 18.401 11.475C18.401 15.3125 16.0635 16.1625 13.8385 16.4125C14.201 16.725 14.5135 17.325 14.5135 18.2625C14.5135 19.6 14.501 20.675 14.501 21.0125C14.501 21.275 14.6885 21.5875 15.1885 21.4875C19.259 20.1133 21.9999 16.2963 22.001 12C22.001 6.475 17.526 2 12.001 2Z"></path></svg>
                                <span data-translate-key="sourceCode">Source Code</span>
                            </a>
                            <a href="https://github.com/your-repo/papera-me/blob/main/LICENSE" target="_blank" class="flex items-center justify-center gap-2 px-4 py-2 bg-slate-600/50 text-white text-sm font-semibold text-center hover:bg-slate-500/50 transition-all duration-150 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M21 9V20.9925C21 21.5511 20.5552 22 20.0066 22H3.9934C3.44495 22 3 21.556 3 21.0082V2.9918C3 2.45531 3.44694 2 3.99826 2H14V8C14 8.55228 14.4477 9 15 9H21ZM21 7H16V2.00318L21 7ZM8 7V9H11V7H8ZM8 11V13H16V11H8ZM8 15V17H16V15H8Z"></path></svg>
                                <span data-translate-key="license">License</span>
                            </a>
                        </div>
                        <div class="mt-2">
                            <a href="https://lynk.id/nurimator" target="_blank" class="flex items-center justify-center gap-2 w-full px-4 py-2 bg-[var(--accent-color)] text-white text-sm font-semibold text-center hover:bg-[var(--accent-color-hover)] transition-all duration-150 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12.001 4.52853C14.35 2.42 17.98 2.49 20.2426 4.75736C22.5053 7.02472 22.583 10.637 20.4786 12.993L11.9999 21.485L3.52138 12.993C1.41705 10.637 1.49571 7.01901 3.75736 4.75736C6.02157 2.49315 9.64519 2.41687 12.001 4.52853Z"></path></svg>
                                <span data-translate-key="supportCreator">Support Creator</span>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Reset All Settings Button -->
                <div class="space-y-4 md:space-y-4 pt-4 border-t border-[var(--border-color)] mt-4">
                    <button id="reset-settings-btn" class="flex items-center justify-center gap-2 md:gap-2 w-full px-5 py-3 bg-[var(--danger-color)] text-white text-sm font-semibold hover:bg-[var(--danger-color-hover)] transition-all duration-150 cursor-pointer" data-translate-key="resetAll"></button>

                    <button id="reset-preferences-btn" class="hidden flex items-center justify-center gap-2 md:gap-2 w-full px-5 py-3 bg-[var(--danger-color)] text-white text-sm font-semibold hover:bg-[var(--danger-color-hover)] transition-all duration-150 cursor-pointer" data-translate-key="resetPreferences"></button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile footer with tabs and export button -->
    <footer id="mobile-footer" class="fixed bottom-0 left-0 right-0 h-16 bg-[var(--bg-header)] border-t border-[var(--border-color)] z-50 flex justify-around items-center" style="display: var(--mobile-footer-display);">
        <button id="mobile-tab-object" data-tab="object" class="mobile-tab-btn p-2 text-slate-300 hover:text-white active">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 3C6.44772 3 6 3.44772 6 4V7H3C2.44772 7 2 7.44772 2 8V20C2 20.5523 2.44772 21 3 21H17C17.5523 21 18 20.5523 18 20V17H21C21.5523 17 22 16.5523 22 16V4C22 3.44772 21.5523 3 21 3H7ZM17 7H8V5H20V15H18V8C18 7.44772 17.5523 7 17 7ZM16 9V15.7394L11.4911 11.6404L4 18.6321V9H16ZM11.5089 14.3596L16 18.4424V19H6.53702L11.5089 14.3596ZM7 13.5C7.82843 13.5 8.5 12.8284 8.5 12C8.5 11.1716 7.82843 10.5 7 10.5C6.17157 10.5 5.5 11.1716 5.5 12C5.5 12.8284 6.17157 13.5 7 13.5Z"></path></svg>
        </button>
        <button id="mobile-tab-background" data-tab="background" class="mobile-tab-btn p-2 text-slate-300 hover:text-white">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3C21.5523 3 22 3.44772 22 4V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V4C2 3.44772 2.44772 3 3 3H21ZM20 5H4V19H20V5ZM13 17V15H16V12H18V17H13ZM11 7V9H8V12H6V7H11Z"></path></svg>
        </button>
        <button id="mobile-tab-animasi" data-tab="animasi" class="mobile-tab-btn p-2 text-slate-300 hover:text-white">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2 3.9934C2 3.44476 2.45531 3 2.9918 3H21.0082C21.556 3 22 3.44495 22 3.9934V20.0066C22 20.5552 21.5447 21 21.0082 21H2.9918C2.44405 21 2 20.5551 2 20.0066V3.9934ZM4 5V19H20V5H4ZM10.6219 8.41459L15.5008 11.6672C15.6846 11.7897 15.7343 12.0381 15.6117 12.2219C15.5824 12.2658 15.5447 12.3035 15.5008 12.3328L10.6219 15.5854C10.4381 15.708 10.1897 15.6583 10.0672 15.4745C10.0234 15.4088 10 15.3316 10 15.2526V8.74741C10 8.52649 10.1791 8.34741 10.4 8.34741C10.479 8.34741 10.5562 8.37078 10.6219 8.41459Z"></path></svg>
        </button>
        <button id="mobile-tab-info" data-tab="info" class="mobile-tab-btn p-2 text-slate-300 hover:text-white">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14V16C8.68629 16 6 18.6863 6 22H4C4 17.5817 7.58172 14 12 14ZM12 13C8.685 13 6 10.315 6 7C6 3.685 8.685 1 12 1C15.315 1 18 3.685 18 7C18 10.315 15.315 13 12 13ZM12 11C14.21 11 16 9.21 16 7C16 4.79 14.21 3 12 3C9.79 3 8 4.79 8 7C8 9.21 9.79 11 12 11ZM14.5946 18.8115C14.5327 18.5511 14.5 18.2794 14.5 18C14.5 17.7207 14.5327 17.449 14.5945 17.1886L13.6029 16.6161L14.6029 14.884L15.5952 15.4569C15.9883 15.0851 16.4676 14.8034 17 14.6449V13.5H19V14.6449C19.5324 14.8034 20.0116 15.0851 20.4047 15.4569L21.3971 14.8839L22.3972 16.616L21.4055 17.1885C21.4673 17.449 21.5 17.7207 21.5 18C21.5 18.2793 21.4673 18.551 21.4055 18.8114L22.3972 19.3839L21.3972 21.116L20.4048 20.543C20.0117 20.9149 19.5325 21.1966 19.0001 21.355V22.5H17.0001V21.3551C16.4677 21.1967 15.9884 20.915 15.5953 20.5431L14.603 21.1161L13.6029 19.384L14.5946 18.8115ZM18 19.5C18.8284 19.5 19.5 18.8284 19.5 18C19.5 17.1716 18.8284 16.5 18 16.5C17.1716 16.5 16.5 17.1716 16.5 18C16.5 18.8284 17.1716 19.5 18 19.5Z"></path></svg>
        </button>
        <button id="mobile-export-btn" class="px-5 py-2.5 bg-[var(--accent-color)] text-white text-sm font-semibold hover:bg-[var(--accent-color-hover)] transition-all duration-150 cursor-pointer" data-translate-key="export">
        </button>
    </footer>

    <!-- Top notification popup -->
    <div id="top-notification-popup" class="hidden">
        <p id="top-notification-message"></p>
        <button class="close-btn">&times;</button>
    </div>

    <!-- Export settings popup -->
    <div id="export-settings-popup" class="hidden popup-overlay flex items-center justify-center p-4">
        <div class="bg-slate-800 shadow-xl p-8 w-full max-w-sm text-left border border-[var(--border-color)]">
            <h3 class="text-xl font-bold mb-6 text-slate-100" data-translate-key="exportSettings"></h3>
            <div class="space-y-4 md:space-y-4">
                <div>
                    <label class="block text-sm font-medium text-[var(--text-muted)] mb-2" data-translate-key="canvasResolution"></label>
                    <div id="canvas-resolution-btns" class="grid grid-cols-3 gap-2 md:gap-2 btn-group-toggle">
                        <button data-res="720" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">720p</button>
                        <button data-res="1080" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">1080p</button>
                        <button data-res="1440" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">1440p</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-[var(--text-muted)] mb-2" data-translate-key="fps"></label>
                    <div id="export-fps-btns" class="grid grid-cols-4 gap-2 md:gap-2 btn-group-toggle">
                        <button data-fps="12" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">12</button>
                        <button data-fps="24" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">24</button>
                        <button data-fps="30" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">30</button>
                        <button data-fps="60" class="px-2 py-1.5 text-sm border-2 border-[var(--border-color)] text-[var(--text-muted)]">60</button>
                    </div>
                </div>
                <div>
                    <label for="export-duration-input" class="block text-sm font-medium text-[var(--text-muted)] mt-4 mb-2" data-translate-key="duration"></label>
                    <input type="number" id="export-duration-input" value="5" min="1" max="60" class="w-full mt-1 p-2 bg-slate-700 border border-[var(--border-color-light)]">
                </div>
                <div>
                    <div class="flex items-center gap-2 mt-4 mb-2">
                        <label for="export-filename-input" class="block text-sm font-medium text-[var(--text-muted)]" data-translate-key="fileName"></label>
                        <div class="relative info-tooltip-trigger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="text-[var(--text-muted)] cursor-pointer" width="16" height="16"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z"></path></svg>
                            <div class="info-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-slate-900/95 p-3 text-xs text-slate-200 border border-[var(--border-color)] shadow-lg z-10 pointer-events-none">
                                <p data-translate-key="exportInfoTooltip"></p>
                            </div>
                        </div>
                    </div>
                    <div id="filename-container" class="w-full mt-1 flex items-center p-2 bg-slate-700 border border-[var(--border-color-light)]">
                        <input type="text" id="export-filename-input" value="papera-me" class="flex-grow bg-transparent border-none outline-none p-0">
                        <span class="text-[var(--text-muted)] pointer-events-none">.webm</span>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-4">
                <button id="cancel-export-settings-btn" class="px-5 py-2.5 bg-slate-600 text-white text-sm font-semibold hover:bg-slate-500 transition-all duration-150 cursor-pointer" data-translate-key="cancel"></button>
                <button id="start-export-with-settings-btn" class="px-5 py-2.5 bg-[var(--accent-color)] text-white text-sm font-semibold hover:bg-[var(--accent-color-hover)] transition-all duration-150 cursor-pointer" data-translate-key="startExport"></button>
            </div>
        </div>
    </div>
    <!-- Export progress popup -->
    <div id="export-progress-popup" class="hidden popup-overlay flex-col items-center justify-center">
        <h3 data-translate-key="exportingVideo"></h3>
        <p data-translate-key="exportingVideoWait"></p>
        <div id="progress-bar-container">
            <div id="progress-bar-fill">0%</div>
        </div>
        <button id="cancel-export-btn" class="mt-6 px-6 py-2 bg-[var(--danger-color)] text-white text-sm font-semibold hover:bg-[var(--danger-color-hover)] transition-colors cursor-pointer" data-translate-key="cancel"></button>
    </div>

    <!-- Confirmation popup for resetting settings -->
    <div id="confirmation-popup" class="hidden popup-overlay flex items-center justify-center p-4">
        <div class="bg-slate-800 shadow-xl p-8 w-full max-w-sm text-left border border-[var(--border-color)]">
            <h3 id="confirmation-title" class="text-xl font-bold mb-4 text-slate-100"></h3>
            <p id="confirmation-message" class="text-sm text-slate-300 mb-6"></p>
            <div id="reset-images-option" class="hidden items-center space-x-2 mb-6">
                <input type="checkbox" id="confirm-delete-images-checkbox" class="h-4 w-4 bg-slate-600 border-slate-500 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                <label for="confirm-delete-images-checkbox" class="text-sm text-slate-300" data-translate-key="deleteImportedImages"></label>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="px-5 py-2.5 bg-slate-600 text-white text-sm font-semibold hover:bg-slate-500 transition-all duration-150 cursor-pointer" data-translate-key="cancel"></button>
                <button id="confirm-continue-btn" class="px-5 py-2.5 bg-[var(--danger-color)] text-white text-sm font-semibold hover:bg-[var(--danger-color-hover)] transition-all duration-150 cursor-pointer" data-translate-key="continue"></button>
            </div>
        </div>
    </div>
<div id="debug-screen" class="hidden"></div>
<div id="processing-notification" class="hidden"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Main canvas and context
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            const canvasContainer = document.getElementById('canvas-container');
            const panelWrapper = document.getElementById('settings-panel-wrapper');
            const panelHandle = document.getElementById('panel-handle');
            const body = document.body;
            const mobilePanelHeader = document.getElementById('mobile-panel-header');
            
            // Notification elements
            const topNotificationPopup = document.getElementById('top-notification-popup');
            const topNotificationMessage = document.getElementById('top-notification-message');
            const topNotificationCloseBtn = topNotificationPopup.querySelector('.close-btn');
            let notificationTimeout;

            // Confirmation dialog elements
            const confirmationPopup = document.getElementById('confirmation-popup');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmContinueBtn = document.getElementById('confirm-continue-btn');
            const resetImagesOption = document.getElementById('reset-images-option');
            const deleteImagesCheckbox = document.getElementById('confirm-delete-images-checkbox');

            // SVG Filter elements
            const tornDilate = document.getElementById('torn-dilate');
            const tornTurbulence = document.getElementById('torn-turbulence');
            const tornDisplacement = document.getElementById('torn-displacement');
            const tornFlood = document.getElementById('torn-flood');

            // URLs for overlay images from GitHub repository.
            const overlayImageUrls = [
                './assets/texture/paper_overlay_0.webp',
                './assets/texture/paper_overlay_1.webp',
                './assets/texture/paper_overlay_2.webp',
                './assets/texture/paper_overlay_3.webp'
            ];
            const MASK_IMAGE_URLS = [
                './assets/texture/paper_mask_0.webp',
                './assets/texture/paper_mask_1.webp',
                './assets/texture/paper_mask_2.webp',
                './assets/texture/paper_mask_3.webp',
                './assets/texture/paper_mask_4.webp',
                './assets/texture/paper_mask_5.webp'
            ];
            const LAYER_IMAGE_URLS = [
                './assets/texture/paper_fold_0.webp',
                './assets/texture/paper_fold_1.webp',
                './assets/texture/paper_fold_2.webp',
                './assets/texture/paper_fold_3.webp',
                './assets/texture/paper_fold_4.webp',
                './assets/texture/paper_fold_5.webp'
            ];

            let maskImages = [];
            let layerImages = [];
            let originalOverlayImages = []; 
            
            // Offscreen canvases for processing
            const objectCanvas = document.createElement('canvas');
            const objectCtx = objectCanvas.getContext('2d');
            
            const finalObjectCanvas = document.createElement('canvas');
            const finalObjectCtx = finalObjectCanvas.getContext('2d');

            const contentCanvas = document.createElement('canvas'); // Kanvas untuk gabungan konten
            const contentCtx = contentCanvas.getContext('2d');

            const tempOverlayCanvas = document.createElement('canvas'); 

            let originalDebugContent = null;

            let tornEdgeCache = []; // Array untuk menyimpan hasil render sobekan
            let isCacheGenerationNeeded = true; // Flag untuk memicu pembuatan ulang cache
            let isLiveTornEdgePreview = false;
            let originalOverlaySpeed = 0;
            let isAdjustingTornEdge = false;
            let isGeneratingCache = false;

            const debugScreenEl = document.getElementById('debug-screen'); // Simpan elemen
            let lastDebugUpdateTime = 0; // Timer untuk membatasi update
            let fps = 0;
            let frameCount = 0;
            let lastFPSTime = 0;           

            let animationFrameId = null;
            let needsRedraw = true; // Flag to optimize rendering
            let isExporting = false;
            let isScrubbing = false;
            let pauseStartTime = 0; // <-- TAMBAHKAN INI
            let animationStartTime = 0; // <-- TAMBAHKAN INI
            // Default state for a single object
            const DEFAULT_OBJECT_STATE = {
                image: { element: null, originalElement: null, size: 80, offset: { x: 0, y: 0 }, rotation: 0, file: null },
                stroke: { enabled: true, width: 25, roughness: 25, detail: 0.020, seed: 0 },
                shadow: { enabled: true, offsetX: 5, offsetY: -5, blur: 5, color: '#000000', opacity: 50 },
                color: { enabled: false, hue: 0, saturation: 0, brightness: 0, colorize: false },
                movement: { 
                    enabled: true, 
                    mode: 'simpel',
                    simpelSpeed: 1,
                    simpelStrength: 1,
                    rotationSpeed: 4, 
                    rotationStrength: 0.5, 
                    positionSpeed: { x: 2, y: 4 },
                    positionStrength: { x: 1, y: 5 },
                    lastRotationUpdateTime: 0, 
                    lastPositionUpdateTime: { x: 0, y: 0 },
                    rotation: 0,
                    positionOffset: { x: 0, y: 0 }
                },
                paperFoldOverlay: {
                    enabled: true,
                    currentImageIndex: 0,
                    opacity: 75,
                    speed: 4,
                    blendMode: 'multiply',
                    lastImageSwitchTime: 0
                },
                animation: {
                    mode: 'simple', // 'simple' atau 'advanced'
                    simple: {
                        open: false,
                        close: false
                    },                    
                    isPlaying: true,
                    activeKeyframeId: null, // ID dari keyframe yang sedang dipilih
                    previewTime: null,
                    keyframes: [
                        // Kita mulai dengan dua keyframe default untuk contoh
                        {
                            id: Date.now(), // ID unik untuk setiap keyframe
                            time: 0,        // Waktu (dalam detik)
                            x: 0,           // Offset X (%)
                            y: 0,           // Offset Y (%)
                            scale: 50,      // Ukuran (%) - sama dengan ukuran default gambar
                            rotation: 0,
                            easing: 'linear',// Easing ke keyframe berikutnya
                            paperAnim: 'none'
                        },
                        {
                            id: Date.now() + 1,
                            time: 1,
                            x: 0,
                            y: 0,
                            scale: 80,
                            rotation: 0,
                            easing: 'linear',
                            paperAnim: 'none'
                        }
                    ]
                }             
            };

            // Default state for the entire application
            const DEFAULT_STATE = {
                activeTab: 'object',
                language: 'en',
                displayMode: 'auto', 
                uiSize: 'normal',
                previewResolution: '540',
                debugScreenEnabled: false,                
                background: {
                    element: null, color: '#00ff00', file: null,
                    transform: { enabled: true, mode: 'fill', size: 100, rotation: 0, offset: { x: 0, y: 0 } },
                    effects: {
                        colorCorrection: { enabled: false, hue: 0, saturation: 0, brightness: 0, colorize: false },
                        blur: { enabled: false, intensity: 10 },
                        vignette: { enabled: false, opacity: 100, radius: 50, feather: 100, color: '#000000' }
                    }
                },
                aspectRatio: '16/9',
                canvasDisplayResolution: 720,
                export: {
                    duration: 5, fps: 24, filename: 'papera-me'
                },
                object: JSON.parse(JSON.stringify(DEFAULT_OBJECT_STATE))
            };

            let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
            let keyframeClipboard = null;
            
            const RESOLUTION_MAPS = {
                '360': { '16/9': { w: 640, h: 360 }, '9/16': { w: 360, h: 640 }, '4/3': { w: 480, h: 360 }, '3/4': { w: 360, h: 480 }, '1/1': { w: 360, h: 360 } },
                '540': { '16/9': { w: 960, h: 540 }, '9/16': { w: 540, h: 960 }, '4/3': { w: 720, h: 540 }, '3/4': { w: 540, h: 720 }, '1/1': { w: 540, h: 540 } },
                '720': { '16/9': { w: 1280, h: 720 }, '9/16': { w: 720, h: 1280 }, '4/3': { w: 960, h: 720 }, '3/4': { w: 720, h: 960 }, '1/1': { w: 720, h: 720 } },
                '1080': { '16/9': { w: 1920, h: 1080 }, '9/16': { w: 1080, h: 1920 }, '4/3': { w: 1440, h: 1080 }, '3/4': { w: 1080, h: 1440 }, '1/1': { w: 1080, h: 1080 } },
                '1440': { '16/9': { w: 2560, h: 1440 }, '9/16': { w: 1440, h: 2560 }, '4/3': { w: 1920, h: 1440 }, '3/4': { w: 1440, h: 1920 }, '1/1': { w: 1440, h: 1440 } }
            };

            const EASING = {
                linear: t => t,
                easeIn: t => t * t,
                easeOut: t => t * (2 - t),
                easeInOut: t => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
                backIn: t => {
                    const s = 1.70158;
                    return t * t * ((s + 1) * t - s);
                },
                backOut: t => {
                    const s = 1.70158;
                    return (t = t - 1) * t * ((s + 1) * t + s) + 1;
                },
                backInOut: t => {
                    const s = 1.70158 * 1.525;
                    if ((t /= 0.5) < 1) return 0.5 * (t * t * (((s) + 1) * t - s));
                    return 0.5 * ((t -= 2) * t * (((s) + 1) * t + s) + 2);
                }
                // 'instant' akan ditangani secara khusus
            };

            // Language translations
            const translations = {
                'en': {
                    settings: 'Settings', export: 'Export', canvas: 'Canvas', previewAspectRatio: 'Aspect Ratio',
                    canvasResolution: 'Resolution', solidBackgroundColor: 'Solid Background Color', backgroundImage: 'Background Image',
                    dropImagePrompt: '<span class="desktop-only">Drop Image Here<br>- or -<br></span>Click to Import Image', backgroundTransform: 'Background Transform',
                    resetBackgroundTransformTitle: 'Reset Background Transform', backgroundMode: 'Background Mode', fill: 'Fill',
                    stretch: 'Stretch', backgroundSize: 'Background Size (%)', offsetX: 'Offset X (%)', offsetY: 'Offset Y (%)',
                    backgroundColorCorrection: 'Background Color Correction', resetBackgroundColorCorrectionTitle: 'Reset Background Color Correction',
                    hue: 'Hue', saturation: 'Saturation', brightness: 'Brightness', colorize: 'Colorize', backgroundBlur: 'Background Blur',
                    resetBackgroundBlurTitle: 'Reset Background Blur', intensity: 'Intensity', backgroundVignette: 'Background Vignette',
                    resetBackgroundVignetteTitle: 'Reset Background Vignette', opacity: 'Opacity', radius: 'Radius', feather: 'Feather',
                    vignetteColor: 'Vignette Color', objectImage: 'Object Image', transform: 'Transform', resetTransformTitle: 'Reset Transform',
                    imageSize: 'Image Size (%)', tornEdges: 'Torn Edges', resetTornEdgesTitle: 'Reset Torn Edges', thickness: 'Thickness',
                    roughness: 'Roughness', detail: 'Detail', paperTexture: 'Paper Texture',
                    resetPaperTextureTitle: 'Reset Paper Texture', speedFps: 'Speed', dropShadow: 'Drop Shadow',
                    resetDropShadowTitle: 'Reset Drop Shadow', offset: 'Offset', blur: 'Blur', color: 'Color', movement: 'Movement',
                    resetMovementTitle: 'Reset Movement', controlMode: 'Control Mode', simple: 'Simple', advanced: 'Advanced', speed: 'Speed',
                    strength: 'Strength', rotationSpeed: 'Rotation Speed', rotationStrength: 'Rotation Strength',
                    positionSpeedX: 'Position Speed X', positionSpeedY: 'Position Speed Y', positionStrengthX: 'Position Strength X',
                    positionStrengthY: 'Position Strength Y', colorCorrection: 'Color Correction', resetColorCorrectionTitle: 'Reset Color Correction',
                    language: 'Language', displayMode: 'Display Mode', auto: 'Auto', mobile: 'Mobile (Force)', desktop: 'Desktop (Force)',
                    displayModeWarning: 'Warning: Forcing a display mode may break layout or functionality if it doesn\'t match your screen size.',
                    uiSize: 'UI Size', compact: 'Compact', normal: 'Normal', spacious: 'Spacious', appInfo: 'App Information',
                    appDescription: 'This app was created to allow users to easily add paper tear effects and animations to their images.',
                    creatorInfo: 'Creator Info', donateLocal: 'Local Donation [IDR]', donateGlobal: 'Global Donation [USD]',
                    resetAll: 'Reset All', exportSettings: 'Export Settings', fps: 'Frames per Second (FPS)', duration: 'Duration (seconds)',
                    fileName: 'File Name', cancel: 'Cancel', startExport: 'Start Export', exportingVideo: 'Exporting Video...',
                    creatorInfo2: 'This app was created by Nurhidayat and is completely free to use.<br>If you find it useful, your support through donations is greatly appreciated.<br>YouTube: @nurimator | Instagram: @nurimator',
                    exportingVideoWait: 'Please wait and do not close this window.', confirmResetTitle: 'Confirm Reset',
                    confirmResetMessage: 'Are you sure you want to reset all settings to their default values?',
                    deleteImportedImages: 'Delete imported images', continue: 'Continue',
                    notificationWarnUpload: 'Please upload an image first!',
                    notificationWarnBg: 'Upload a background image first to adjust its settings.',
                    notificationWarnObject: 'Upload an object image first to adjust its settings.',
                    tabTitleBackground: 'Background Settings', tabTitleObject: 'Object Settings', tabTitleAnimasi: 'Animation Settings', tabTitleInfo: 'Preferences',
                    activeObject: 'Active Object',
                    animationObject: 'Object Animation',
                    dropShadowTooltip: 'We recommend turning off drop shadow when exporting for a greenscreen. <a href="#" target="_blank" class="text-blue-400 hover:underline">Learn more</a>',
                    easing: 'Easing', installApp: 'Install App', appInstalled: 'Installed',
                    linear: 'Linear',
                    easeIn: 'Ease In',
                    easeOut: 'Ease Out',
                    backIn: 'Back In',
                    backOut: 'Back Out',
                    instant: 'Instant',
                    easeInOut: 'Ease In Out',
                    backInOut: 'Back In Out',
                    keyframeProperties: 'Keyframe Properties', rotation: 'Rotation', easingToNext: 'Easing to Next', keyframeAnim: 'Paper Animation', animNone: 'None', animOpen: 'Open', animClose: 'Close',
                    addKeyframe: 'Add Keyframe', keyframePropertiesTitle: 'Keyframe Properties #',
                    simple: 'Simple',
                    advanced: 'Advanced',
                    openAnim: 'Opening Animation', tutorial: 'Tutorial', sourceCode: 'Source Code', license: 'License', supportCreator: 'Support Creator',
                    closeAnim: 'Closing Animation', timeline: 'Timeline',
                    resetPreferences: 'Reset Preferences', preparingExportCanvas: 'Preparing export canvas...',
                    confirmResetPrefsTitle: 'Confirm Preferences Reset', completing: 'Completing',
                    previewResolution: 'Preview Resolution', debugScreen: 'Debug Screen',
                    previewResolutionWarning: 'Preview resolution does not affect the final export resolution.',
                    exportInfoTooltip: 'Currently, the only available video export option is .webm to keep the app free and lightweight. <a href="https://www.webmproject.org/about/" target="_blank" rel="noopener noreferrer" class="text-[var(--accent-color)] hover:underline">Learn more</a>',
                    confirmResetPrefsMessage: 'Are you sure you want to reset language, display mode, and UI size to their defaults?'                    
                },
                'id': {
                    settings: 'Pengaturan', export: 'Ekspor', canvas: 'Kanvas', previewAspectRatio: 'Aspek Rasio',
                    canvasResolution: 'Resolusi', solidBackgroundColor: 'Warna Latar Belakang Solid', backgroundImage: 'Gambar Latar Belakang',
                    dropImagePrompt: '<span class="desktop-only">Jatuhkan Gambar Disini<br>- atau -<br></span>Tekan untuk Impor Gambar', backgroundTransform: 'Transformasi Latar',
                    resetBackgroundTransformTitle: 'Reset Transformasi Latar', backgroundMode: 'Mode Latar', fill: 'Isi',
                    stretch: 'Regangkan', backgroundSize: 'Ukuran Latar (%)', offsetX: 'Offset X (%)', offsetY: 'Offset Y (%)',
                    backgroundColorCorrection: 'Koreksi Warna Latar', resetBackgroundColorCorrectionTitle: 'Reset Koreksi Warna Latar',
                    hue: 'Hue', saturation: 'Saturasi', brightness: 'Kecerahan', colorize: 'Warnai', backgroundBlur: 'Blur Latar',
                    resetBackgroundBlurTitle: 'Reset Blur Latar', intensity: 'Intensitas', backgroundVignette: 'Vinyet Latar',
                    resetBackgroundVignetteTitle: 'Reset Vinyet Latar', opacity: 'Opasitas', radius: 'Radius', feather: 'Feather',
                    vignetteColor: 'Warna Vinyet', objectImage: 'Gambar Objek', transform: 'Transformasi', resetTransformTitle: 'Reset Transformasi',
                    imageSize: 'Ukuran Gambar (%)', tornEdges: 'Pinggiran Sobek', resetTornEdgesTitle: 'Reset Pinggiran Sobek', thickness: 'Ketebalan',
                    roughness: 'Kekasaran', detail: 'Detail', paperTexture: 'Tekstur Kertas',
                    resetPaperTextureTitle: 'Reset Tekstur Kertas', speedFps: 'Kecepatan', dropShadow: 'Bayangan',
                    resetDropShadowTitle: 'Reset Bayangan', offset: 'Offset', blur: 'Blur', color: 'Warna', movement: 'Gerakan',
                    resetMovementTitle: 'Reset Gerakan', controlMode: 'Mode Kontrol', simple: 'Simpel', advanced: 'Lengkap', speed: 'Kecepatan',
                    strength: 'Kekuatan', rotationSpeed: 'Kecepatan Rotasi', rotationStrength: 'Kekuatan Rotasi',
                    positionSpeedX: 'Kecepatan Posisi X', positionSpeedY: 'Kecepatan Posisi Y', positionStrengthX: 'Kekuatan Posisi X',
                    positionStrengthY: 'Kekuatan Posisi Y', colorCorrection: 'Koreksi Warna', resetColorCorrectionTitle: 'Reset Koreksi Warna',
                    language: 'Bahasa', displayMode: 'Mode Tampilan', auto: 'Otomatis', mobile: 'Seluler (Paksa)', desktop: 'Desktop (Paksa)',
                    displayModeWarning: 'Peringatan: Memaksa mode tampilan dapat merusak tata letak atau fungsionalitas jika tidak sesuai dengan ukuran layar Anda.',
                    uiSize: 'Ukuran UI', compact: 'Sempit', normal: 'Normal', spacious: 'Luas', appInfo: 'Informasi Aplikasi',
                    appDescription: 'Aplikasi ini dibuat untuk memungkinkan pengguna menambahkan efek sobekan kertas dan animasi pada gambar mereka dengan mudah.',
                    creatorInfo: 'Informasi Kreator', donateLocal: 'Donasi Lokal [IDR]', donateGlobal: 'Donasi Global [USD]',
                    resetAll: 'Reset Semua', exportSettings: 'Pengaturan Ekspor', fps: 'Frame per Detik (FPS)', duration: 'Durasi (detik)',
                    fileName: 'Nama File', cancel: 'Batal', startExport: 'Mulai Ekspor', exportingVideo: 'Mengekspor Video...',
                    creatorInfo2: 'Aplikasi ini dibuat oleh Nurhidayat dan sepenuhnya gratis untuk digunakan.<br>Jika kamu merasa aplikasi ini bermanfaat, dukungan dalam bentuk donasi sangat diapresiasi.<br>YouTube: @nurimator | Instagram: @nurimator',
                    exportingVideoWait: 'Harap tunggu dan jangan tutup jendela ini.', confirmResetTitle: 'Konfirmasi Reset',
                    confirmResetMessage: 'Apakah Anda yakin ingin mereset semua pengaturan ke nilai default?',
                    deleteImportedImages: 'Hapus gambar yang telah diimpor', continue: 'Lanjutkan',
                    notificationWarnUpload: 'Silakan masukan gambar terlebih dahulu!',
                    notificationWarnBg: 'Masukan gambar latar terlebih dahulu untuk mengaturnya.',
                    notificationWarnObject: 'Masukan gambar objek terlebih dahulu untuk mengaturnya.',
                    tabTitleBackground: 'Pengaturan Latar', tabTitleObject: 'Pengaturan Objek', tabTitleAnimasi: 'Pengaturan Animasi', tabTitleInfo: 'Preferensi',
                    activeObject: 'Objek Aktif',
                    animationObject: 'Animasi Objek',
                    dropShadowTooltip: 'Kami menyarankan dropshadow dimatikan jika ekspor sebagai greenscreen. <a href="#" target="_blank" class="text-blue-400 hover:underline">Pelajari selengkapnya</a>',
                    easing: 'Easing', installApp: 'Instal Aplikasi', appInstalled: 'Terinstal',
                    linear: 'Linear',
                    easeIn: 'Ease In',
                    easeOut: 'Ease Out',
                    backIn: 'Back In',
                    backOut: 'Back Out',
                    instant: 'Instan',
                    easeInOut: 'Ease In Out',
                    backInOut: 'Back In Out',
                    keyframeProperties: 'Properti Keyframe', rotation: 'Rotasi', easingToNext: 'Easing Berikutnya', keyframeAnim: 'Animasi Kertas', animNone: 'Tidak Ada', animOpen: 'Buka', animClose: 'Tutup',
                    addKeyframe: 'Tambah Keyframe', keyframePropertiesTitle: 'Properti Keyframe ke-',
                    simple: 'Simpel',
                    advanced: 'Lanjutan',
                    openAnim: 'Animasi Terbuka', tutorial: 'Tutorial', sourceCode: 'Kode Sumber', license: 'Lisensi', supportCreator: 'Dukung Kreator',
                    closeAnim: 'Animasi Tertutup', timeline: 'Timeline',
                    resetPreferences: 'Reset Preferensi', preparingExportCanvas: 'Menyiapkan kanvas ekspor...',
                    confirmResetPrefsTitle: 'Konfirmasi Reset Preferensi', completing: 'Menyelesaikan',
                    previewResolution: 'Resolusi Pratinjau', debugScreen: 'Layar Debug',
                    previewResolutionWarning: 'Resolusi pratinjau tidak memengaruhi resolusi ekspor.',
                    exportInfoTooltip: 'Saat ini opsi file video ekspor yang tersedia adalah .webm untuk menjaga aplikasi tetap gratis dan ringan. <a href="https://www.webmproject.org/about/" target="_blank" rel="noopener noreferrer" class="text-[var(--accent-color)] hover:underline">Pelajari selengkapnya</a>',
                    confirmResetPrefsMessage: 'Apakah Anda yakin ingin mereset bahasa, mode tampilan, dan ukuran UI ke nilai default?'
                }
            };
            
            function hexToRgba(hex, opacity) {
                let r = 0, g = 0, b = 0;
                if (hex.length === 7) { 
                    r = parseInt(hex.substring(1, 3), 16); 
                    g = parseInt(hex.substring(3, 5), 16); 
                    b = parseInt(hex.substring(5, 7), 16); 
                }
                return `rgba(${r},${g},${b},${opacity})`;
            }

            function throttle(func, delay) {
                let inProgress = false;
                return (...args) => {
                    if (inProgress) {
                        return;
                    }
                    inProgress = true;
                    setTimeout(() => {
                        func(...args);
                        inProgress = false;
                    }, delay);
                };
            }

            function getVisualStateAtTime(timeInSeconds, keyframes) {
                const sortedKeyframes = [...keyframes].sort((a, b) => a.time - b.time);
                let currentState = 'open';

                for (const kf of sortedKeyframes) {
                    if (kf.time < timeInSeconds) {
                        if (kf.paperAnim === 'open') {
                            currentState = 'open';
                        } else if (kf.paperAnim === 'close') {
                            currentState = 'closed';
                        }
                    } else {
                        break;
                    }
                }
                return currentState;
            }

            // Fungsi ini berisi logika keyframe yang sudah ada sebelumnya
            function getAdvancedTransform(timeInSeconds, objectState) {
                const keyframes = [...objectState.animation.keyframes].sort((a, b) => a.time - b.time);
                let currentTransform = { 
                    x: objectState.image.offset.x, 
                    y: objectState.image.offset.y, 
                    scale: objectState.image.size, 
                    rotation: objectState.image.rotation
                };

                let prevKeyframe, nextKeyframe;

                if (keyframes.length > 0) {
                    prevKeyframe = keyframes[0];
                    nextKeyframe = keyframes[keyframes.length - 1];

                    for (let i = 0; i < keyframes.length; i++) {
                        if (keyframes[i].time <= timeInSeconds) {
                            prevKeyframe = keyframes[i];
                        }
                        if (keyframes[i].time > timeInSeconds) {
                            nextKeyframe = keyframes[i];
                            break;
                        }
                    }

                    if (prevKeyframe === nextKeyframe) {
                        currentTransform = { 
                            x: prevKeyframe.x, 
                            y: prevKeyframe.y, 
                            scale: prevKeyframe.scale, 
                            rotation: prevKeyframe.rotation 
                        };
                    } else {
                        if (prevKeyframe.easing === 'instant') {
                            currentTransform = { 
                                x: nextKeyframe.x, 
                                y: nextKeyframe.y, 
                                scale: nextKeyframe.scale, 
                                rotation: nextKeyframe.rotation 
                            };
                        } else {
                            const segmentDuration = nextKeyframe.time - prevKeyframe.time;
                            const timeIntoSegment = timeInSeconds - prevKeyframe.time;
                            let progress = (segmentDuration > 0) ? timeIntoSegment / segmentDuration : 1;
                            progress = Math.max(0, Math.min(1, progress));

                            const easingFunc = EASING[prevKeyframe.easing] || EASING.linear;
                            const easedProgress = easingFunc(progress);

                            currentTransform.x = lerp(prevKeyframe.x, nextKeyframe.x, easedProgress);
                            currentTransform.y = lerp(prevKeyframe.y, nextKeyframe.y, easedProgress);
                            currentTransform.scale = lerp(prevKeyframe.scale, nextKeyframe.scale, easedProgress);
                            currentTransform.rotation = lerp(prevKeyframe.rotation, nextKeyframe.rotation, easedProgress);
                        }
                    }
                }

                return { transform: currentTransform, prevKeyframe, nextKeyframe };
            }

            async function generateTornEdgeCache() {
                if (isGeneratingCache || !state.object.image.element || !state.object.stroke.enabled) {
                    return
                }
                isGeneratingCache = true
                isCacheGenerationNeeded = false
                console.log("Memulai pembuatan cache progresif...")
                tornEdgeCache = [];
                console.log("Cache lama dikosongkan, memulai pembuatan cache baru...");

                const objectState = state.object
                const seeds = [20, 30, 40, 10]
                const sourceImg = objectState.image.element
                const newCache = []

                const BASE_RENDER_WIDTH = 1080.0
                const renderScaleFactor = sourceImg.width / BASE_RENDER_WIDTH

                for (let i = 0; i < seeds.length; i++) {
                    const seed = seeds[i]
                    const cacheCanvas = document.createElement('canvas')
                    const cacheCtx = cacheCanvas.getContext('2d')
                    cacheCanvas.width = sourceImg.width
                    cacheCanvas.height = sourceImg.height

                    const adjustedStrokeWidth = objectState.stroke.width * renderScaleFactor
                    const adjustedRoughness = objectState.stroke.roughness * renderScaleFactor
                    const adjustedDetail = objectState.stroke.detail / renderScaleFactor

                    tornDilate.setAttribute('radius', adjustedStrokeWidth)
                    tornDisplacement.setAttribute('scale', adjustedRoughness)
                    tornTurbulence.setAttribute('baseFrequency', adjustedDetail)
                    tornTurbulence.setAttribute('seed', seed)
                    tornFlood.setAttribute('flood-color', '#FFFFFF')

                    cacheCtx.filter = 'url(#combined-filter)'
                    cacheCtx.drawImage(sourceImg, 0, 0)

                    const img = new Image()
                    img.src = cacheCanvas.toDataURL()
                    await img.decode()

                    newCache[i] = img
                    tornEdgeCache = [...newCache]
                    requestRedraw()

                    await new Promise(resolve => setTimeout(resolve, 16))
                }

                isGeneratingCache = false
                console.log("Pembuatan cache progresif selesai.")
            }


            function drawFinalObject(objectState, imgW, imgH, totalOffsetX, totalOffsetY, tornEdgesEnabled, layerImage = null, maskImage = null) {
                const centerX = contentCanvas.width / 2;
                const centerY = contentCanvas.height / 2;

                objectCtx.clearRect(0, 0, objectCanvas.width, objectCanvas.height);
                contentCtx.clearRect(0, 0, contentCanvas.width, contentCanvas.height);
                finalObjectCtx.clearRect(0, 0, finalObjectCanvas.width, finalObjectCanvas.height);

                let fgColorFilterString = '';
                if (objectState.color.enabled) {
                    let filterParts = [];
                    if (objectState.color.colorize) filterParts.push('sepia(1)');
                    filterParts.push(`hue-rotate(${objectState.color.hue}deg)`);
                    filterParts.push(`saturate(${100 + objectState.color.saturation}%)`);
                    filterParts.push(`brightness(${100 + objectState.color.brightness}%)`);
                    fgColorFilterString = filterParts.join(' ');
                }

                contentCtx.save();
                contentCtx.filter = fgColorFilterString;
                contentCtx.translate(centerX, centerY);
                contentCtx.drawImage(objectState.image.element, -imgW / 2, -imgH / 2, imgW, imgH);
                contentCtx.restore();

                const overlayImage = originalOverlayImages[objectState.paperFoldOverlay.currentImageIndex];
                if (overlayImage && overlayImage.complete && overlayImage.naturalWidth > 0) {
                    const tempCtx = tempOverlayCanvas.getContext('2d');
                    tempOverlayCanvas.width = overlayImage.naturalWidth;
                    tempOverlayCanvas.height = overlayImage.naturalHeight;
                    tempCtx.drawImage(overlayImage, 0, 0);
                    const imageData = tempCtx.getImageData(0, 0, tempOverlayCanvas.width, tempOverlayCanvas.height);
                    const data = imageData.data;
                    const effectStrength = objectState.paperFoldOverlay.enabled ? objectState.paperFoldOverlay.opacity : 0;
                    const strength = (100 - effectStrength) / 100;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] += (255 - data[i]) * strength;
                        data[i + 1] += (255 - data[i + 1]) * strength;
                        data[i + 2] += (255 - data[i + 2]) * strength;
                    }
                    tempCtx.putImageData(imageData, 0, 0);
                    contentCtx.save();
                    contentCtx.translate(centerX, centerY);
                    contentCtx.globalCompositeOperation = objectState.paperFoldOverlay.blendMode;
                    contentCtx.drawImage(tempOverlayCanvas, -imgW / 2, -imgH / 2, imgW, imgH);
                    contentCtx.restore();
                }

                if (layerImage) {
                    const layerSize = Math.max(imgW, imgH);
                    contentCtx.save();
                    contentCtx.translate(centerX, centerY);
                    contentCtx.drawImage(layerImage, -layerSize / 2, -layerSize / 2, layerSize, layerSize);
                    contentCtx.restore();
                }

                if (tornEdgesEnabled && objectState.stroke.width > 0) {
                    objectCtx.clearRect(0, 0, objectCanvas.width, objectCanvas.height);
                    objectCtx.save();

                    if (isLiveTornEdgePreview) {

                        const previewCanvas = tempOverlayCanvas; 
                        const previewCtx = previewCanvas.getContext('2d');
                        
                        const sourceImg = objectState.image.element;
                        previewCanvas.width = sourceImg.width;
                        previewCanvas.height = sourceImg.height; 

                        const BASE_RENDER_WIDTH = 1080.0;
                        const renderScaleFactor = sourceImg.width / BASE_RENDER_WIDTH; 
                        const adjustedStrokeWidth = objectState.stroke.width * renderScaleFactor;
                        const adjustedRoughness = objectState.stroke.roughness * renderScaleFactor;
                        const adjustedDetail = objectState.stroke.detail / renderScaleFactor;

                        tornDilate.setAttribute('radius', adjustedStrokeWidth);
                        tornDisplacement.setAttribute('scale', adjustedRoughness);
                        tornTurbulence.setAttribute('baseFrequency', adjustedDetail);
                        tornTurbulence.setAttribute('seed', 10);
                        tornFlood.setAttribute('flood-color', '#FFFFFF');

                        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                        previewCtx.filter = 'url(#combined-filter)';
                        previewCtx.drawImage(sourceImg, 0, 0);

                        objectCtx.filter = 'none'; 
                        objectCtx.translate(centerX, centerY);
                        objectCtx.drawImage(previewCanvas, -imgW / 2, -imgH / 2, imgW, imgH); 
                    } else {
                        let cachedImage = tornEdgeCache[objectState.paperFoldOverlay.currentImageIndex];

                        if (!cachedImage && tornEdgeCache.length > 0) {
                            cachedImage = tornEdgeCache[0];
                        }
                        
                        if (cachedImage && cachedImage.complete) {
                            objectCtx.translate(centerX, centerY);
                            objectCtx.drawImage(cachedImage, -imgW / 2, -imgH / 2, imgW, imgH);
                        } else {
                            objectCtx.translate(centerX, centerY);
                            objectCtx.drawImage(objectState.image.element, -imgW / 2, -imgH / 2, imgW, imgH);
                        }
                    }

                    objectCtx.restore();
                    contentCtx.save();
                    contentCtx.globalCompositeOperation = 'destination-in';
                    contentCtx.drawImage(objectCanvas, 0, 0);
                    contentCtx.restore();
                } else {
                    objectCtx.save();
                    objectCtx.translate(centerX, centerY);
                    objectCtx.drawImage(objectState.image.element, -imgW / 2, -imgH / 2, imgW, imgH);
                    objectCtx.restore();

                    contentCtx.save();
                    contentCtx.globalCompositeOperation = 'destination-in';
                    contentCtx.drawImage(objectCanvas, 0, 0);
                    contentCtx.restore();
                }

                let finalSourceCanvas = contentCanvas;
                if (maskImage) {
                    const maskSize = Math.max(imgW, imgH);
                    finalObjectCtx.save();
                    finalObjectCtx.translate(centerX, centerY);
                    finalObjectCtx.drawImage(maskImage, -maskSize / 2, -maskSize / 2, maskSize, maskSize);
                    finalObjectCtx.restore();
                    finalObjectCtx.save();
                    finalObjectCtx.globalCompositeOperation = 'source-in';
                    finalObjectCtx.drawImage(contentCanvas, 0, 0);
                    finalObjectCtx.restore();
                    finalSourceCanvas = finalObjectCanvas;
                }

                return finalSourceCanvas;
            }
            
            function requestRedraw() { needsRedraw = true; }
            
            async function draw(elapsedTime = 0) { // <-- JADIKAN ASYNC
                if (isCacheGenerationNeeded && !isGeneratingCache && !isLiveTornEdgePreview) {
                    generateTornEdgeCache()
                }

                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // --- 1. GAMBAR BACKGROUND --- (Logika ini tidak berubah)
                let bgFilterString = '';
                const bgCC = state.background.effects.colorCorrection;
                if (bgCC.enabled) {
                    let filterParts = [];
                    if (bgCC.colorize) { filterParts.push('sepia(1)'); }
                    filterParts.push(`hue-rotate(${bgCC.hue}deg)`);
                    filterParts.push(`saturate(${100 + bgCC.saturation}%)`);
                    filterParts.push(`brightness(${100 + bgCC.brightness}%)`);
                    bgFilterString = filterParts.join(' ');
                }
                if (state.background.effects.blur.enabled && state.background.effects.blur.intensity > 0) {
                    bgFilterString += ` blur(${state.background.effects.blur.intensity}px)`;
                }
                ctx.filter = bgFilterString.trim();

                // SELALU GAMBAR WARNA SOLID SEBAGAI LAPISAN DASAR
                ctx.fillStyle = state.background.color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const bgOffsetX = (canvas.width * state.background.transform.offset.x) / 100;
                const bgOffsetY = (canvas.height * (state.background.transform.offset.y * -1)) / 100;

                // JIKA ADA GAMBAR LATAR, GAMBAR DI ATAS WARNA SOLID
                if (state.background.element) {
                    ctx.save();
                    if (state.background.transform.mode === 'fill') {
                        // ... (logika menggambar gambar latar - TIDAK ADA YANG BERUBAH DI SINI) ...
                        ctx.translate(canvas.width / 2 + bgOffsetX, canvas.height / 2 + bgOffsetY);
                        ctx.rotate(state.background.transform.rotation * Math.PI / 180);
                        const userScale = state.background.transform.size / 100;
                        const canvasAspect = canvas.width / canvas.height;
                        const bgAspect = state.background.element.width / state.background.element.height;
                        let fillScale = (canvasAspect > bgAspect) ? canvas.width / state.background.element.width : canvas.height / state.background.element.height;
                        ctx.scale(fillScale * userScale, fillScale * userScale);
                        ctx.drawImage(state.background.element, -state.background.element.width / 2, -state.background.element.height / 2);
                    } else if (state.background.transform.mode === 'stretch') {
                        ctx.drawImage(state.background.element, 0, 0, canvas.width, canvas.height);
                    }
                    ctx.restore();
                }
                ctx.filter = 'none';
                if (state.background.effects.vignette.enabled) {
                    ctx.save();
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const outerRadius = 1.5 * Math.sqrt(centerX * centerX + centerY * centerY);
                    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, outerRadius);
                    const vignetteColor = hexToRgba(state.background.effects.vignette.color, state.background.effects.vignette.opacity / 100);
                    const midPoint = state.background.effects.vignette.radius / 100;
                    const halfFeather = (state.background.effects.vignette.feather / 100) / 2;
                    const stop1 = Math.max(0, midPoint - halfFeather);
                    const stop2 = Math.min(1, midPoint + halfFeather);
                    gradient.addColorStop(stop1, 'rgba(0,0,0,0)');
                    gradient.addColorStop(stop2, vignetteColor);
                    gradient.addColorStop(1, vignetteColor);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.restore();
                }
                // --- 2. GAMBAR OBJEK ---
                const objectState = state.object;
                if (objectState.image.element) {
                    const animState = objectState.animation;
                    const isSimpleMode = animState.mode === 'simple';
                    const totalDuration = state.export.duration;
                    let timeInSeconds;
                    if (animState.previewTime !== null) {
                        timeInSeconds = animState.previewTime;
                    } else if (isExporting) {
                        timeInSeconds = elapsedTime / 1000;
                    } else {
                        timeInSeconds = (elapsedTime / 1000) % totalDuration;
                    }
                    let transform, isPaperAnimActive = false, paperFrameIndex = 0, currentLayer = null, currentMask = null;
                    if (isSimpleMode) {
                        transform = { x: objectState.image.offset.x, y: objectState.image.offset.y, scale: objectState.image.size, rotation: objectState.image.rotation };
                        const animDuration = 1.0, frameDuration = animDuration / 6.0;
                        if (animState.simple.previewing) {
                            const timeSincePreviewStart = (performance.now() - animState.simple.previewStartTime) / 1000;
                            if (timeSincePreviewStart < animDuration) {
                                isPaperAnimActive = true;
                                let frameIndex = Math.min(5, Math.floor(timeSincePreviewStart / frameDuration));
                                paperFrameIndex = (animState.simple.previewing === 'close') ? 5 - frameIndex : frameIndex;
                            }
                        } else {
                            if (animState.simple.open && timeInSeconds >= 0 && timeInSeconds < animDuration) {
                                isPaperAnimActive = true;
                                paperFrameIndex = Math.min(5, Math.floor(timeInSeconds / frameDuration));
                            }
                            const closeAnimStartTime = totalDuration - animDuration;
                            if (animState.simple.close && timeInSeconds >= closeAnimStartTime && timeInSeconds <= totalDuration) {
                                isPaperAnimActive = true;
                                const timeIntoClose = timeInSeconds - closeAnimStartTime;
                                const frameIndex = Math.min(5, Math.floor(timeIntoClose / frameDuration));
                                paperFrameIndex = 5 - frameIndex;
                            }
                        }
                    } else {
                        const { transform: advTransform, prevKeyframe, nextKeyframe } = getAdvancedTransform(timeInSeconds, objectState);
                        transform = advTransform;
                        if (prevKeyframe && nextKeyframe) {
                            const paperAnimType = prevKeyframe.paperAnim;
                            const segmentDuration = nextKeyframe.time - prevKeyframe.time;
                            if (paperAnimType !== 'none' && segmentDuration > 0) {
                                isPaperAnimActive = true;
                                const progress = Math.min(1, Math.max(0, (timeInSeconds - prevKeyframe.time) / segmentDuration));
                                let frameIndex = Math.floor(progress * MASK_IMAGE_URLS.length);
                                paperFrameIndex = Math.max(0, Math.min(MASK_IMAGE_URLS.length - 1, frameIndex));
                                if (paperAnimType === 'close') {
                                    paperFrameIndex = (MASK_IMAGE_URLS.length - 1) - paperFrameIndex;
                                }
                            }
                        }
                    }
                    if (isPaperAnimActive) {
                        currentLayer = layerImages[paperFrameIndex];
                        currentMask = maskImages[paperFrameIndex];
                    }
                    if (!transform) { console.error("Gagal menentukan transformasi objek."); ctx.restore(); return; }
                    const canvasAspect = canvas.width / canvas.height;
                    const imageAspect = objectState.image.element.width / objectState.image.element.height;
                    const baseScale = (canvasAspect > imageAspect) ? canvas.height / objectState.image.element.height : canvas.width / objectState.image.element.width;
                    const finalScale = baseScale * (transform.scale / 100);
                    const finalW = objectState.image.element.width * finalScale;
                    const finalH = objectState.image.element.height * finalScale;
                    const imgBaseOffsetX = (canvas.width * transform.x) / 100;
                    const imgBaseOffsetY = (canvas.height * transform.y) / 100;
                    const totalOffsetX = imgBaseOffsetX + objectState.movement.positionOffset.x;
                    const totalOffsetY = imgBaseOffsetY + objectState.movement.positionOffset.y;
                    const isTornEdgesEnabled = objectState.stroke.enabled;
                    const stateBefore = getVisualStateAtTime(timeInSeconds, animState.keyframes);
                    let finalStampSource;
                    if (!isSimpleMode && !isPaperAnimActive && stateBefore === 'closed') {
                        finalStampSource = drawFinalObject(objectState, finalW, finalH, totalOffsetX, totalOffsetY, isTornEdgesEnabled, layerImages[0], maskImages[0]);
                    } else {
                        finalStampSource = drawFinalObject(objectState, finalW, finalH, totalOffsetX, totalOffsetY, isTornEdgesEnabled, currentLayer, currentMask);
                    }
                    ctx.save();
                    if (objectState.shadow.enabled) {
                        const baseResolution = 720;
                        const currentResolution = canvas.height;
                        const resolutionScaleFactor = currentResolution / baseResolution;
                        ctx.shadowColor = hexToRgba(objectState.shadow.color, objectState.shadow.opacity / 100);
                        ctx.shadowBlur = objectState.shadow.blur * resolutionScaleFactor;
                        ctx.shadowOffsetX = objectState.shadow.offsetX * resolutionScaleFactor;
                        ctx.shadowOffsetY = (objectState.shadow.offsetY * -1) * resolutionScaleFactor;
                    }
                    ctx.translate(canvas.width / 2 + totalOffsetX, canvas.height / 2 + (totalOffsetY * -1));
                    if (objectState.movement.enabled || transform.rotation !== 0) {
                        const totalRotation = transform.rotation + objectState.movement.rotation;
                        ctx.rotate(totalRotation * Math.PI / 180);
                    }
                    ctx.drawImage(finalStampSource, -finalStampSource.width / 2, -finalStampSource.height / 2);
                    ctx.restore();
                }
                ctx.restore();
            }

            function fpsLoop(timestamp) {
                if (!lastFPSTime) {
                    lastFPSTime = timestamp;
                }
                frameCount++;
                const delta = timestamp - lastFPSTime;

                if (delta >= 1000) {
                    fps = Math.round((frameCount * 1000) / delta);
                    frameCount = 0;
                    lastFPSTime = timestamp;
                    updateDebugScreen(); 
                }

                requestAnimationFrame(fpsLoop);
            }

            function updateTimelineUI() {
                if (isScrubbing) return

                const elapsed = performance.now() - animationStartTime
                const totalDuration = state.export.duration
                const currentTime = (elapsed / 1000) % totalDuration

                const timelineSlider = document.getElementById('timeline-slider')
                const timelineCurrentTime = document.getElementById('timeline-current-time')

                if (timelineSlider) timelineSlider.value = currentTime
                if (timelineCurrentTime) timelineCurrentTime.textContent = `${currentTime.toFixed(2)}s`
            }

            function animationLoop() {
                const timestamp = performance.now()

                if (state.object.animation.isPlaying && !isScrubbing) {
                    updateMovement(timestamp)
                    updatePaperFoldOverlay(timestamp)
                    updateTimelineUI()
                }

                if (needsRedraw) {
                    const animState = state.object.animation
                    let timeToDraw

                    if (animState.previewTime !== null) {
                        timeToDraw = animState.previewTime * 1000
                    } else {
                        const elapsed = timestamp - animationStartTime
                        timeToDraw = elapsed
                    }

                    draw(timeToDraw).then(() => {
                        needsRedraw = false
                    })
                }

                animationFrameId = requestAnimationFrame(animationLoop)
            }

            /**
             * Updates objects' positions and rotations based on movement settings and time.
             */
            function updateMovement(timestamp) {
                if (isLiveTornEdgePreview) return;
                let hasChanged = false;
                const objectState = state.object; // Ganti dari forEach ke referensi langsung

                if (!objectState.movement.enabled) {
                    if (objectState.movement.rotation !== 0 || objectState.movement.positionOffset.x !== 0 || objectState.movement.positionOffset.y !== 0) {
                        objectState.movement.rotation = 0;
                        objectState.movement.positionOffset = { x: 0, y: 0 };
                        hasChanged = true;
                    }
                    // Hapus 'return' karena kita tidak lagi di dalam loop
                } else { // Tambahkan 'else' untuk menjalankan logika jika movement enabled
                    const isSimpelMode = objectState.movement.mode === 'simpel';
                    const speedMultiplier = isSimpelMode ? objectState.movement.simpelSpeed : 1;
                    const strengthMultiplier = isSimpelMode ? objectState.movement.simpelStrength : 1;
                    
                    const canvasWidth = canvas.offsetWidth;
                    const canvasHeight = canvas.offsetHeight;
                    
                    // Skalakan kekuatan gerakan berdasarkan ukuran kanvas (misalnya, 5% dari lebar/tinggi kanvas)
                    const strengthScaleX = (canvasWidth / 100) * objectState.movement.positionStrength.x * strengthMultiplier;
                    const strengthScaleY = (canvasHeight / 100) * objectState.movement.positionStrength.y * strengthMultiplier;                    
                    
                    const effectiveRotationSpeed = objectState.movement.rotationSpeed * speedMultiplier;
                    const effectiveRotationStrength = objectState.movement.rotationStrength * strengthMultiplier;
                    const effectivePositionSpeedX = objectState.movement.positionSpeed.x * speedMultiplier;
                    const effectivePositionSpeedY = objectState.movement.positionSpeed.y * speedMultiplier;
                    const effectivePositionStrengthX = objectState.movement.positionStrength.x * strengthMultiplier;
                    const effectivePositionStrengthY = objectState.movement.positionStrength.y * strengthMultiplier;

                    if (effectiveRotationSpeed > 0 && effectiveRotationStrength > 0) {
                        const rotationInterval = 1000 / effectiveRotationSpeed;
                        if (timestamp - objectState.movement.lastRotationUpdateTime > rotationInterval) {
                            objectState.movement.rotation = objectState.movement.rotation > 0 ? -effectiveRotationStrength : effectiveRotationStrength;
                            objectState.movement.lastRotationUpdateTime = timestamp;
                            hasChanged = true;
                        }
                    } else if (objectState.movement.rotation !== 0) {
                        objectState.movement.rotation = 0; hasChanged = true;
                    }

                    if (effectivePositionSpeedX > 0 && effectivePositionStrengthX > 0) {
                        const positionIntervalX = 1000 / effectivePositionSpeedX;
                        if (timestamp - objectState.movement.lastPositionUpdateTime.x > positionIntervalX) {
                            objectState.movement.positionOffset.x = (Math.random() - 0.5) * effectivePositionStrengthX;
                            objectState.movement.lastPositionUpdateTime.x = timestamp;
                            hasChanged = true;
                        }
                    } else if (objectState.movement.positionOffset.x !== 0) {
                        objectState.movement.positionOffset.x = 0; hasChanged = true;
                    }

                    if (effectivePositionSpeedY > 0 && effectivePositionStrengthY > 0) {
                        const positionIntervalY = 1000 / effectivePositionSpeedY;
                        if (timestamp - objectState.movement.lastPositionUpdateTime.y > positionIntervalY) {
                            objectState.movement.positionOffset.y = (Math.random() - 0.5) * effectivePositionStrengthY;
                            objectState.movement.lastPositionUpdateTime.y = timestamp;
                            hasChanged = true;
                        }
                    } else if (objectState.movement.positionOffset.y !== 0) {
                        objectState.movement.positionOffset.y = 0; hasChanged = true;
                    }
                }

                if (hasChanged) { requestRedraw(); }
            }
            
            /**
             * Cycles through the paper texture overlay images for each object.
             */
			function updatePaperFoldOverlay(timestamp) {
				const objectState = state.object;
				const hasOverlayImages = originalOverlayImages.filter(img => img && img.complete).length > 0;

				if ((!objectState.paperFoldOverlay.enabled || !hasOverlayImages) && !objectState.stroke.enabled) {
					return;
				}

				const speed = objectState.paperFoldOverlay.speed;
				if (speed <= 0) return;

				const timeSinceLastSwitch = timestamp - objectState.paperFoldOverlay.lastImageSwitchTime;
				const interval = 1000 / speed;
				let hasChanged = false;

				if (timeSinceLastSwitch >= interval) {
					objectState.paperFoldOverlay.currentImageIndex = (objectState.paperFoldOverlay.currentImageIndex + 1) % 4;
					objectState.paperFoldOverlay.lastImageSwitchTime = timestamp;
					hasChanged = true;
				}

				if (hasChanged) {
					requestRedraw();
				}
			}

            /**
             * Memperbarui konten pada layar debug dengan informasi yang lebih relevan.
             */
            function updateDebugScreen(timestamp) {
                if (!state.debugScreenEnabled) return;
                if (timestamp - lastDebugUpdateTime < 1000) return;
                if (!debugScreenEl) return; 
                lastDebugUpdateTime = timestamp;

                let uiModeText;
                const isCurrentlyDesktop = window.matchMedia('(min-width: 769px)').matches;
                if (state.displayMode === 'auto') {
                    uiModeText = isCurrentlyDesktop ? 'auto (desktop)' : 'auto (mobile)';
                } else {
                    uiModeText = state.displayMode;
                }

                const resPreviewText = `${state.previewResolution}p`;
                const bgFileName = state.background.file ? truncateFilename(state.background.file.name, 20) : 'null';
                const objFileName = state.object.image.file ? truncateFilename(state.object.image.file.name, 20) : 'null';

                const debugInfo = `
FPS          : ${fps}
UI Mode      : ${uiModeText}
Res Preview  : ${resPreviewText} ${canvas.width}x${canvas.height}
Background   : ${bgFileName}
Object       : ${objFileName}
                `.trim();

                debugScreenEl.textContent = debugInfo;
            }
            
            function updateInternalCanvasResolution() {
                // Gunakan resolusi aktif dari state, bukan nilai statis
                const PREVIEW_RESOLUTION_KEY = state.previewResolution;
                const aspectRatioKey = state.aspectRatio;
                
                // Temukan dimensi yang sesuai dari map resolusi
                const dims = RESOLUTION_MAPS[PREVIEW_RESOLUTION_KEY]?.[aspectRatioKey];

                if (!dims) {
                    console.error(`Dimensi pratinjau tidak ditemukan untuk ${PREVIEW_RESOLUTION_KEY}! Kembali ke 540p.`);
                    const fallbackDims = RESOLUTION_MAPS['540']?.[aspectRatioKey];
                    canvas.width = fallbackDims ? fallbackDims.w : 960;
                    canvas.height = fallbackDims ? fallbackDims.h : 540;
                } else {
                    canvas.width = dims.w;
                    canvas.height = dims.h;
                }

                const imageSizeSlider = document.getElementById('image-size');
                const maxScalePercent = imageSizeSlider ? parseFloat(imageSizeSlider.max) : 200;
                const offscreenMultiplier = (maxScalePercent / 100.0) + 0.1; 

                const offscreenCanvasWidth = Math.round(canvas.width * offscreenMultiplier);
                const offscreenCanvasHeight = Math.round(canvas.height * offscreenMultiplier);          

                // Atur resolusi semua kanvas offscreen
                objectCanvas.width = contentCanvas.width = finalObjectCanvas.width = offscreenCanvasWidth;
                objectCanvas.height = contentCanvas.height = finalObjectCanvas.height = offscreenCanvasHeight;
                
                requestRedraw();
            }

            function updateCanvasDisplaySize() {
                const containerStyle = window.getComputedStyle(canvasContainer);
                const paddingX = parseFloat(containerStyle.paddingLeft) + parseFloat(containerStyle.paddingRight);
                const paddingY = parseFloat(containerStyle.paddingTop) + parseFloat(containerStyle.paddingBottom);
                let availableWidth = canvasContainer.offsetWidth - paddingX;
                let availableHeight = canvasContainer.offsetHeight - paddingY;

                availableWidth = Math.max(10, availableWidth);
                availableHeight = Math.max(10, availableHeight);

                const canvasRatio = canvas.width / canvas.height;
                let displayW = availableWidth;
                let displayH = displayW / canvasRatio;

                if (displayH > availableHeight) {
                    displayH = availableHeight;
                    displayW = displayH * canvasRatio;
                }

                // JavaScript sekarang mengatur ukuran #canvas-wrapper
                const wrapper = document.getElementById('canvas-wrapper');
                if (wrapper) {
                    wrapper.style.width = `${Math.round(displayW)}px`;
                    wrapper.style.height = `${Math.round(displayH)}px`;
                }
            }

            function resizeAndRedrawAll() {
                updateInternalCanvasResolution();
                updateCanvasDisplaySize();
            }

            /**
             * FINAL: Membuat dan menampilkan titik penanda keyframe yang posisinya
             * disesuaikan agar pas dengan PUSAT thumb slider.
             */
            function renderKeyframeMarkers() {
                const markersContainer = document.getElementById('keyframe-markers-container');
                if (!markersContainer) return;

                markersContainer.innerHTML = '';

                if (state.object.animation.mode !== 'advanced') {
                    return;
                }

                const totalDuration = state.export.duration;
                if (totalDuration <= 0) return;

                const keyframes = state.object.animation.keyframes;

                keyframes.forEach(kf => {
                    const marker = document.createElement('div');
                    marker.className = 'keyframe-marker';
                    
                    // Berikan posisi keyframe (0.0 - 1.0) sebagai CSS Custom Property
                    const keyframePosition = kf.time / totalDuration;
                    if (keyframePosition >= 0 && keyframePosition <= 1) {
                        marker.style.setProperty('--kf-pos', keyframePosition);
                        markersContainer.appendChild(marker);
                    }
                });
            }

            function getIconForKeyframe(currentKeyframe, currentIndex, sortedKeyframes) {
                const iconStyle = 'fill="currentColor"';
                const openIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" ${iconStyle}><path d="M12.8659 3.00017L22.3922 19.5002C22.6684 19.9785 22.5045 20.5901 22.0262 20.8662C21.8742 20.954 21.7017 21.0002 21.5262 21.0002H2.47363C1.92135 21.0002 1.47363 20.5525 1.47363 20.0002C1.47363 19.8246 1.51984 19.6522 1.60761 19.5002L11.1339 3.00017C11.41 2.52187 12.0216 2.358 12.4999 2.63414C12.6519 2.72191 12.7782 2.84815 12.8659 3.00017ZM4.20568 19.0002H19.7941L11.9999 5.50017L4.20568 19.0002Z"></path></svg>`;
                const closeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" ${iconStyle} style="transform: rotate(180deg);"><path d="M12.8659 3.00017L22.3922 19.5002C22.6684 19.9785 22.5045 20.5901 22.0262 20.8662C21.8742 20.954 21.7017 21.0002 21.5262 21.0002H2.47363C1.92135 21.0002 1.47363 20.5525 1.47363 20.0002C1.47363 19.8246 1.51984 19.6522 1.60761 19.5002L11.1339 3.00017C11.41 2.52187 12.0216 2.358 12.4999 2.63414C12.6519 2.72191 12.7782 2.84815 12.8659 3.00017ZM4.20568 19.0002H19.7941L11.9999 5.50017L4.20568 19.0002Z"></path></svg>`;
                const squareIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" ${iconStyle}><path d="M4 3H20C20.5523 3 21 3.44772 21 4V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V4C3 3.44772 3.44772 3 4 3ZM5 5V19H19V5H5Z"></path></svg>`;
                const lineIcon = `<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/></svg>`;

                if (currentKeyframe.paperAnim === 'open') return openIcon;
                if (currentKeyframe.paperAnim === 'close') return closeIcon;

                if (currentKeyframe.paperAnim === 'none') {
                    for (let i = currentIndex - 1; i >= 0; i--) {
                        const prevAnim = sortedKeyframes[i].paperAnim;
                        if (prevAnim === 'open') return squareIcon;
                        if (prevAnim === 'close') return lineIcon;
                    }
                    return squareIcon;
                }

                return squareIcon;
            }

            /**
             * FINAL: Menggambar bar durasi dengan panjang dan posisi yang akurat.
             */
            function renderSimpleAnimationMarkers() {
                const container = document.getElementById('keyframe-markers-container');
                if (!container) return;

                const trackWidth = container.offsetWidth;
                container.querySelectorAll('.simple-anim-marker').forEach(m => m.remove());

                if (state.object.animation.mode !== 'simple') return;

                const totalDuration = state.export.duration;
                if (totalDuration <= 0 || trackWidth <= 0) return;

                const animDuration = 1.0;
                const thumbWidth = 20;
                const borderWidth = 3; // Total lebar border (1.5px * 2)

                // Lebar 1 detik dalam piksel
                const oneSecondInPixels = (animDuration / totalDuration) * trackWidth;
                
                // Lebar total marker = (lebar 1 detik + lebar 1 thumb) - lebar border
                const markerWidthInPixels = oneSecondInPixels + thumbWidth - borderWidth;

                // Jika animasi "open" aktif
                if (state.object.animation.simple.open) {
                    const openMarker = document.createElement('div');
                    openMarker.className = 'simple-anim-marker';
                    openMarker.style.left = '0px';
                    openMarker.style.width = `${markerWidthInPixels}px`;
                    container.appendChild(openMarker);
                }

                // Jika animasi "close" aktif
                if (state.object.animation.simple.close) {
                    const closeMarker = document.createElement('div');
                    closeMarker.className = 'simple-anim-marker';

                    // Hitung posisi akhir, lalu kurangi dengan lebar marker untuk mendapatkan posisi awal
                    const endPosition = trackWidth;
                    const startPosition = endPosition - markerWidthInPixels;
                    
                    closeMarker.style.left = `${startPosition}px`;
                    closeMarker.style.width = `${markerWidthInPixels}px`;
                    container.appendChild(closeMarker);
                }
            }

            /**
			 * FINAL: Menginisialisasi slider rotasi dengan thumb yang "wrapping" dan rentang tetap.
			 */
			function initContinuousSlider(sliderEl, inputEl, labelEl, getValue, stateUpdater) {
				if (!sliderEl || !inputEl || !labelEl) return;

				// Pastikan rentang slider SELALU TETAP -180 hingga 180
				sliderEl.min = -180;
				sliderEl.max = 180;

				let isDragging = false;
				let startX = 0;
				let startValue = 0;
				const sensitivity = 2.0;

				const syncUI = (newValue) => {
					const value = Math.round(newValue);
					stateUpdater(value);
					inputEl.value = value;
					sliderEl.value = (value % 360 + 540) % 360 - 180;
					const loop = Math.floor((value + 180) / 360);
					const baseText = translations[state.language]?.rotation || 'Rotation';
					labelEl.textContent = loop === 0 ? baseText : `${baseText} (${loop > 0 ? '+' : ''}${loop})`;
					requestRedraw();
				};

				const handleDragStart = (clientX) => {
					isDragging = true;
					startX = clientX;
					startValue = getValue();
					document.body.style.cursor = 'ew-resize';
					sliderEl.classList.add('grabbing');
					document.addEventListener('mousemove', handleMouseMove);
					document.addEventListener('mouseup', handleDragEnd);
					document.addEventListener('touchmove', handleTouchMove, { passive: false });
					document.addEventListener('touchend', handleDragEnd);
				};

				const handleDragMove = (clientX) => {
					if (!isDragging) return;
					const deltaX = clientX - startX;
					const newValue = startValue + (deltaX / sensitivity);
					syncUI(newValue);
				};

				const handleDragEnd = () => {
					isDragging = false;
					document.body.style.cursor = 'default';
					sliderEl.classList.remove('grabbing');
					document.removeEventListener('mousemove', handleMouseMove);
					document.removeEventListener('mouseup', handleDragEnd);
					document.removeEventListener('touchmove', handleTouchMove);
					document.removeEventListener('touchend', handleDragEnd);
				};

				const handleMouseDown = (e) => handleDragStart(e.clientX);
				const handleMouseMove = (e) => handleDragMove(e.clientX);
				const handleTouchStart = (e) => { e.preventDefault(); handleDragStart(e.touches[0].clientX); };
				const handleTouchMove = (e) => { e.preventDefault(); handleDragMove(e.touches[0].clientX); };

				const updateFromInput = () => syncUI(parseFloat(inputEl.value) || 0);

				sliderEl.addEventListener('mousedown', handleMouseDown);
				sliderEl.addEventListener('touchstart', handleTouchStart, { passive: false });
				inputEl.addEventListener('change', updateFromInput);
				inputEl.addEventListener('wheel', (e) => {
					e.preventDefault();
					const step = e.deltaY < 0 ? 1 : -1;
					const currentValue = parseFloat(inputEl.value) || 0;
					syncUI(currentValue + step);
				});

				syncUI(getValue());
			}

            function syncSliderAndInput(sliderId, inputId, stateUpdater) {
                const slider = document.getElementById(sliderId);
                const input = document.getElementById(inputId);
                if (!slider || !input) return;

                function updateValue(value, trigger) {
                    const min = parseFloat(slider.min);
                    const max = parseFloat(slider.max);
                    const step = parseFloat(slider.step) || 1;
                    const decimalPlaces = (String(step).split('.')[1] || []).length;
                    let valueToUpdate = parseFloat(value);
                    let clampedValue = Math.max(min, Math.min(max, valueToUpdate || 0));
                    
                    if (trigger !== 'slider') slider.value = clampedValue;
                    if (trigger !== 'input') input.value = clampedValue.toFixed(decimalPlaces);

                    stateUpdater(clampedValue);
                    requestRedraw();
                }

                slider.addEventListener('input', (e) => updateValue(e.target.value, 'slider'));
                input.addEventListener('change', (e) => updateValue(e.target.value, 'input'));
                input.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const step = parseFloat(input.step) || 1;
                    const direction = e.deltaY < 0 ? 1 : -1;
                    const newValue = parseFloat(input.value) + (direction * step);
                    input.value = newValue; 
                    updateValue(newValue, 'input');
                });
            }

            function syncInputOnly(inputId, stateUpdater) {
                const input = document.getElementById(inputId);
                if (!input) return;
                function updateValue(value) {
                    const min = parseFloat(input.min) || -Infinity;
                    const max = parseFloat(input.max) || Infinity;
                    let clampedValue = Math.max(min, Math.min(max, parseFloat(value) || 0));
                    input.value = clampedValue;
                    stateUpdater(clampedValue);
                    requestRedraw();
                }
                input.addEventListener('change', (e) => updateValue(e.target.value));
                input.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const step = parseFloat(input.step) || 1;
                    const direction = e.deltaY < 0 ? 1 : -1;
                    const newValue = parseFloat(input.value) + (direction * step);
                    input.value = newValue; 
                    updateValue(newValue);
                });
            }
            
            function handleImageFile(file, target) {
                if (!file || !file.type.startsWith('image/')) return

                const reader = new FileReader()
                reader.onload = (event) => {
                    const highResImg = new Image()
                    highResImg.onload = () => {
                        if (target === 'background') {
                            state.background.element = highResImg
                            state.background.file = file
                            updateUIFromState()
                            requestRedraw()
                            return
                        }

                        state.object.image.originalElement = highResImg
                        state.object.image.file = file

                        const MAX_PREVIEW_SIZE = 800
                        let previewWidth = highResImg.width
                        let previewHeight = highResImg.height

                        if (previewWidth > MAX_PREVIEW_SIZE || previewHeight > MAX_PREVIEW_SIZE) {
                            const ratio = previewWidth / previewHeight
                            if (ratio > 1) {
                                previewWidth = MAX_PREVIEW_SIZE
                                previewHeight = MAX_PREVIEW_SIZE / ratio
                            } else {
                                previewHeight = MAX_PREVIEW_SIZE
                                previewWidth = MAX_PREVIEW_SIZE * ratio
                            }
                        }

                        const resampleCanvas = document.createElement('canvas')
                        const resampleCtx = resampleCanvas.getContext('2d')
                        resampleCanvas.width = previewWidth
                        resampleCanvas.height = previewHeight
                        resampleCtx.drawImage(highResImg, 0, 0, previewWidth, previewHeight)

                        const previewImg = new Image()
                        previewImg.onload = () => {
                            const paddedCanvas = document.createElement('canvas')
                            const paddedCtx = paddedCanvas.getContext('2d')
                            const paddingX = previewImg.width * 0.25
                            const paddingY = previewImg.height * 0.25
                            paddedCanvas.width = previewImg.width + paddingX * 2
                            paddedCanvas.height = previewImg.height + paddingY * 2
                            paddedCtx.drawImage(previewImg, paddingX, paddingY)

                            const finalPaddedImg = new Image()
                            finalPaddedImg.onload = () => {
                                state.object.image.element = finalPaddedImg
                                isCacheGenerationNeeded = true
                                state.object.animation.isPlaying = true
                                animationStartTime = performance.now()
                                pauseStartTime = 0
                                state.object.paperFoldOverlay.lastImageSwitchTime = animationStartTime
                                updatePlayPauseButton()
                                updateUIFromState()
                                requestRedraw()
                            }
                            finalPaddedImg.src = paddedCanvas.toDataURL()
                        }
                        previewImg.src = resampleCanvas.toDataURL()
                    }
                    highResImg.onerror = () => {
                        console.error(`Gagal memuat gambar ${target}`)
                    }
                    highResImg.src = event.target.result
                }
                reader.readAsDataURL(file)
            }

            /**
             * Updates all text elements in the UI to the selected language.
             */
            function updateUIText(lang) {
                const translationMap = translations[lang] || translations['en'];
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationMap[key]) {
                        if (key === 'dropImagePrompt' || key === 'creatorInfo2' || key === 'exportInfoTooltip' || key === 'dropShadowTooltip') {
                           el.innerHTML = translationMap[key];
                        } else {
                           el.textContent = translationMap[key];
                        }
                    }
                });
                 document.querySelectorAll('[data-translate-key-title]').forEach(el => {
                    const key = el.dataset.translateKeyTitle;
                    if (translationMap[key]) {
                        el.title = translationMap[key];
                    }
                });
            }
            function lerp(a, b, t) {
                return a + (b - a) * t;
            }
            /**
             * Truncates a filename for display purposes.
             */
            function truncateFilename(filename, maxLength = 12) {
                const lastDotIndex = filename.lastIndexOf('.');
                if (lastDotIndex === -1) {
                    return filename.length > maxLength ? filename.substring(0, maxLength) + '...' : filename;
                }
                const name = filename.substring(0, lastDotIndex);
                const ext = filename.substring(lastDotIndex);
                if (name.length > maxLength) {
                    return name.substring(0, maxLength) + '...' + ext;
                }
                return filename;
            }

            let activeKeyframeUI = null; // Variabel global untuk melacak UI keyframe yang aktif

            /**
             * Membuat dan merender seluruh daftar keyframe berdasarkan state, sekarang dengan ikon.
             */
            function renderKeyframeList() {
                const keyframeListContainer = document.getElementById('keyframe-list');
                const keyframes = state.object.animation.keyframes;
                const sortedKeyframes = [...keyframes].sort((a, b) => a.time - b.time);

                keyframeListContainer.innerHTML = '';

                sortedKeyframes.forEach((kf, index) => {
                    const item = document.createElement('div');
                    item.className = 'keyframe-item flex items-center gap-2 p-2 border border-slate-700 bg-slate-800 cursor-pointer transition-colors hover:bg-slate-700/50';
                    item.dataset.keyframeId = kf.id;

                    if (kf.id === state.object.animation.activeKeyframeId) {
                        item.classList.add('border-accent-400', 'bg-slate-700');
                        item.style.borderColor = 'var(--accent-color)';
                    }

                    const iconSVG = getIconForKeyframe(kf, index, sortedKeyframes);

                    item.innerHTML = `
                        <div class="w-6 h-6 flex-shrink-0 text-white flex items-center justify-center">${iconSVG}</div>
                        <span class="font-semibold text-slate-300 flex-shrink-0">Keyframe ${index + 1}</span>
                        <div class="flex items-center gap-2 ml-auto">
                            <input type="number" min="0" step="0.1" value="${kf.time.toFixed(2)}" class="keyframe-time-input number-input-uniform bg-slate-900 border border-[var(--border-color-light)] py-1 px-2 text-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]">
                            <span class="text-sm text-[var(--text-muted)]">s</span>
                            <button class="delete-keyframe-btn p-1.5 text-red-400 hover:text-white hover:bg-red-500/80 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"></path></svg>
                            </button>
                        </div>
                    `;
                    keyframeListContainer.appendChild(item);
                });

                renderKeyframeProperties();
                renderKeyframeMarkers();
            }

            /**
             * Merender panel properti untuk keyframe yang sedang aktif.
             */
            function renderKeyframeProperties() {
                const panel = document.getElementById('keyframe-properties-panel');
                const activeKeyframeId = state.object.animation.activeKeyframeId;
                const keyframes = state.object.animation.keyframes;
                const keyframe = keyframes.find(kf => kf.id === activeKeyframeId);

                if (!keyframe) {
                    panel.innerHTML = '';
                    panel.classList.add('hidden');
                    return;
                }

                const sortedKeyframes = [...keyframes].sort((a, b) => a.time - b.time);
                const currentIndex = sortedKeyframes.findIndex(kf => kf.id === activeKeyframeId);
                const stateBefore = getVisualStateAtTime(keyframe.time, keyframes);
                const isOpenDisabled = !(stateBefore === 'closed' || currentIndex === 0);
                const isCloseDisabled = !(stateBefore === 'open');

                panel.classList.remove('hidden');
                panel.innerHTML = `
                <div class="accordion-section border border-[var(--border-color)] accordion-open">
                    <div class="accordion-header w-full flex items-center justify-between p-4 bg-slate-700/30">
                        <h2 id="keyframe-properties-title" class="text-base font-semibold text-slate-300"></h2>
                        <div class="flex items-center gap-2">
                            <button id="kf-reset-btn" title="Reset Properties" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12C22 17.5228 17.5229 22 12 22C6.4772 22 2 17.5228 2 12C2 6.47715 6.4772 2 12 2V4C7.5817 4 4 7.58172 4 12C4 16.4183 7.5817 20 12 20C16.4183 20 20 16.4183 20 12C20 9.25022 18.6127 6.82447 16.4998 5.38451L16.5 8H14.5V2L20.5 2V4L18.0008 3.99989C20.4293 5.82434 22 8.72873 22 12Z"></path></svg>
                            </button>
                            <button id="kf-copy-btn" title="Copy Properties" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z"></path></svg>
                            </button>
                            <button id="kf-paste-btn" title="Paste Properties" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 transition-colors ${keyframeClipboard === null ? 'is-disabled' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M7 4V2H17V4H20.0066C20.5552 4 21 4.44495 21 4.9934V21.0066C21 21.5552 20.5551 22 20.0066 22H3.9934C3.44476 22 3 21.5551 3 21.0066V4.9934C3 4.44476 3.44495 4 3.9934 4H7ZM7 6H5V20H19V6H17V8H7V6ZM9 4V6H15V4H9Z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="accordion-body space-y-4 p-4 border-t border-[var(--border-color)]">
                        <!-- Scale -->
                        <div>
                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="imageSize"></label>
                            <div class="flex items-center gap-3">
                                <input type="range" id="kf-scale" min="10" max="200" value="${keyframe.scale}" class="w-full slider">
                                <input type="number" id="kf-scale-input" min="10" max="200" value="${keyframe.scale}" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                            </div>
                        </div>
                        <!-- Offset X -->
                        <div>
                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="offsetX"></label>
                            <div class="flex items-center gap-3">
                                <input type="range" id="kf-offset-x" min="-150" max="150" value="${keyframe.x}" class="w-full slider">
                                <input type="number" id="kf-offset-x-input" min="-150" max="150" value="${keyframe.x}" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                            </div>
                        </div>
                        <!-- Offset Y -->
                        <div>
                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="offsetY"></label>
                            <div class="flex items-center gap-3">
                                <input type="range" id="kf-offset-y" min="-150" max="150" value="${keyframe.y}" class="w-full slider">
                                <input type="number" id="kf-offset-y-input" min="-150" max="150" value="${keyframe.y}" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                            </div>
                        </div>
                        <!-- Rotation -->
                        <div>
                            <label id="kf-rotation-label" class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="rotation"></label>
                            <div class="flex items-center gap-3">
                                <input type="range" id="kf-rotation" min="-180" max="180" value="${(keyframe.rotation % 360 + 540) % 360 - 180}" class="w-full slider">
                                <input type="number" id="kf-rotation-input" value="${keyframe.rotation}" class="number-input-uniform bg-slate-900 border border-[var(--border-color)] py-1 px-2 text-sm">
                            </div>
                        </div>
                        <!-- Easing -->
                        <div class="pt-4 border-t border-slate-700">
                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="easingToNext"></label>
                            <div id="kf-easing-btns" class="space-y-2">
                                <div class="grid grid-cols-4 gap-2 btn-group-toggle">
                                    ${['linear', 'easeIn', 'easeOut', 'easeInOut'].map(type => `
                                        <button data-easing="${type}" class="${keyframe.easing === type ? 'active' : ''} p-2.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm" data-translate-key="${type}"></button>
                                    `).join('')}
                                </div>
                                <div class="grid grid-cols-4 gap-2 btn-group-toggle">
                                    ${['instant', 'backIn', 'backOut', 'backInOut'].map(type => `
                                        <button data-easing="${type}" class="${keyframe.easing === type ? 'active' : ''} p-2.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm" data-translate-key="${type}"></button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <!-- Paper Animation -->
                        <div class="pt-4 border-t border-slate-700">
                            <label class="text-sm font-medium text-[var(--text-muted)] mb-2 block" data-translate-key="keyframeAnim"></label>
                            <div id="kf-paper-anim-btns" class="grid grid-cols-3 gap-2 btn-group-toggle">
                                <button data-anim="none" class="${keyframe.paperAnim === 'none' ? 'active' : ''} p-2.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm" data-translate-key="animNone"></button>
                                <button data-anim="open" class="${keyframe.paperAnim === 'open' ? 'active' : ''} p-2.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm" ${isOpenDisabled ? 'disabled' : ''} data-translate-key="animOpen"></button>
                                <button data-anim="close" class="${keyframe.paperAnim === 'close' ? 'active' : ''} p-2.5 border-2 border-[var(--border-color)] text-[var(--text-muted)] text-sm" ${isCloseDisabled ? 'disabled' : ''} data-translate-key="animClose"></button>
                            </div>
                        </div>
                    </div>
                </div>`;

                // Membuat judul dinamis
                const titleTemplate = translations[state.language].keyframePropertiesTitle || 'Keyframe Properties #';
                const dynamicTitle = `${titleTemplate}${currentIndex + 1}`;
                document.getElementById('keyframe-properties-title').textContent = dynamicTitle;                

                updateUIText(state.language);

                document.getElementById('kf-reset-btn').addEventListener('click', () => {
                    const defaultProps = DEFAULT_OBJECT_STATE.animation.keyframes[0];
                    keyframe.x = defaultProps.x;
                    keyframe.y = defaultProps.y;
                    keyframe.scale = defaultProps.scale;
                    keyframe.rotation = defaultProps.rotation;
                    renderKeyframeProperties();
                    requestRedraw();
                });

                document.getElementById('kf-copy-btn').addEventListener('click', () => {
                    keyframeClipboard = {
                        x: keyframe.x,
                        y: keyframe.y,
                        scale: keyframe.scale,
                        rotation: keyframe.rotation,
                    };
                    renderKeyframeProperties();
                });

                document.getElementById('kf-paste-btn').addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('is-disabled')) return;
                    if (keyframeClipboard) {
                        keyframe.x = keyframeClipboard.x;
                        keyframe.y = keyframeClipboard.y;
                        keyframe.scale = keyframeClipboard.scale;
                        keyframe.rotation = keyframeClipboard.rotation;
                        renderKeyframeProperties();
                        requestRedraw();
                    }
                });

                syncSliderAndInput('kf-scale', 'kf-scale-input', val => keyframe.scale = val);
                syncSliderAndInput('kf-offset-x', 'kf-offset-x-input', val => keyframe.x = val);
                syncSliderAndInput('kf-offset-y', 'kf-offset-y-input', val => keyframe.y = val);
                initContinuousSlider(
                    document.getElementById('kf-rotation'),
                    document.getElementById('kf-rotation-input'),
                    document.getElementById('kf-rotation-label'),
                    () => keyframe.rotation,
                    val => { keyframe.rotation = val; }
                );
                document.getElementById('kf-easing-btns').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (btn) {
                        keyframe.easing = btn.dataset.easing;
                        renderKeyframeProperties();
                        requestRedraw();
                    }
                });
                document.getElementById('kf-paper-anim-btns').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (btn && !btn.disabled) {
                        keyframe.paperAnim = btn.dataset.anim;
                        renderKeyframeProperties();
                        renderKeyframeList();
                        requestRedraw();
                    }
                });
            }


			function updateUIFromState() {
				updateUIText(state.language);

				const activeObjectState = state.object;
				const animMode = activeObjectState.animation.mode;
				document.getElementById('animation-simple-controls').classList.toggle('hidden', animMode !== 'simple');
				document.getElementById('animation-advanced-controls').classList.toggle('hidden', animMode !== 'advanced');

				document.querySelectorAll('#animation-mode-btns button').forEach(btn => {
					btn.classList.toggle('active', btn.dataset.mode === animMode);
				});

				document.getElementById('simple-anim-open-switch').checked = activeObjectState.animation.simple.open;
				document.getElementById('simple-anim-close-switch').checked = activeObjectState.animation.simple.close;

				const transformAccordion = document.getElementById('foreground-transform-accordion');
				if (transformAccordion) {
					if (animMode === 'advanced') {
						transformAccordion.classList.add('is-disabled');
						if (transformAccordion.classList.contains('accordion-open')) {
							transformAccordion.classList.remove('accordion-open');
							transformAccordion.querySelector('.accordion-body').classList.add('hidden');
						}
					} else {
						transformAccordion.classList.remove('is-disabled');
					}
				}

				const imageSpecificControls = document.getElementById('image-specific-controls');
				const dropZonePrompt = document.getElementById('drop-zone-prompt');
				const dropZoneFilenameContainer = document.getElementById('drop-zone-filename');
				const deleteImageBtn = document.getElementById('delete-image-btn');

				if (activeObjectState.image.element) {
					imageSpecificControls.classList.remove('is-disabled');
					dropZonePrompt.classList.add('hidden');
					dropZoneFilenameContainer.classList.remove('hidden');
					if (dropZoneFilenameContainer.querySelector('p') && activeObjectState.image.file) {
						dropZoneFilenameContainer.querySelector('p').textContent = truncateFilename(activeObjectState.image.file.name);
					}
					deleteImageBtn.classList.remove('hidden');
				} else {
					imageSpecificControls.classList.add('is-disabled');
					dropZonePrompt.classList.remove('hidden');
					dropZoneFilenameContainer.classList.add('hidden');
					deleteImageBtn.classList.add('hidden');
				}

				const backgroundColorControl = document.getElementById('background-color-control');
				const backgroundDropZonePrompt = document.getElementById('background-drop-zone-prompt');
				const backgroundDropZoneFilename = document.getElementById('background-drop-zone-filename');
				const removeBackgroundImageBtn = document.getElementById('remove-background-image');
				const bgDependentAccordions = ['background-transform-accordion', 'background-blur-accordion'];

                const hasBgImage = !!state.background.element;

                backgroundDropZonePrompt.classList.toggle('hidden', hasBgImage);
                backgroundDropZoneFilename.classList.toggle('hidden', !hasBgImage);
                if (hasBgImage && backgroundDropZoneFilename.querySelector('p') && state.background.file) {
                    backgroundDropZoneFilename.querySelector('p').textContent = truncateFilename(state.background.file.name);
                }
                removeBackgroundImageBtn.classList.toggle('hidden', !hasBgImage);

                bgDependentAccordions.forEach(id => {
                    document.getElementById(id).classList.toggle('controls-disabled-for-bg', !hasBgImage);
                });

				const paperFoldOverlayControls = document.getElementById('overlay-controls');
				const anyOverlayImageLoaded = originalOverlayImages.length > 0 && originalOverlayImages.some(img => img !== null);
				if (activeObjectState.paperFoldOverlay.enabled && anyOverlayImageLoaded) {
					paperFoldOverlayControls.classList.remove('controls-disabled-for-overlay');
				} else {
					paperFoldOverlayControls.classList.add('controls-disabled-for-overlay');
				}

				document.getElementById('background-color').value = state.background.color;
				document.querySelectorAll('#aspect-ratio-btns button').forEach(btn => btn.classList.toggle('active', btn.dataset.ratio === state.aspectRatio));
				document.querySelectorAll('#canvas-resolution-btns button').forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.res) === state.canvasDisplayResolution));

				const inputsToUpdate = [
					{ id: 'background-size-input', value: state.background.transform.size },
					{ id: 'background-offset-x-input', value: state.background.transform.offset.x },
					{ id: 'background-offset-y-input', value: state.background.transform.offset.y },
					{ id: 'background-color-hue-input', value: state.background.effects.colorCorrection.hue },
					{ id: 'background-color-saturation-input', value: state.background.effects.colorCorrection.saturation },
					{ id: 'background-color-brightness-input', value: state.background.effects.colorCorrection.brightness },
					{ id: 'background-colorize-switch', checked: state.background.effects.colorCorrection.colorize },
					{ id: 'background-blur-intensity-input', value: state.background.effects.blur.intensity },
					{ id: 'background-vignette-opacity-input', value: state.background.effects.vignette.opacity },
					{ id: 'background-vignette-radius-input', value: state.background.effects.vignette.radius },
					{ id: 'background-vignette-feather-input', value: state.background.effects.vignette.feather },
					{ id: 'background-vignette-color', value: state.background.effects.vignette.color },
					{ id: 'image-size-input', value: activeObjectState.image.size },
					{ id: 'image-offset-x-input', value: activeObjectState.image.offset.x },
					{ id: 'image-offset-y-input', value: activeObjectState.image.offset.y },
					{ id: 'stroke-width-input', value: activeObjectState.stroke.width },
					{ id: 'stroke-roughness-input', value: activeObjectState.stroke.roughness },
					{ id: 'stroke-detail-input', value: activeObjectState.stroke.detail * 1000 },
					{ id: 'shadow-offset-x-input', value: activeObjectState.shadow.offsetX },
					{ id: 'shadow-offset-y-input', value: activeObjectState.shadow.offsetY },
					{ id: 'shadow-blur-input', value: activeObjectState.shadow.blur },
					{ id: 'shadow-opacity-input', value: activeObjectState.shadow.opacity },
					{ id: 'shadow-color', value: activeObjectState.shadow.color },
					{ id: 'color-hue-input', value: activeObjectState.color.hue },
					{ id: 'color-saturation-input', value: activeObjectState.color.saturation },
					{ id: 'color-brightness-input', value: activeObjectState.color.brightness },
					{ id: 'colorize-switch', checked: activeObjectState.color.colorize },
					{ id: 'movement-simpel-speed-input', value: activeObjectState.movement.simpelSpeed },
					{ id: 'movement-simpel-strength-input', value: activeObjectState.movement.simpelStrength },
					{ id: 'movement-rotation-speed-input', value: activeObjectState.movement.rotationSpeed },
					{ id: 'movement-rotation-strength-input', value: activeObjectState.movement.rotationStrength },
					{ id: 'movement-position-speed-x-input', value: activeObjectState.movement.positionSpeed.x },
					{ id: 'movement-position-speed-y-input', value: activeObjectState.movement.positionSpeed.y },
					{ id: 'movement-position-strength-x-input', value: activeObjectState.movement.positionStrength.x },
					{ id: 'movement-position-strength-y-input', value: activeObjectState.movement.positionStrength.y },
					{ id: 'overlay-opacity-input', value: activeObjectState.paperFoldOverlay.opacity },
					{ id: 'overlay-speed-input', value: activeObjectState.paperFoldOverlay.speed },
					{ id: 'export-duration-input', value: state.export.duration },
					{ id: 'export-filename-input', value: state.export.filename }
				];

				inputsToUpdate.forEach(item => {
					const el = document.getElementById(item.id);
					const sliderEl = document.getElementById(item.id.replace('-input', ''));
					if (el) {
						if (el.type === 'checkbox') {
							el.checked = item.checked;
						} else if (item.value !== undefined) {
							el.value = item.value;
						}
					}
					if (sliderEl && sliderEl.type === 'range' && item.value !== undefined) {
						sliderEl.value = item.value;
					}
				});

				document.querySelectorAll('#export-fps-btns button').forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.fps) === state.export.fps));

				document.querySelectorAll('.accordion-section').forEach(section => {
					const switchInput = section.querySelector('.accordion-header .switch input');
					if (!switchInput) return;
					let isEnabled;
					const sectionId = section.id;
					if (sectionId.includes('foreground-stroke')) isEnabled = activeObjectState.stroke.enabled;
					else if (sectionId.includes('foreground-shadow')) isEnabled = activeObjectState.shadow.enabled;
					else if (sectionId.includes('foreground-color')) isEnabled = activeObjectState.color.enabled;
					else if (sectionId.includes('movement')) isEnabled = activeObjectState.movement.enabled;
					else if (sectionId.includes('background-color-correction')) isEnabled = state.background.effects.colorCorrection.enabled;
					else if (sectionId.includes('background-blur')) isEnabled = state.background.effects.blur.enabled;
					else if (sectionId.includes('background-vignette')) isEnabled = state.background.effects.vignette.enabled;
					else if (sectionId.includes('paper-fold-overlay')) isEnabled = activeObjectState.paperFoldOverlay.enabled;
					if (typeof isEnabled !== 'undefined') switchInput.checked = isEnabled;
				});

				const isSimpelMode = activeObjectState.movement.mode === 'simpel';
				document.getElementById('movement-controls-simpel').classList.toggle('hidden', !isSimpelMode);
				document.getElementById('movement-controls-lengkap').classList.toggle('hidden', isSimpelMode);
				document.querySelectorAll('#movement-mode-btns button').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === activeObjectState.movement.mode));

				document.getElementById('color-correction-standard-controls').classList.remove('hidden');
				document.getElementById('background-color-correction-standard-controls').classList.remove('hidden');

				syncBackgroundTransformModeUI();
				syncDisplayModeUI();
				syncUISizeUI();

				document.querySelectorAll('#language-btns button').forEach(button => {
					button.classList.toggle('active', button.dataset.lang === state.language);
				});

				document.querySelectorAll('.accordion-section').forEach(section => {
					const body = section.querySelector('.accordion-body');
					const isEnabledBySwitch = section.querySelector('.switch input')?.checked ?? true;
					let shouldBeOpenByDefault = false;
					if (section.id === 'background-transform-accordion' && !state.background.element) {
					} else if (section.id === 'background-transform-accordion' || (section.id === 'foreground-transform-accordion' && activeObjectState.image.element)) {
						shouldBeOpenByDefault = true;
					}
					const isOpen = isEnabledBySwitch || section.classList.contains('accordion-open');
					section.classList.toggle('accordion-open', isOpen);
					if (body) {
						body.classList.toggle('hidden', !isOpen);
					}
				});

				document.querySelectorAll('#preview-resolution-btns button').forEach(button => {
					button.classList.toggle('active', button.dataset.res === state.previewResolution);
				});

				document.getElementById('debug-screen-switch').checked = state.debugScreenEnabled;
				document.getElementById('debug-screen').classList.toggle('hidden', !state.debugScreenEnabled);
				showTab(state.activeTab);
				requestRedraw();
				renderKeyframeList();
			}

            /**
             * Updates the UI for the background transform controls based on the selected mode ('fill' or 'stretch').
             */
            function syncBackgroundTransformModeUI() {
                const isDisabled = state.background.transform.mode === 'stretch';
                ['background-size-control', 'background-offset-x-control', 'background-offset-y-control'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.toggle('is-disabled', isDisabled);
                });
                document.querySelectorAll('#background-mode-btns button').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === state.background.transform.mode));
            }

            /**
             * Updates the body class and UI to reflect the current display mode ('auto', 'mobile', 'desktop').
             */
            function syncDisplayModeUI() {
                document.querySelectorAll('#display-mode-btns button').forEach(button => {
                    button.classList.toggle('active', button.dataset.mode === state.displayMode);
                });
                const warningElement = document.getElementById('display-mode-warning');
                if (warningElement) {
                    warningElement.classList.toggle('hidden', state.displayMode === 'auto');
                }
                body.classList.remove('force-mobile', 'force-desktop');
                if (state.displayMode === 'mobile') {
                    body.classList.add('force-mobile');
                } else if (state.displayMode === 'desktop') {
                    body.classList.add('force-desktop');
                }
                resizeAndRedrawAll();
            }
            
            /**
             * Updates the body data-attribute and UI buttons for the current UI size.
             */
            function syncUISizeUI() {
                body.dataset.uiSize = state.uiSize;
                document.querySelectorAll('#ui-size-btns button').forEach(button => {
                    button.classList.toggle('active', button.dataset.size === state.uiSize);
                });
            }
            
            /**
             * Applies a new UI size and redraws the interface.
             */
            function applyUISize(size) {
                state.uiSize = size;
                syncUISizeUI();
                resizeAndRedrawAll(); 
            }
                
            function resetPreferences() {
                // Tentukan nilai default berdasarkan browser/perangkat
                const isCurrentlyMobile = !window.matchMedia('(min-width: 769px)').matches;
                const defaultLang = navigator.language.startsWith('id') ? 'id' : 'en';

                // Reset hanya properti state yang relevan
                state.language = defaultLang;
                state.displayMode = 'auto';
                state.uiSize = isCurrentlyMobile ? 'compact' : 'normal';
                
                // Panggil fungsi-fungsi update secara eksplisit untuk memastikan UI berubah.
                // Ini adalah kunci perbaikannya.
                syncDisplayModeUI(); // Fungsi ini juga memanggil resizeAndRedrawAll
                syncUISizeUI();
                updateUIText(state.language);
                updateUIFromState(); // Panggil ini di akhir untuk sinkronisasi final
            }

            /**
             * DIUBAH: Fungsi ini sekarang hanya mereset pengaturan utama (Latar, Objek, Animasi).
             * Logika ini memastikan tampilan drop-zone juga ikut ter-reset.
             */
            function resetMainSettings(deleteImages = false) {
                // Simpan preferensi saat ini agar tidak ikut ter-reset
                const currentPreferences = {
                    language: state.language,
                    displayMode: state.displayMode,
                    uiSize: state.uiSize
                };

                // Simpan gambar yang ada saat ini JIKA kita tidak ingin menghapusnya
                const currentBgImg = state.background.element;
                const currentBgFile = state.background.file;
                const currentObjectImg = state.object.image.element;
                const currentObjectFile = state.object.image.file;

                // Reset seluruh state ke nilai default dari konstanta
                state = JSON.parse(JSON.stringify(DEFAULT_STATE));

                // Kembalikan preferensi yang tadi disimpan
                state.language = currentPreferences.language;
                state.displayMode = currentPreferences.displayMode;
                state.uiSize = currentPreferences.uiSize;

                // Kembalikan gambar jika checkbox "delete images" TIDAK dicentang
                if (!deleteImages) {
                    state.background.element = currentBgImg;
                    state.background.file = currentBgFile;
                    state.object.image.element = currentObjectImg;
                    state.object.image.file = currentObjectFile;
                }
                updateUIFromState();
                resizeAndRedrawAll();
            }
            
            function resetSectionSettings(sectionKey) {
                const defaultObjectState = DEFAULT_OBJECT_STATE;

                if (sectionKey === 'image' || ['stroke', 'shadow', 'color', 'movement', 'paperFoldOverlay'].includes(sectionKey)) {
                    if (sectionKey === 'image') {
                        state.object.image.size = defaultObjectState.image.size;
                        state.object.image.offset = JSON.parse(JSON.stringify(defaultObjectState.image.offset));
                        state.object.image.rotation = defaultObjectState.image.rotation;

                        const rotSlider = document.getElementById('image-rotation');
                        const rotInput = document.getElementById('image-rotation-input');
                        const rotLabel = document.getElementById('image-rotation-label');
                        
                        if (rotSlider) rotSlider.value = 0;
                        if (rotInput) rotInput.value = 0;
                        if (rotLabel) rotLabel.textContent = translations[state.language]?.rotation || 'Rotation';                        
                    } else {
                        state.object[sectionKey] = JSON.parse(JSON.stringify(defaultObjectState[sectionKey]));
                            if (sectionKey === 'stroke') {
                                isCacheGenerationNeeded = true; // Paksa regenerasi cache efek sobekan
                            }
                    }
                } else {
                    const keys = sectionKey.split('.');
                    let defaultSection = DEFAULT_STATE;
                    let currentSection = state;
                    for (let i = 0; i < keys.length - 1; i++) {
                        defaultSection = defaultSection[keys[i]];
                        currentSection = currentSection[keys[i]];
                    }
                    const finalKey = keys[keys.length - 1];
                    currentSection[finalKey] = JSON.parse(JSON.stringify(defaultSection[finalKey]));
                }

                updateUIFromState();
                requestRedraw();
            }

            function showTopNotification(messageKey, duration = 3000) {
                clearTimeout(notificationTimeout);
                topNotificationMessage.textContent = translations[state.language][messageKey] || messageKey;
                topNotificationPopup.classList.remove('hidden');
                setTimeout(() => topNotificationPopup.classList.add('show'), 10);
                notificationTimeout = setTimeout(() => {
                    topNotificationPopup.classList.remove('show');
                    setTimeout(() => topNotificationPopup.classList.add('hidden'), 300);
                }, duration);
            }

            /**
             * Shows a modal confirmation dialog.
             */
            function showConfirmationPopup(titleKey, messageKey, options = {}) {
                return new Promise(resolve => {
                    confirmationTitle.textContent = translations[state.language][titleKey] || titleKey;
                    confirmationMessage.textContent = translations[state.language][messageKey] || messageKey;

                    if (options.showDeleteImagesCheckbox) {
                        resetImagesOption.style.display = 'flex';
                        deleteImagesCheckbox.checked = false; 
                    } else {
                        resetImagesOption.style.display = 'none';
                    }

                    confirmationPopup.classList.remove('hidden');
                    
                    const handleConfirm = () => closeAndResolve(true);
                    const handleCancel = () => closeAndResolve(false);
                    
                    function closeAndResolve(isConfirmed) {
                        confirmationPopup.classList.add('hidden');
                        confirmContinueBtn.removeEventListener('click', handleConfirm);
                        confirmCancelBtn.removeEventListener('click', handleCancel);
                        const result = {
                            confirmed: isConfirmed,
                            deleteImages: options.showDeleteImagesCheckbox ? deleteImagesCheckbox.checked : false
                        };
                        resolve(result);
                    }

                    confirmContinueBtn.addEventListener('click', handleConfirm, { once: true });
                    confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
                });
            }

            /**
             * Starts the video export process using CCapture.js.
             */
            async function startExport() {
                isExporting = true;
                const hasAnyImage = state.object.image.element || state.background.element;
                if (!hasAnyImage) {
                    showTopNotification("notificationWarnUpload");
                    isExporting = false;
                    return;
                }

                const exportSettingsPopup = document.getElementById('export-settings-popup');
                const exportProgressPopup = document.getElementById('export-progress-popup');
                const progressBarFill = document.getElementById('progress-bar-fill');
                const cancelExportBtn = document.getElementById('cancel-export-btn');

                exportSettingsPopup.classList.add('hidden');
                exportProgressPopup.classList.remove('hidden');
                exportProgressPopup.classList.add('flex');

                const exportTitle = exportProgressPopup.querySelector('h3'); // Ambil elemen h3
                progressBarFill.style.width = '0%';
                progressBarFill.textContent = '0%'; // Set progress bar hanya dengan angka
                exportTitle.textContent = translations[state.language].preparingExportCanvas || 'Menyiapkan kanvas ekspor...'; // Set pesan di judul
                await new Promise(resolve => setTimeout(resolve, 100));
                cancelAnimationFrame(animationFrameId);

                // --- REVISI FINAL: PENDEKATAN SEDERHANA & BENAR ---

                // 1. Siapkan kanvas untuk resolusi ekspor final.
                const finalExportDims = RESOLUTION_MAPS[state.canvasDisplayResolution.toString()]?.[state.aspectRatio];
                if (!finalExportDims) {
                    console.error("Resolusi ekspor tidak valid.");
                    isExporting = false;
                    return;
                }
                canvas.width = finalExportDims.w;
                canvas.height = finalExportDims.h;

                const previewImageElement = state.object.image.element;
                const originalImageSize = state.object.image.size; // Simpan skala asli

                // 2. Jika ada gambar resolusi tinggi, buat versi BARU yang sudah diberi padding.
                if (state.object.image.originalElement) {
                    console.log("Membuat elemen resolusi tinggi dengan padding untuk ekspor...");
                    
                    const highResImg = state.object.image.originalElement;
                    const paddingX = highResImg.width * 0.25;
                    const paddingY = highResImg.height * 0.25;

                    const paddedCanvas = document.createElement('canvas');
                    const paddedCtx = paddedCanvas.getContext('2d');
                    paddedCanvas.width = highResImg.width + paddingX * 2;
                    paddedCanvas.height = highResImg.height + paddingY * 2;
                    paddedCtx.drawImage(highResImg, paddingX, paddingY);

                    const highResPaddedImg = new Image();
                    highResPaddedImg.src = paddedCanvas.toDataURL();
                    await highResPaddedImg.decode(); // Tunggu hingga gambar siap digunakan.

                    // 3. Gunakan gambar BARU (resolusi tinggi + padding) ini sebagai elemen aktif selama ekspor.
                    state.object.image.element = highResPaddedImg;
                }
                
                // 4. Buat cache berdasarkan elemen yang benar.
                isCacheGenerationNeeded = true;
                await generateTornEdgeCache();

                // BAGIAN BARU 2
                exportTitle.textContent = translations[state.language].exportingVideo || 'Mengekspor Video...';                await new Promise(resolve => setTimeout(resolve, 100)); 
                
                // Sisa fungsi tidak berubah...
                Object.assign(state.object.movement, DEFAULT_OBJECT_STATE.movement);
                Object.assign(state.object.paperFoldOverlay, DEFAULT_OBJECT_STATE.paperFoldOverlay);

                const DURATION_S = state.export.duration;
                const FRAME_RATE = state.export.fps;
                const FILENAME = state.export.filename || 'papera-me';
                const TOTAL_FRAMES = DURATION_S * FRAME_RATE;
                const capturer = new CCapture({ format: 'webm', framerate: FRAME_RATE, quality: 95, name: FILENAME });

                let isExportCancelled = false;
                const handleCancel = () => { isExportCancelled = true; };
                cancelExportBtn.addEventListener('click', handleCancel, { once: true });

                const cleanupAfterExport = () => {
                    console.log("Mengembalikan ke gambar pratinjau...");
                    state.object.image.element = previewImageElement; // Kembalikan elemen pratinjau (resolusi rendah + padding)
                    state.object.image.size = originalImageSize;     // Kembalikan skala asli
                    
                    resizeAndRedrawAll();
                    exportProgressPopup.classList.add('hidden');
                    exportProgressPopup.classList.remove('flex');
                    cancelExportBtn.removeEventListener('click', handleCancel);
                    isExporting = false;
                    isCacheGenerationNeeded = true;
                    needsRedraw = true;
                    animationFrameId = requestAnimationFrame(animationLoop);
                };

                capturer.start();

                async function processFrame(frame) {
                    if (isExportCancelled) {
                        capturer.stop();
                        cleanupAfterExport();
                        return;
                    }

                    if (frame > TOTAL_FRAMES) {
                        progressBarFill.textContent = '100%';
                        exportTitle.textContent = `${translations[state.language].completing}...`;
                        capturer.stop();
                        capturer.save(blob => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${FILENAME}.webm`;
                            a.click();
                            URL.revokeObjectURL(url);
                            a.remove();
                            cleanupAfterExport();
                        });
                        return;
                    }

                    const timestamp = (frame / FRAME_RATE) * 1000;
                    updateMovement(timestamp);
                    updatePaperFoldOverlay(timestamp);
                    await draw(timestamp);
                    capturer.capture(canvas);

                    const percentage = Math.round((frame / TOTAL_FRAMES) * 100);
                    progressBarFill.style.width = `${percentage}%`;
                    progressBarFill.textContent = `${percentage}%`;

                    requestAnimationFrame(() => processFrame(frame + 1));
                }

                processFrame(0);
            }
            /**
             * Shows the content for a specific tab and updates the active state of tab buttons.
             */
            const tabScrollPositions = {};
            const controlsPanel = document.querySelector('.controls-panel');            
            function showTab(tabName) {
                // Simpan posisi scroll tab saat ini sebelum beralih
                const currentActiveTab = state.activeTab;
                if (controlsPanel) {
                    tabScrollPositions[currentActiveTab] = controlsPanel.scrollTop;
                }

                state.object.animation.previewTime = null;
                const lang = state.language;
                const tabTitles = {
                    background: translations[lang].tabTitleBackground,
                    object: translations[lang].tabTitleObject,
                    animasi: translations[lang].tabTitleAnimasi,
                    info: translations[lang].tabTitleInfo
                };
                
                const titleText = tabTitles[tabName] || translations[lang].settings;
                document.getElementById('panel-title').textContent = titleText;
                document.getElementById('mobile-panel-header').textContent = titleText.toUpperCase();

                // DIUBAH: Logika untuk menampilkan/menyembunyikan tombol reset
                const resetButton = document.getElementById('reset-settings-btn');
                const resetPrefsButton = document.getElementById('reset-preferences-btn');

                if (tabName === 'info') {
                    resetButton.classList.add('hidden');
                    resetPrefsButton.classList.remove('hidden');
                } else {
                    resetButton.classList.remove('hidden');
                    resetPrefsButton.classList.add('hidden');
                }

                document.getElementById('panel-title').textContent = titleText;
                document.getElementById('mobile-panel-header').textContent = titleText.toUpperCase();

                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.querySelectorAll('.tab-handle').forEach(handle => handle.classList.remove('active'));
                document.querySelectorAll('.mobile-tab-btn').forEach(handle => handle.classList.remove('active'));
                
                const newTabContent = document.getElementById(`${tabName}-tab-content`);
                if (newTabContent) {
                    newTabContent.classList.remove('hidden');
                }
                
                document.getElementById(`handle-${tabName}`)?.classList.add('active');
                document.querySelector(`.mobile-tab-btn[data-tab="${tabName}"]`)?.classList.add('active');
                state.activeTab = tabName;

                if (controlsPanel) {
                    controlsPanel.scrollTop = tabScrollPositions[tabName] || 0;
                }
            }

            let smoothResizeRafId = null; // Untuk memegang ID dari requestAnimationFrame
            function animateCanvasResize(duration = 310) { // Beri sedikit waktu ekstra
                if (smoothResizeRafId) {
                    cancelAnimationFrame(smoothResizeRafId);
                }

                const startTime = performance.now();

                function loop(currentTime) {
                    const elapsedTime = currentTime - startTime;

                    if (elapsedTime < duration) {
                        updateCanvasDisplaySize();
                        smoothResizeRafId = requestAnimationFrame(loop);
                    } else {
                        updateCanvasDisplaySize(); // Pembaruan terakhir untuk memastikan ukuran pas
                        cancelAnimationFrame(smoothResizeRafId);
                        smoothResizeRafId = null;
                    }
                }

                smoothResizeRafId = requestAnimationFrame(loop);
            }


            /**
             * Toggles the settings panel open or closed, managing browser history for back button support.
             */
            function togglePanel() {
                const isOpen = panelWrapper.classList.contains('panel-open');
                if (isOpen) {
                    if (history.state && history.state.panel === 'open') {
                        history.back(); // This triggers the popstate listener which will remove the body class
                    } else {
                        panelWrapper.classList.remove('panel-open');
                        body.classList.remove('desktop-panel-open'); // Also remove body class here
                    }
                } else {
                    history.pushState({ panel: 'open' }, 'Panel Open');
                    panelWrapper.classList.add('panel-open');
                    body.classList.add('desktop-panel-open'); // Add body class here
                }
                animateCanvasResize();
            }

            function syncDurationInputs(newValue) {
                const newDuration = Math.max(1, parseFloat(newValue) || 1);
                state.export.duration = newDuration;

                // Update kedua input
                const exportInput = document.getElementById('export-duration-input');
                const timelineInput = document.getElementById('timeline-duration-input');
                if (exportInput) exportInput.value = newDuration.toFixed(1);
                if (timelineInput) timelineInput.value = newDuration.toFixed(1);

                // Update slider max value
                const timelineSlider = document.getElementById('timeline-slider');
                if (timelineSlider) {
                    timelineSlider.max = newDuration;
                    // Pastikan value tidak melebihi max baru
                    if (parseFloat(timelineSlider.value) > newDuration) {
                        timelineSlider.value = newDuration;
                    }
                }
                requestRedraw();
                renderKeyframeMarkers();
                renderSimpleAnimationMarkers();
            }

            function updatePlayPauseButton() {
                const isPlaying = state.object.animation.isPlaying;
                document.getElementById('play-icon').classList.toggle('hidden', isPlaying);
                document.getElementById('pause-icon').classList.toggle('hidden', !isPlaying);
            }

            /**
             * Checks if a keyframe's time exceeds the total duration and extends it if necessary.
             */
            function checkAndExtendDuration(keyframeTime) {
                if (keyframeTime > state.export.duration) {
                    // Bulatkan ke atas ke 0.5 detik terdekat untuk kerapian
                    const newDuration = Math.ceil(keyframeTime * 2) / 2;
                    syncDurationInputs(newDuration);
                }
            }           

            /**
             * Menyesuaikan pembagian tinggi kanvas dan panel kontrol secara otomatis
             * pada tampilan mobile, HANYA JIKA kanvas membutuhkan <= 50% ruang.
             */
            function autoAdjustMobileLayout() {
                const isMobile = body.classList.contains('force-mobile') || (!body.classList.contains('force-desktop') && window.matchMedia('(max-width: 768px)').matches);
                if (!isMobile) {
                    return;
                }

                const canvasContainer = document.getElementById('canvas-container');
                const panelWrapper = document.getElementById('settings-panel-wrapper');
                const mobileFooter = document.getElementById('mobile-footer');

                if (!canvasContainer || !panelWrapper || !mobileFooter) return;

                // Perhitungan dimensi
                const containerWidth = canvasContainer.offsetWidth;
                const containerStyle = window.getComputedStyle(canvasContainer);
                const paddingX = parseFloat(containerStyle.paddingLeft) + parseFloat(containerStyle.paddingRight);
                const paddingY = parseFloat(containerStyle.paddingTop) + parseFloat(containerStyle.paddingBottom);
                const canvasContentWidth = containerWidth - paddingX;
                const [aspectW, aspectH] = state.aspectRatio.split('/').map(Number);
                const requiredCanvasContentHeight = canvasContentWidth / (aspectW / aspectH);
                const requiredContainerHeight = requiredCanvasContentHeight + paddingY;
                const totalLayoutHeight = window.innerHeight - mobileFooter.offsetHeight;
                
                const canvasHeightPercentage = (requiredContainerHeight / totalLayoutHeight) * 100;

                // BARU: Cek apakah hasil perhitungan melebihi 50%
                if (canvasHeightPercentage > 50) {
                    // Jika ya, hentikan fungsi dan biarkan layout default 50/50.
                    return; 
                }

                // Kode di bawah ini hanya akan berjalan jika persentase kanvas <= 50%

                // Logika Animasi
                const transitionStyle = 'flex-basis 0.5s ease-in-out';
                canvasContainer.style.transition = transitionStyle;
                panelWrapper.style.transition = transitionStyle;

                // Terapkan persentase baru
                canvasContainer.style.flexBasis = `${canvasHeightPercentage}%`;
                panelWrapper.style.flexBasis = `${100 - canvasHeightPercentage}%`;

                // Hapus style transisi setelah animasi selesai
                setTimeout(() => {
                    canvasContainer.style.transition = '';
                    panelWrapper.style.transition = '';
                    resizeAndRedrawAll();
                }, 500);
            }

            function setInstallButtonToInstalled() {
                const installButton = document.getElementById('pwa-install-button');
                if (installButton) {
                    // Tampilkan tombol jika tersembunyi
                    installButton.style.display = 'flex';

                    // Nonaktifkan tombol dan ubah tampilannya
                    installButton.disabled = true;
                    installButton.classList.add('is-disabled');

                    // Ubah teks di dalam tombol menggunakan terjemahan
                    const buttonTextSpan = installButton.querySelector('span');
                    if (buttonTextSpan) {
                        buttonTextSpan.textContent = translations[state.language].appInstalled || 'Installed';
                    }
                }
            }
            
            // PWA Installation Logic
            let deferredPrompt;
            const installButton = document.getElementById('pwa-install-button');
            if (installButton) {
                // BARU: Cek jika aplikasi sudah berjalan dalam mode standalone (terinstal)
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    setInstallButtonToInstalled();
                }

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    installButton.style.display = 'flex';
                    installButton.disabled = false;
                    installButton.classList.remove('is-disabled');
                });

                installButton.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;

                        // BARU: Cek apakah pengguna menerima instalasi
                        if (outcome === 'accepted') {
                            setInstallButtonToInstalled();
                        }

                        deferredPrompt = null;
                    }
                });

                // BARU: Listener jika status instalasi aplikasi berubah
                window.addEventListener('appinstalled', () => {
                    setInstallButtonToInstalled();
                });
            }


            // --- Kode Pendaftaran Service Worker Diletakkan di Sini ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js', { scope: '/papera.me/' })
                        .then((registration) => {
                            console.log('Service Worker berhasil terdaftar dengan cakupan:', registration.scope);
                        })
                        .catch((error) => {
                            console.error('Pendaftaran Service Worker gagal:', error);
                        });
                });
            }

            /**
             * Initializes the application, sets up event listeners, and starts the animation loop.
             */
            function init() {
                // Set initial language based on browser setting
                if (navigator.language.startsWith('id')) {
                    state.language = 'id';
                }
                
                // Set initial UI size and display mode
                state.displayMode = 'auto';
                state.uiSize = window.innerWidth < 1280 ? 'compact' : 'normal';

                const screenWidth = window.innerWidth;
                if (screenWidth <= 480) {
                    state.previewResolution = '360';
                } else if (screenWidth > 480 && screenWidth < 1440) {
                    state.previewResolution = '540';
                } else {
                    state.previewResolution = '720';
                }
                resizeAndRedrawAll();
                animationFrameId = requestAnimationFrame(animationLoop);
                requestAnimationFrame(fpsLoop);

                const bgTransformAccordion = document.getElementById('background-transform-accordion');
                bgTransformAccordion.classList.add('accordion-open');
                bgTransformAccordion.querySelector('.accordion-body').classList.remove('hidden');
                // Load overlay images from URLs
                let loadedOriginalOverlays = 0;
                const totalOverlays = overlayImageUrls.length;
                overlayImageUrls.forEach((url, index) => {
                    const img = new Image();
                    img.onload = () => {
                        originalOverlayImages[index] = img;
                        loadedOriginalOverlays++;
                        if (loadedOriginalOverlays === totalOverlays) {
                            updateUIFromState();
                            requestRedraw();
                        }
                    };
                    img.onerror = () => { console.error(`Failed to load overlay image from URL: ${url}`); };
                    img.src = url;
                });

                function loadImageAsset(url, targetArray, index) {
                    const img = new Image();
                    img.onload = () => {
                        targetArray[index] = img;
                        // Mungkin bisa ditambahkan logika preloader di sini jika perlu
                    };
                    img.onerror = () => console.error(`Gagal memuat aset: ${url}`);
                    img.src = url;
                }

                MASK_IMAGE_URLS.forEach((url, index) => loadImageAsset(url, maskImages, index));
                LAYER_IMAGE_URLS.forEach((url, index) => loadImageAsset(url, layerImages, index));
                // --- EVENT LISTENERS ---
                window.addEventListener('resize', () => {
                    if (state.displayMode === 'auto') {
                        const newSize = window.innerWidth < 1280 ? 'compact' : 'normal';
                        if (newSize !== state.uiSize) {
                            applyUISize(newSize);
                        }
                    }
                    resizeAndRedrawAll();
                });

                document.getElementById('preview-resolution-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.res) {
                        state.previewResolution = button.dataset.res; // Langsung atur resolusi
                        updateUIFromState();
                        resizeAndRedrawAll();
                    }
                });

                document.getElementById('debug-screen-switch').addEventListener('change', (e) => {
                    state.debugScreenEnabled = e.target.checked;
                    updateUIFromState(); // Update UI untuk menampilkan/menyembunyikan layar
                });
                panelHandle.addEventListener('click', togglePanel);
                document.getElementById('mobile-export-btn').addEventListener('click', () => {
                    document.getElementById('export-settings-popup').classList.remove('hidden');
                    updateUIFromState();
                });
                window.addEventListener('popstate', (event) => {
                    if (!event.state || event.state.panel !== 'open') {
                        panelWrapper.classList.remove('panel-open');
                        body.classList.remove('desktop-panel-open');
                        animateCanvasResize();
                    }
                });
                ['handle-background', 'handle-object', 'handle-animasi', 'handle-info'].forEach(id => {
                    document.getElementById(id).addEventListener('click', (e) => showTab(id.split('-')[1]));
                });
                document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        showTab(btn.dataset.tab);
                    });
                });

                // DIUBAH: Event listener untuk tombol Reset All
                document.getElementById('reset-settings-btn').addEventListener('click', async () => {
                    const { confirmed, deleteImages } = await showConfirmationPopup(
                        "confirmResetTitle", 
                        "confirmResetMessage",
                        { showDeleteImagesCheckbox: true }
                    );
                    if (confirmed) {
                        resetMainSettings(deleteImages); // Panggil fungsi reset yang baru
                    }
                });

                // BARU: Event listener untuk tombol Reset Preferensi
                document.getElementById('reset-preferences-btn').addEventListener('click', async () => {
                    const { confirmed } = await showConfirmationPopup(
                        "confirmResetPrefsTitle", 
                        "confirmResetPrefsMessage"
                        // Tidak perlu checkbox untuk hapus gambar di sini
                    );
                    if (confirmed) {
                        resetPreferences(); // Panggil fungsi reset preferensi
                    }
                });

                document.getElementById('export-video-btn-header').addEventListener('click', () => {
                    document.getElementById('export-settings-popup').classList.remove('hidden');
                    updateUIFromState();
                });
                document.getElementById('cancel-export-settings-btn').addEventListener('click', () => document.getElementById('export-settings-popup').classList.add('hidden'));
                document.getElementById('start-export-with-settings-btn').addEventListener('click', startExport);
                
                document.getElementById('export-fps-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if(button) {
                        state.export.fps = parseInt(button.dataset.fps);
                        updateUIFromState(); 
                    }
                });
                document.getElementById('export-duration-input').addEventListener('change', (e) => {
                    const val = parseInt(e.target.value, 10);
                    const min = parseInt(e.target.min, 10);
                    const max = parseInt(e.target.max, 10);
                    state.export.duration = Math.max(min, Math.min(max, val || 1));
                    e.target.value = state.export.duration;
                });
                document.getElementById('export-filename-input').addEventListener('input', (e) => {
                    state.export.filename = e.target.value.trim();
                });

                // Setup drag and drop zones
                const setupDropZone = (zoneId, inputId, target) => {
                    const dropZone = document.getElementById(zoneId);
                    const input = document.getElementById(inputId);
                    if(!dropZone || !input) return;
                    input.addEventListener('change', (e) => handleImageFile(e.target.files[0], target));
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
                        document.body.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
                    });
                    ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over')));
                    ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over')));
                    dropZone.addEventListener('drop', (e) => {
                        handleImageFile(e.dataTransfer.files[0], target);
                        input.files = e.dataTransfer.files; 
                    });
                };
                setupDropZone('drop-zone', 'image-upload', 'foreground');
                setupDropZone('background-drop-zone', 'background-image-upload', 'background');
				document.getElementById('delete-image-btn').addEventListener('click', (e) => { 
					e.stopPropagation(); 
					state.object.image.element = null; 
					state.object.image.file = null; 
					document.getElementById('image-upload').value = ''; 
					updateUIFromState(); 
					requestRedraw(); // Tambahkan ini agar kanvas langsung update
				});
                document.getElementById('remove-background-image').addEventListener('click', (e) => { e.stopPropagation(); state.background.element = null; state.background.file = null; document.getElementById('background-image-upload').value = ''; updateUIFromState(); });
                
                // Accordion logic
                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        if (e.target.closest('.switch') || e.target.closest('.reset-section-btn')) return;
                        
                        const section = header.parentElement;
                        
                        if (section.classList.contains('controls-disabled-for-bg') && !section.id.includes('color-correction') && !section.id.includes('vignette')) {
                            e.stopPropagation();
                            showTopNotification("notificationWarnBg");
                            return;
                        }

                        if (section.closest('#image-specific-controls')?.classList.contains('is-disabled')) {
                             e.stopPropagation();
                             showTopNotification("notificationWarnObject");
                             return;
                        }

                        section.classList.toggle('accordion-open');
                        const body = section.querySelector('.accordion-body');
                        if (body) body.classList.toggle('hidden', !section.classList.contains('accordion-open'));
                    });
                });
                
                // Mencegah akordeon terbuka saat ikon tooltip diklik
                document.querySelectorAll('.info-tooltip-trigger').forEach(trigger => {
                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });

                // Effect enable/disable switches
                const effectSwitches = [
                    { switchId: 'background-color-correction-enabled-switch', stateKey: 'background.effects.colorCorrection' },
                    { switchId: 'background-blur-enabled-switch', stateKey: 'background.effects.blur' },
                    { switchId: 'background-vignette-enabled-switch', stateKey: 'background.effects.vignette' },
                    { switchId: 'stroke-enabled-switch', stateKey: 'stroke' },
                    { switchId: 'shadow-enabled-switch', stateKey: 'shadow' },
                    { switchId: 'color-enabled-switch', stateKey: 'color' },
                    { switchId: 'movement-enabled-switch', stateKey: 'movement' },
                    { switchId: 'paper-fold-overlay-enabled-switch', stateKey: 'paperFoldOverlay' },
                ];
                
                effectSwitches.forEach(({ switchId, stateKey }) => {
                    const switchEl = document.getElementById(switchId);
                    if (switchEl) {
                        switchEl.addEventListener('change', (e) => {
                            const isObjectProperty = ['stroke', 'shadow', 'color', 'movement', 'paperFoldOverlay'].includes(stateKey);
                            
                            let sectionState;
                            if (isObjectProperty) {
                                sectionState = state.object;
                                sectionState[stateKey].enabled = e.target.checked;
                            } else {
                                const keys = stateKey.split('.');
                                sectionState = state;
                                for (let i = 0; i < keys.length - 1; i++) {
                                    sectionState = sectionState[keys[i]];
                                }
                                sectionState[keys[keys.length - 1]].enabled = e.target.checked;
                            }

                            const section = switchEl.closest('.accordion-section');
                            const body = section.querySelector('.accordion-body');
                            
                            if (e.target.checked) {
                                section.classList.add('accordion-open');
                                if (body) body.classList.remove('hidden');
                            } else {
                                section.classList.remove('accordion-open');
                                if (body) body.classList.add('hidden');
                            }
                            updateUIFromState(); 
                            requestRedraw();
                        });
                    }
                });

                // Reset section buttons
                document.querySelectorAll('.reset-section-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const sectionKey = btn.dataset.sectionKey;
                        resetSectionSettings(sectionKey);
                    });
                });
                
                // --- BIND OBJECT CONTROLS ---
                const getActiveObject = () => state.object;

                syncSliderAndInput('image-size', 'image-size-input', (val) => getActiveObject().image.size = val);
                syncSliderAndInput('image-offset-x', 'image-offset-x-input', (val) => getActiveObject().image.offset.x = val);
                syncSliderAndInput('image-offset-y', 'image-offset-y-input', (val) => getActiveObject().image.offset.y = val);
                initContinuousSlider(
                    document.getElementById('image-rotation'),
                    document.getElementById('image-rotation-input'),
                    document.getElementById('image-rotation-label'),
                    () => getActiveObject().image.rotation,
                    (val) => { getActiveObject().image.rotation = val; }
                );

                const setupTornEdgeSlider = (sliderId, inputId, stateUpdater, isDetail = false) => {
                    const slider = document.getElementById(sliderId)
                    const input = document.getElementById(inputId)
                    if (!slider || !input) return

                    const throttledUpdate = throttle((value) => {
                        if (!isAdjustingTornEdge) return
                        const numericValue = parseFloat(value) || 0
                        stateUpdater(isDetail ? numericValue / 1000 : numericValue)
                        requestRedraw()
                    }, 50)

                    const startAdjusting = () => {
                        if (!state.object.image.element) return
                        isAdjustingTornEdge = true
                        isLiveTornEdgePreview = true
                        originalOverlaySpeed = getActiveObject().paperFoldOverlay.speed
                        getActiveObject().paperFoldOverlay.speed = 0
                    }

                    const stopAdjusting = () => {
                        if (!isAdjustingTornEdge) return
                        isAdjustingTornEdge = false
                        isLiveTornEdgePreview = false
                        getActiveObject().paperFoldOverlay.speed = originalOverlaySpeed
                        isCacheGenerationNeeded = true
                        requestRedraw()
                    }

                    slider.addEventListener('pointerdown', startAdjusting)
                    slider.addEventListener('pointerup', stopAdjusting)
                    slider.addEventListener('pointerleave', stopAdjusting)
                    slider.addEventListener('touchstart', startAdjusting, { passive: true });
                    slider.addEventListener('touchend', stopAdjusting);
                    slider.addEventListener('touchcancel', stopAdjusting);

                    slider.addEventListener('input', (e) => {
                        input.value = e.target.value
                        throttledUpdate(e.target.value)
                    })

                    input.addEventListener('change', (e) => {
                        const finalValue = parseFloat(e.target.value) || 0
                        slider.value = finalValue
                        stateUpdater(isDetail ? finalValue / 1000 : finalValue)
                        isCacheGenerationNeeded = true
                        requestRedraw()
                    })
                }

				setupTornEdgeSlider('stroke-width', 'stroke-width-input', (val) => getActiveObject().stroke.width = val);
				setupTornEdgeSlider('stroke-roughness', 'stroke-roughness-input', (val) => getActiveObject().stroke.roughness = val);
				setupTornEdgeSlider('stroke-detail', 'stroke-detail-input', (val) => getActiveObject().stroke.detail = val, true);

                syncSliderAndInput('shadow-blur', 'shadow-blur-input', (val) => getActiveObject().shadow.blur = val);
                syncSliderAndInput('shadow-opacity', 'shadow-opacity-input', (val) => getActiveObject().shadow.opacity = val);
                syncInputOnly('shadow-offset-x-input', (val) => getActiveObject().shadow.offsetX = val);
                syncInputOnly('shadow-offset-y-input', (val) => getActiveObject().shadow.offsetY = val);
                document.getElementById('shadow-color').addEventListener('input', (e) => { getActiveObject().shadow.color = e.target.value; requestRedraw(); });
                syncSliderAndInput('color-hue', 'color-hue-input', (val) => getActiveObject().color.hue = val);
                syncSliderAndInput('color-saturation', 'color-saturation-input', (val) => getActiveObject().color.saturation = val);
                syncSliderAndInput('color-brightness', 'color-brightness-input', (val) => getActiveObject().color.brightness = val);
                document.getElementById('colorize-switch').addEventListener('change', (e) => { getActiveObject().color.colorize = e.target.checked; updateUIFromState(); });
                
                document.getElementById('movement-mode-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) { getActiveObject().movement.mode = button.dataset.mode; updateUIFromState(); }
                });
                syncSliderAndInput('movement-simpel-speed', 'movement-simpel-speed-input', (val) => getActiveObject().movement.simpelSpeed = val);
                syncSliderAndInput('movement-simpel-strength', 'movement-simpel-strength-input', (val) => getActiveObject().movement.simpelStrength = val);
                syncSliderAndInput('movement-rotation-speed', 'movement-rotation-speed-input', (val) => getActiveObject().movement.rotationSpeed = val);
                syncSliderAndInput('movement-rotation-strength', 'movement-rotation-strength-input', (val) => getActiveObject().movement.rotationStrength = val);
                syncSliderAndInput('movement-position-speed-x', 'movement-position-speed-x-input', (val) => getActiveObject().movement.positionSpeed.x = val);
                syncSliderAndInput('movement-position-speed-y', 'movement-position-speed-y-input', (val) => getActiveObject().movement.positionSpeed.y = val);
                syncSliderAndInput('movement-position-strength-x', 'movement-position-strength-x-input', (val) => getActiveObject().movement.positionStrength.x = val);
                syncSliderAndInput('movement-position-strength-y', 'movement-position-strength-y-input', (val) => getActiveObject().movement.positionStrength.y = val);

                syncSliderAndInput('overlay-opacity', 'overlay-opacity-input', (val) => { getActiveObject().paperFoldOverlay.opacity = val; });
                syncSliderAndInput('overlay-speed', 'overlay-speed-input', (val) => getActiveObject().paperFoldOverlay.speed = val); 
                
                // --- BIND GLOBAL CONTROLS ---
                document.getElementById('aspect-ratio-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) { state.aspectRatio = button.dataset.ratio; resizeAndRedrawAll(); updateUIFromState(); }
                });
                document.getElementById('canvas-resolution-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        state.canvasDisplayResolution = parseInt(button.dataset.res);
                        updateUIFromState();
                    }
                });
                document.getElementById('background-color').addEventListener('input', (e) => { state.background.color = e.target.value; requestRedraw(); });
                document.getElementById('background-mode-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) { state.background.transform.mode = button.dataset.mode; syncBackgroundTransformModeUI(); requestRedraw(); }
                });
                syncSliderAndInput('background-size', 'background-size-input', (val) => state.background.transform.size = val);
                syncSliderAndInput('background-offset-x', 'background-offset-x-input', (val) => state.background.transform.offset.x = val);
                syncSliderAndInput('background-offset-y', 'background-offset-y-input', (val) => state.background.transform.offset.y = val);
                initContinuousSlider(
                    document.getElementById('background-rotation'),
                    document.getElementById('background-rotation-input'),
                    document.getElementById('background-rotation-label'),
                    () => state.background.transform.rotation,
                    (val) => { state.background.transform.rotation = val; }
                );

                syncSliderAndInput('background-color-hue', 'background-color-hue-input', (val) => state.background.effects.colorCorrection.hue = val);
                syncSliderAndInput('background-color-saturation', 'background-color-saturation-input', (val) => state.background.effects.colorCorrection.saturation = val);
                syncSliderAndInput('background-color-brightness', 'background-color-brightness-input', (val) => state.background.effects.colorCorrection.brightness = val);
                document.getElementById('background-colorize-switch').addEventListener('change', (e) => { state.background.effects.colorCorrection.colorize = e.target.checked; updateUIFromState(); });
                syncSliderAndInput('background-blur-intensity', 'background-blur-intensity-input', (val) => state.background.effects.blur.intensity = val);
                syncSliderAndInput('background-vignette-opacity', 'background-vignette-opacity-input', (val) => state.background.effects.vignette.opacity = val);
                syncSliderAndInput('background-vignette-radius', 'background-vignette-radius-input', (val) => state.background.effects.vignette.radius = val);
                syncSliderAndInput('background-vignette-feather', 'background-vignette-feather-input', (val) => state.background.effects.vignette.feather = val);
                document.getElementById('background-vignette-color').addEventListener('input', (e) => { state.background.effects.vignette.color = e.target.value; requestRedraw(); });
                
                document.getElementById('display-mode-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        state.displayMode = button.dataset.mode;
                        if(state.displayMode === 'mobile') { applyUISize('compact'); } 
                        else if(state.displayMode === 'desktop') { applyUISize('normal'); }
                        syncDisplayModeUI();
                    }
                });

                document.getElementById('ui-size-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.size) { applyUISize(button.dataset.size); }
                });

                document.getElementById('language-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.lang) {
                        state.language = button.dataset.lang;
                        updateUIFromState();
                    }
                });

                topNotificationCloseBtn.addEventListener('click', () => {
                    topNotificationPopup.classList.remove('show');
                    clearTimeout(notificationTimeout);
                    setTimeout(() => topNotificationPopup.classList.add('hidden'), 300);
                });
                

                // Mobile panel resizer logic
				let dragOffset = 0; // Untuk menyimpan jarak klik dari tepi atas header

				const resizerMove = (e) => {
					e.preventDefault();
					const clientY = e.touches ? e.touches[0].clientY : e.clientY;
					const totalHeight = window.innerHeight;
					const footerHeight = document.getElementById('mobile-footer').offsetHeight;
					const minHeight = totalHeight * 0.20;

					// Hitung tinggi kanvas dengan mengurangi offset awal
					let canvasHeight = clientY - dragOffset;

					// Batasi ukuran minimum dan maksimum
					canvasHeight = Math.max(minHeight, canvasHeight);
					canvasHeight = Math.min(totalHeight - minHeight - footerHeight, canvasHeight);

					const panelHeight = totalHeight - canvasHeight;

					canvasContainer.style.flexBasis = `${canvasHeight}px`;
					panelWrapper.style.flexBasis = `${panelHeight}px`;

					requestAnimationFrame(updateCanvasDisplaySize);
				};

				const resizerStop = () => {
					document.removeEventListener('mousemove', resizerMove);
					document.removeEventListener('touchmove', resizerMove);
					document.removeEventListener('mouseup', resizerStop);
					document.removeEventListener('touchend', resizerStop);
					body.style.userSelect = '';
					resizeAndRedrawAll();
				};

				const resizerStart = (e) => {
					const clientY = e.touches ? e.touches[0].clientY : e.clientY;

					// Hitung dan simpan jarak antara jari/mouse dengan tepi atas header
					dragOffset = clientY - mobilePanelHeader.getBoundingClientRect().top;

					body.style.userSelect = 'none';
					document.addEventListener('mousemove', resizerMove);
					document.addEventListener('mouseup', resizerStop);
					document.addEventListener('touchmove', resizerMove, { passive: false });
					document.addEventListener('touchend', resizerStop);
				};

				mobilePanelHeader.addEventListener('mousedown', resizerStart);
				mobilePanelHeader.addEventListener('touchstart', resizerStart, { passive: false });

                document.getElementById('animation-mode-btns').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        state.object.animation.mode = button.dataset.mode;
                        // Reset pratinjau saat berganti mode
                        state.object.animation.previewTime = null;
                        updateUIFromState(); // Panggil ini untuk update seluruh UI
                        renderKeyframeMarkers();
                        renderSimpleAnimationMarkers();
                    }
                });

                // Event listener untuk switch di mode simpel
                document.getElementById('simple-anim-open-switch').addEventListener('change', (e) => {
                    state.object.animation.simple.open = e.target.checked;
                    renderSimpleAnimationMarkers();
                    // Di masa depan, logika animasi simpel akan dipanggil di sini
                });

                document.getElementById('simple-anim-close-switch').addEventListener('change', (e) => {
                    state.object.animation.simple.close = e.target.checked;
                    renderSimpleAnimationMarkers();
                    // Di masa depan, logika animasi simpel akan dipanggil di sini
                });
                             
                document.getElementById('add-keyframe-btn').addEventListener('click', () => {
                    const keyframes = state.object.animation.keyframes;
                    const sortedKeyframes = [...keyframes].sort((a, b) => a.time - b.time);
                    const lastKeyframe = sortedKeyframes.length > 0 ? sortedKeyframes[sortedKeyframes.length - 1] : DEFAULT_OBJECT_STATE.animation.keyframes[0];

                    const newKeyframe = {
                        ...JSON.parse(JSON.stringify(lastKeyframe)),
                        id: Date.now(),
                        time: Math.round((lastKeyframe.time + 1) * 10) / 10,
                        easing: 'linear',
                        paperAnim: 'none'
                    };

                    if (typeof newKeyframe.rotation !== 'number') {
                        newKeyframe.rotation = 0;
                    }

                    keyframes.push(newKeyframe);
                    state.object.animation.activeKeyframeId = newKeyframe.id;
                    checkAndExtendDuration(newKeyframe.time);
                    renderKeyframeList();
                    requestRedraw();
                });

                document.getElementById('keyframe-list').addEventListener('click', (e) => {
					if (e.target.classList.contains('keyframe-time-input')) return;

					const item = e.target.closest('.keyframe-item');
					if (!item) return;

                    const id = Number(item.dataset.keyframeId);

                    // Logika untuk tombol hapus
                    if (e.target.closest('.delete-keyframe-btn')) {
                        state.object.animation.keyframes = state.object.animation.keyframes.filter(kf => kf.id !== id);
                        if (state.object.animation.activeKeyframeId === id) {
                            state.object.animation.activeKeyframeId = null;
                        }
                        // Setelah menghapus, perbarui daftar dan kanvas
                        renderKeyframeList();
                        requestRedraw();
                        return;
                    }

                    // Logika untuk memilih sebuah keyframe
                    state.object.animation.activeKeyframeId = id;
                    const kf = state.object.animation.keyframes.find(k => k.id === id);

                    if (kf) {
                        state.object.animation.isPlaying = false;
                        state.object.animation.previewTime = kf.time;
                        pauseStartTime = kf.time * 1000;

                        const timelineSlider = document.getElementById('timeline-slider');
                        const timelineCurrentTime = document.getElementById('timeline-current-time');
                        if (timelineSlider) timelineSlider.value = kf.time;
                        if (timelineCurrentTime) timelineCurrentTime.textContent = `${kf.time.toFixed(2)}s`;

                        updatePlayPauseButton();

                        needsRedraw = true;
                    }
                    renderKeyframeList();
                });

                // Event listener untuk input waktu
                document.getElementById('keyframe-list').addEventListener('change', e => {
                    if (e.target.classList.contains('keyframe-time-input')) {
                        const item = e.target.closest('.keyframe-item');
                        const id = Number(item.dataset.keyframeId);
                        const kf = state.object.animation.keyframes.find(k => k.id === id);
                        if (kf) {
                            const newTime = Math.max(0, parseFloat(e.target.value) || 0);
                            kf.time = newTime;
                            
                            checkAndExtendDuration(newTime);

                            renderKeyframeList();
                            requestRedraw();
                        }
                    }
                });
   
                document.getElementById('play-pause-btn').addEventListener('click', () => {
                    const animState = state.object.animation;
                    if (!state.object.image.element && !animState.isPlaying) {
                        showTopNotification("notificationWarnObject");
                        return;
                    }                    
                    animState.isPlaying = !animState.isPlaying;

                    if (animState.isPlaying) {
                        animState.previewTime = null;
                        animationStartTime = performance.now() - pauseStartTime;
                        state.object.paperFoldOverlay.lastImageSwitchTime = performance.now();
                        
                    } else {
                        pauseStartTime = performance.now() - animationStartTime;
                        animState.previewTime = (pauseStartTime / 1000) % state.export.duration;
                        needsRedraw = true;
                        
                    }
                    
                    updatePlayPauseButton();
                });

                // --- Timeline/Playhead Scrubbing Logic (Standard Drag) ---
                const timelineSlider = document.getElementById('timeline-slider');
                if (timelineSlider) {
                    const timelineCurrentTime = document.getElementById('timeline-current-time');

                    const startScrub = () => {
                        isScrubbing = true;
                        state.object.animation.isPlaying = false;
                        updatePlayPauseButton();
                    };

                    const stopScrub = () => {
                        if (isScrubbing) {
                            isScrubbing = false;
                            const lastScrubTime = state.object.animation.previewTime;
                            if (lastScrubTime !== null) {
                                animationStartTime = performance.now() - (lastScrubTime * 1000);
                                pauseStartTime = lastScrubTime * 1000;
                            }
                        }
                    };

                    const doScrub = (e) => {
                        if (!isScrubbing) return;
                        const newTime = parseFloat(e.target.value);
                        state.object.animation.previewTime = newTime;
                        if (timelineCurrentTime) {
                            timelineCurrentTime.textContent = `${newTime.toFixed(2)}s`;
                        }
                        requestRedraw();
                    };

                    timelineSlider.addEventListener('mousedown', startScrub);
                    timelineSlider.addEventListener('touchstart', startScrub, { passive: true });
                    timelineSlider.addEventListener('input', throttle(doScrub, 50));
                    document.addEventListener('mouseup', stopScrub);
                    document.addEventListener('touchend', stopScrub);
                }

                let hideTooltipTimeout;

                document.querySelectorAll('.info-tooltip-trigger').forEach(trigger => {
                    const tooltip = trigger.querySelector('.info-tooltip');
                    if (!tooltip) return;

                    const showTooltip = () => {
                        clearTimeout(hideTooltipTimeout);
                        tooltip.classList.add('tooltip-visible');
                    };

                    const startHideTimer = () => {
                        hideTooltipTimeout = setTimeout(() => {
                            tooltip.classList.remove('tooltip-visible');
                        }, 500);
                    };

                    trigger.addEventListener('mouseenter', showTooltip);
                    trigger.addEventListener('mouseleave', startHideTimer);
                    tooltip.addEventListener('mouseenter', showTooltip);
                    tooltip.addEventListener('mouseleave', startHideTimer);
                });
                
                // MODIFIKASI & TAMBAHKAN Listener untuk sinkronisasi durasi
                const exportDurationInput = document.getElementById('export-duration-input');
                const timelineDurationInput = document.getElementById('timeline-duration-input');
                
                if (exportDurationInput) {
                    exportDurationInput.addEventListener('change', (e) => syncDurationInputs(e.target.value));
                }
                if (timelineDurationInput) {
                    timelineDurationInput.addEventListener('change', (e) => syncDurationInputs(e.target.value));
                }     
                setTimeout(autoAdjustMobileLayout, 500);
                updateUIFromState();
            }
            init();
            window.addEventListener('load', () => {
                // Hanya jalankan di desktop
                if (!window.matchMedia('(max-width: 768px)').matches) {
                    // Menggunakan variabel yang sudah dideklarasikan di lingkup atas
                    panelWrapper.classList.add('panel-open');
                    body.classList.add('desktop-panel-open');
                    animateCanvasResize();
                }
            });            
        });
    </script>
</body>
</html>
